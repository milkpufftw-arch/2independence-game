<!DOCTYPE html>

<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>自立大冒險 - 自立生活模擬器</title>

  <!-- Tailwind CSS (CDN) -->

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + ReactDOM 18 (CDN) -->

  <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>

  <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (CDN) -->

  <script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --neo-border:#0b0b0b;
      --neo-shadow:#0b0b0b;
      --bg1:#050b18;
      --bg2:#07122b;
      --scan: rgba(0,0,0,.06);
      --crt: rgba(0,255,120,.08);
    }
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 600px at 50% 20%, #0c1a3d 0%, var(--bg1) 45%, #02040a 100%);
      color: #111;
      overflow: hidden;
      font-family: "Noto Sans TC", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }
    /* 嘗試使用本機字體（不使用額外 CDN），若系統沒有會自動 fallback */
    @font-face {
      font-family: "VT323";
      src: local("VT323");
      font-display: swap;
    }
    @font-face {
      font-family: "Noto Sans TC";
      src: local("Noto Sans TC");
      font-display: swap;
    }

    /* 背景掃描線 */
    .scanlines::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.00) 0px,
        rgba(255,255,255,0.00) 3px,
        var(--scan) 4px
      );
      mix-blend-mode: multiply;
      opacity: .55;
      z-index: 0;
    }

    /* 手機殼 */
    .phone-shell{
      width: 420px;
      max-width: 92vw;
      height: 820px;
      max-height: 88vh;
      background: linear-gradient(180deg, #0b0f17 0%, #090d14 100%);
      border-radius: 36px;
      border: 2px solid rgba(255,255,255,0.07);
      box-shadow:
        0 24px 70px rgba(0,0,0,.55),
        inset 0 0 0 2px rgba(0,0,0,.55);
      position: relative;
      overflow: visible;
      z-index: 1;
    }
    .phone-notch{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 170px;
      height: 28px;
      border-radius: 0 0 16px 16px;
      background: #05070b;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.05);
      z-index: 3;
    }
    .side-btn{
      position:absolute;
      width: 6px;
      border-radius: 8px;
      background: rgba(255,255,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.55);
      z-index: 2;
    }
    .side-btn.left1{ left:-3px; top: 160px; height: 70px;}
    .side-btn.left2{ left:-3px; top: 250px; height: 42px;}
    .side-btn.right1{ right:-3px; top: 210px; height: 88px;}

    .screen{
      position:absolute;
      top: 52px;
      left: 16px;
      right: 16px;
      bottom: 16px;
      border-radius: 26px;
      background: #fdfdfd;
      overflow: hidden;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,0.10);
      z-index: 2;
    }

    /* neo border/shadow */
    .neo-shadow{
      box-shadow: 4px 4px 0 var(--neo-shadow);
      border: 2px solid var(--neo-border);
    }
    .neo-card{
      border: 2px solid var(--neo-border);
      box-shadow: 4px 4px 0 var(--neo-shadow);
      border-radius: 18px;
      background: #fff;
    }
    .neo-btn{
      border: 2px solid var(--neo-border);
      box-shadow: 4px 4px 0 var(--neo-shadow);
      border-radius: 16px;
      background: #fff;
      transition: transform .06s ease, box-shadow .06s ease;
      user-select: none;
    }
    .neo-btn:active{
      transform: translate(2px,2px);
      box-shadow: 2px 2px 0 var(--neo-shadow);
    }
    .neo-btn[disabled]{
      opacity: .55;
      filter: grayscale(0.3);
      cursor: not-allowed;
    }

    /* glitch */
    @keyframes glitchFlicker{
      0%{ transform: translate(0,0) skewX(0deg); filter: none; opacity: 1;}
      25%{ transform: translate(-1px,0) skewX(1deg); filter: contrast(1.25); opacity: .92;}
      50%{ transform: translate(1px,0) skewX(-1deg); filter: hue-rotate(12deg) contrast(1.2); opacity: .95;}
      75%{ transform: translate(0,1px) skewX(1deg); filter: contrast(1.15); opacity: .92;}
      100%{ transform: translate(0,0) skewX(0deg); filter: none; opacity: 1;}
    }
    .glitch-effect{
      animation: glitchFlicker .18s linear 0s 3;
    }

    /* Modal animation */
    @keyframes popIn{
      0%{ transform: translateY(14px) scale(.96); opacity: 0;}
      80%{ transform: translateY(-2px) scale(1.01); opacity: 1;}
      100%{ transform: translateY(0) scale(1); opacity: 1;}
    }
    .modal-pop{ animation: popIn .18s ease-out; }

    /* Overlay floating text */
    @keyframes floatUp{
      0%{ transform: translateY(0); opacity: 0;}
      12%{ opacity: 1;}
      100%{ transform: translateY(-26px); opacity: 0;}
    }
    .float-text{
      animation: floatUp .9s ease-out forwards;
      text-shadow: 0 1px 0 rgba(0,0,0,.1);
      font-family: "VT323", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing: .5px;
    }

    /* Logs terminal vibe */
    .terminal{
      background: #07180f;
      border: 2px solid #021408;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,0.25), 4px 4px 0 #0b0b0b;
      border-radius: 18px;
      color: #62ff9a;
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    /* Nice scrollbar (optional) */
    .scroll-area{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .scroll-area::-webkit-scrollbar { width: 10px; }
    .scroll-area::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
    .scroll-area::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.20); border-radius: 10px; border: 2px solid rgba(255,255,255,0.4); }

    /* Small pixel titles */
    .pixel-title{
      font-family: "VT323", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing: 1px;
    }

    /* Error box */
    #error-message{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: min(900px, 92vw);
      z-index: 99;
      display: none;
    }
    #error-message.show{ display: block; }
  </style>

</head>

<body class="scanlines">
  <div id="root"></div>

  <div id="error-message" class="neo-card px-4 py-3 bg-rose-50">
    <div class="flex items-start gap-2">
      <div class="text-rose-700 font-bold">⚠ 捕獲到錯誤（window.onerror）</div>
    </div>
    <pre id="error-pre" class="mt-2 text-xs text-rose-800 whitespace-pre-wrap break-words"></pre>
  </div>

  <script>
    (function(){
      const box = document.getElementById('error-message');
      const pre = document.getElementById('error-pre');

      function showError(text){
        try{
          pre.textContent = String(text || 'Unknown error');
          box.classList.add('show');
        }catch(e){}
      }

      window.onerror = function(message, source, lineno, colno, error){
        const details = [
          String(message || 'Script error.'),
          source ? ('來源: ' + source) : '',
          (typeof lineno === 'number') ? ('行: ' + lineno) : '',
          (typeof colno === 'number') ? ('列: ' + colno) : '',
          error && error.stack ? ('堆疊:\n' + error.stack) : ''
        ].filter(Boolean).join('\n');
        showError(details);
        return false;
      };

      window.addEventListener('unhandledrejection', function(ev){
        const reason = ev && ev.reason ? ev.reason : 'Promise rejection';
        const details = (reason && reason.stack) ? reason.stack : String(reason);
        showError('未處理的 Promise 錯誤:\n' + details);
      });
    })();
  </script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // ===== Helpers =====
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function shuffleArray(arr){
      const a = Array.isArray(arr) ? [...arr] : [];
      for(let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function uid(prefix='id'){
      return prefix + '_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
    }

    function weightedPick(list){
      const total = list.reduce((s, x) => s + (x.weight || 0), 0);
      let r = Math.random() * total;
      for(const x of list){
        r -= (x.weight || 0);
        if(r <= 0) return x;
      }
      return list[list.length - 1];
    }

    // ===== Data (內建) =====
    const INITIAL_STATS = {
      money: 0,
      health: 100,
      mood: 60,
      security: 60,
      week: 1,
      maxWeeks: 8,
      age: 15,
      ap: 3,
      maxAp: 3
    };

    const CHARACTER_ORIGINS = [
      { tier: 'A', money: 8000, prob: 0.10, label: '資源相對充足' },
      { tier: 'B', money: 6000, prob: 0.20, label: '尚可起步' },
      { tier: 'C', money: 4000, prob: 0.30, label: '一般開局' },
      { tier: 'D', money: 2000, prob: 0.30, label: '壓力偏大' },
      { tier: 'E', money: 0,    prob: 0.10, label: '需要外援' }
    ];

    // Generic job interview questions (至少 3 題，這裡給更多)
    const GENERIC_JOB_QUESTIONS = [
      {
        q: '面試時遇到不確定的規定，你最好的做法是？',
        options: ['先答「都可以」避免被問', '請對方再說一次並確認細節', '直接說「我不需要知道」', '馬上離開'],
        answer: 1
      },
      {
        q: '工作中需要使用個資（電話/地址）時，正確作法是？',
        options: ['把資料拍照傳群組比較快', '只在必要範圍使用並妥善保管', '把資料留在桌上方便同事', '全部記在私人記事本'],
        answer: 1
      },
      {
        q: '如果同事要你代刷卡/代付款，你最先應該？',
        options: ['立刻刷，避免尷尬', '先確認金額與用途並保留證明', '用自己的帳戶借錢給他', '說「不用還」'],
        answer: 1
      },
      {
        q: '遇到「先繳費才能上工」的工作，你應該？',
        options: ['趕快付錢搶名額', '提高警覺並查證', '把提款卡交出去', '請對方改用點數收款'],
        answer: 1
      },
      {
        q: '面試時最能呈現可靠度的是？',
        options: ['遲到但說路上塞車', '準時到並準備好資料', '一直滑手機', '把前雇主罵一遍'],
        answer: 1
      },
      {
        q: '遇到不舒服或生病，最合宜的做法是？',
        options: ['硬撐到昏倒', '儘早告知並協調休息/就醫', '不說，直接缺席', '把壓力怪給同事'],
        answer: 1
      }
    ];

    const JOBS = [
      {
        id:'job_flyer',
        title:'派報/傳單',
        wage: 190,
        energy: 10,
        mood: -2,
        minAge: 15,
        strictAge: false,
        apCost: 1,
        desc:'走路多、日曬雨淋，適合短期賺零用。',
        interviews: [
          { q:'如果遇到居民拒收傳單，你會？', options:['硬塞進信箱','禮貌致歉並離開','跟對方吵架','把傳單丟地上'], answer:1 },
          { q:'派報時手機沒電，你會？', options:['消失不回訊息','先通知主管並找充電/借電','直接下班','把別人的手機拿走'], answer:1 },
          { q:'路上遇到有人要你先付押金才能領傳單，你會？', options:['立刻付','查證公司與流程','用點數付','把提款卡給他'], answer:1 }
        ]
      },
      {
        id:'job_store',
        title:'超商店員',
        wage: 185,
        energy: 12,
        mood: -1,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc:'需要站立與服務禮儀，學到基本職場規範。',
        interviews: [
          { q:'結帳時遇到系統異常，你會？', options:['亂按一通','先告知客人並請主管協助','直接關店','把錢收進口袋'], answer:1 },
          { q:'客人情緒激動，你會？', options:['回嗆','保持冷靜並請支援','直接錄影上網','丟東西'], answer:1 }
        ]
      },
      {
        id:'job_kitchen',
        title:'餐飲內場/洗碗',
        wage: 200,
        energy: 15,
        mood: -2,
        minAge: 15,
        strictAge: false,
        apCost: 1,
        desc:'忙碌但薪水不錯，需注意安全與衛生。',
        interviews: [
          { q:'地板濕滑時，你會？', options:['不管','立刻擦乾或放警示','跑跳','倒更多水'], answer:1 }
        ]
      },
      {
        id:'job_delivery',
        title:'外送助手(步行/大眾運輸)',
        wage: 210,
        energy: 14,
        mood: 0,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc:'時間彈性，但要注意詐騙訂單與定位隱私。',
        interviews: [
          { q:'客人要求你把餐點送到「非訂單地址」並加Line，你會？', options:['立刻加','拒絕並走平台流程','把電話給他','拍自己證件'], answer:1 },
          { q:'收到可疑連結說要「重新驗證帳戶」，你會？', options:['點進去','不點並查證官方通知','轉發朋友','輸入密碼'], answer:1 }
        ]
      },
      {
        id:'job_tutor',
        title:'補習班助教',
        wage: 220,
        energy: 10,
        mood: 2,
        minAge: 17,
        strictAge: false,
        apCost: 1,
        desc:'需要耐心與溝通，適合喜歡帶小孩的人。',
        interviews: [
          { q:'學生吵鬧時，你會？', options:['大吼','用規則與鼓勵引導','丟粉筆','直接走人'], answer:1 }
        ]
      },
      {
        id:'job_gas',
        title:'加油站服務',
        wage: 205,
        energy: 13,
        mood: -1,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc:'需要體力與安全意識，注意防火規定。',
        interviews: [
          { q:'加油時手機響了，你會？', options:['邊加油邊講','先停止操作並把手機收好','把手機放油箱上','拍影片'], answer:1 }
        ]
      },
      {
        id:'job_construction',
        title:'工地打雜(需注意安全)',
        wage: 240,
        energy: 20,
        mood: -3,
        minAge: 18,
        strictAge: true,
        apCost: 1,
        desc:'高強度且有風險，未滿 18 通常不可。',
        interviews: [
          { q:'沒有安全帽時，你會？', options:['照做','拒絕並要求配備','拿帽子代替','假裝看不到'], answer:1 }
        ]
      },
      {
        id:'job_sampling',
        title:'賣場試吃/推廣',
        wage: 195,
        energy: 11,
        mood: 1,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        desc:'需要口條與禮貌，學習面對人群。',
        interviews: [
          { q:'被拒絕試吃，你會？', options:['嘲笑對方','微笑說謝謝','追著對方','把食物塞給他'], answer:1 }
        ]
      }
    ];

    const HOUSING = [
      {
        id:'house_ccsa',
        type:'ccsa',
        title:'CCSA 自立宿舍',
        rent: 0,
        deposit: 0,
        securityDelta: +10,
        desc:'有社工支持、規範清楚，能降低漂泊風險。',
        quizKey:'ccsa_interview'
      },
      {
        id:'house_shared',
        type:'shared',
        title:'合租雅房',
        rent: 1200,
        deposit: 1200,
        securityDelta: +2,
        desc:'分攤房租，但要注意契約與室友規則。',
        quizKey:'contract_check'
      },
      {
        id:'house_basement',
        type:'basement',
        title:'地下室分租套房',
        rent: 1500,
        deposit: 1500,
        securityDelta: -6,
        desc:'租金較低，但潮濕與安全、逃生要留意。',
        quizKey:'house_check'
      },
      {
        id:'house_rooftop',
        type:'rooftop',
        title:'頂加套房(頂樓加蓋)',
        rent: 1600,
        deposit: 1600,
        securityDelta: -8,
        desc:'便宜但風險較高，需特別查逃生與合法性。',
        quizKey:'house_check'
      },
      {
        id:'house_relative',
        type:'relative',
        title:'親友短住',
        rent: 600,
        deposit: 0,
        securityDelta: +1,
        desc:'短期可行，但要談清楚規則與界線。',
        quizKey:'relative_check'
      },
      {
        id:'house_dorm',
        type:'dorm',
        title:'員工宿舍',
        rent: 1000,
        deposit: 0,
        securityDelta: +4,
        desc:'跟工作連動，穩定但需遵守管理規定。',
        quizKey:'rule_check'
      },
      {
        id:'house_coliving',
        type:'coliving',
        title:'共居空間(分租床位)',
        rent: 900,
        deposit: 900,
        securityDelta: -2,
        desc:'便宜但隱私少，需注意財物與人身安全。',
        quizKey:'rule_check'
      },
      {
        id:'house_studio',
        type:'studio',
        title:'小套房(獨立套房)',
        rent: 2200,
        deposit: 2200,
        securityDelta: +3,
        desc:'相對自由，但支出壓力較大。',
        quizKey:'contract_check'
      }
    ];

    const SHOP_ITEMS = [
      { id:'shop_bento', title:'便當(飽足)', price:120, mood:+3, health:+2, security:0, itemKey:null, desc:'補充能量，心情稍微好一點。' },
      { id:'shop_b12', title:'B群(保健)', price:180, mood:+1, health:+6, security:0, itemKey:null, desc:'提升精神與體力恢復。' },
      { id:'shop_milktea', title:'手搖飲(小確幸)', price:70, mood:+5, health:-1, security:0, itemKey:null, desc:'心情變好，但別太常喝。' },
      { id:'shop_clothes', title:'新衣服(面試加分)', price:800, mood:+6, health:0, security:0, itemKey:'nice_clothes', desc:'提升自信，也可能幫助面試表現。' },
      { id:'shop_concert', title:'演唱會(放鬆)', price:1200, mood:+12, health:+2, security:0, itemKey:null, desc:'喘口氣，但要注意預算。' },
      { id:'shop_phone', title:'iPhone(昂貴慾望)', price:20000, mood:+10, health:0, security:-8, itemKey:'new_phone', desc:'看起來很酷，但財務壓力巨大。', ageMin:16 },
      { id:'shop_health_ins', title:'健保/基本醫療保障', price:500, mood:+1, health:+0, security:+2, itemKey:'health_insurance', desc:'遇到生病事件可減少損失。' },
      { id:'shop_acc_ins', title:'意外險(基本)', price:650, mood:+1, health:+0, security:+2, itemKey:'accident_insurance', desc:'遇到意外事件可減少損失。' },
      { id:'shop_stock_scam', title:'飆股內線群(投資詐騙)', price:3000, mood:-30, health:0, security:-12, itemKey:null, desc:'高報酬保證？非常可疑。', scam:true }
    ];

    const QUIZ_DB = {
      // 租屋常識
      house_check: [
        { q:'看房時最重要先確認？', options:['牆面顏色','逃生動線與安全','房東穿著','門牌美不美'], answer:1 },
        { q:'頂加/地下室常見風險？', options:['太安靜','潮濕、火災逃生困難','太大','冷氣太強'], answer:1 },
        { q:'看房時應避免？', options:['拍照記錄','確認窗戶與通風','先付訂金再看證件','詢問水電費計算'], answer:2 },
        { q:'遇到「不簽約也要留身分證」你應？', options:['給他','婉拒並查證','把提款卡給他','立刻匯款'], answer:1 }
      ],
      contract_check: [
        { q:'簽約前要確認？', options:['房東星座','租金/押金/期限/修繕責任','鄰居名字','牆壁厚度'], answer:1 },
        { q:'租金繳交最好？', options:['只付現金不留證明','用可查證方式並留存收據/轉帳紀錄','交給陌生人','用點數支付'], answer:1 },
        { q:'合約上不寫你的名字，風險？', options:['沒有風險','權益難保障，爭議難處理','房租更便宜','更安全'], answer:1 },
        { q:'房東說「先付全額押金才給合約」你應？', options:['立刻付','先看合約、查證房東身分與產權','用信用卡分期','把密碼給他'], answer:1 }
      ],
      rule_check: [
        { q:'入住前要先談清楚？', options:['喜歡的顏色','作息/訪客/公共空間使用規則','誰最漂亮','看劇口味'], answer:1 },
        { q:'與室友共住，財物安全建議？', options:['全部放桌上','重要物品上鎖、少帶現金','把密碼貼牆上','借錢給每個人'], answer:1 },
        { q:'室友要你幫忙代收包裹並要求拆封，你應？', options:['立刻拆','拒絕，避免涉入風險','拍照上網','把包裹丟掉'], answer:1 },
        { q:'遇到衝突，較好的做法？', options:['冷戰','用具體事件與規則溝通、必要時找第三方協助','直接動手','搬走不說'], answer:1 }
      ],
      relative_check: [
        { q:'親友短住最重要要？', options:['不說規則','事先談好界線、期限、分擔方式','假裝自己是主人','每天借錢'], answer:1 },
        { q:'被要求做超出能力的家務，你應？', options:['硬扛','表達困難並協商','消失','偷錢'], answer:1 },
        { q:'親友要求你把薪水交給他管理，你應？', options:['全部交出','保留基本自主，必要時求助社工/福利資源','把提款卡給他','只用點數存'], answer:1 }
      ],
      ccsa_interview: [
        { q:'CCSA 自立宿舍的目標是？', options:['無限制自由','建立生活穩定、支持與自立能力','只為省錢','住到爽'], answer:1 },
        { q:'住宿規範存在的目的？', options:['懲罰','維持安全、尊重與共同生活品質','為了好看','讓人不敢回家'], answer:1 },
        { q:'遇到困難時你可以？', options:['躲起來','主動跟社工討論並連結資源','怪別人','離家出走'], answer:1 },
        { q:'資安/詐騙風險的基本原則？', options:['相信陌生人','不亂點連結、不交出帳密、需要查證','把OTP給朋友','用公開WiFi登入銀行'], answer:1 }
      ],
      job_test: [
        { q:'求職遇到「先繳保證金」你應？', options:['立刻繳','查證並拒絕可疑費用','刷卡分期','把提款卡交出'], answer:1 },
        { q:'面試時被要求提供 OTP，你應？', options:['給他','OTP 是一次性密碼，不能給任何人','發到群組','寫在履歷上'], answer:1 },
        { q:'要提升錄取率，最有用？', options:['到處借錢','準備履歷、守時、問清楚薪資工時','罵前公司','隨便填資料'], answer:1 },
        { q:'遇到「高薪輕鬆、免面試、保證錄取」最可能？', options:['真福利','詐騙風險高','政府專案','老師介紹'], answer:1 }
      ],
      welfare_help: [
        { q:'申請福利資源前，應先？', options:['亂填','準備基本資料並說明需求','把帳密交出','先買點數'], answer:1 },
        { q:'社福中心的功能較接近？', options:['賭場','資訊與資源連結、補助諮詢','地下錢莊','粉絲團'], answer:1 },
        { q:'如果被拒絕一次，你應？', options:['放棄','問清楚原因、補件或找替代資源','罵人','轉去詐騙群'], answer:1 }
      ],
      finance_help: [
        { q:'緊急補助最適合用在？', options:['奢侈品','基本生活、醫療或急迫需求','飆股群','請客'], answer:1 },
        { q:'申請補助時要避免？', options:['誠實說明','誇大或捏造證明','留下聯絡方式','了解條件'], answer:1 },
        { q:'如果要求你提供提款卡作為「擔保」，你應？', options:['提供','拒絕並尋求正規管道','給OTP','改用點數'], answer:1 }
      ],
      ccsa_aid: [
        { q:'社工陪伴的核心精神是？', options:['替你決定一切','協助你做選擇、連結資源、降低風險','只管你','讓你更依賴'], answer:1 },
        { q:'經濟支持最希望帶來？', options:['一次花光','穩定生活與長期規劃','炫耀','買名牌'], answer:1 },
        { q:'遇到壓力時較健康的方法？', options:['絕食威脅','說出感受並尋求支持','衝動購物','逃避不見人'], answer:1 }
      ],
      ccsa_counseling: [
        { q:'心理諮商的目標較接近？', options:['被罵一頓','整理情緒、增加覺察與因應策略','變成超人','保證馬上快樂'], answer:1 },
        { q:'你可以在諮商中做什麼？', options:['只說好','誠實描述困擾並一起找方法','說謊','測試對方'], answer:1 },
        { q:'情緒很大時，第一步可以？', options:['爆衝','先停一下、呼吸、找安全的人說','砸東西','開罵'], answer:1 }
      ],
      ccsa_training: [
        { q:'自立培訓最主要是？', options:['考第一名','學技能：理財/租屋/求職/風險管理','只玩遊戲','比誰有錢'], answer:1 },
        { q:'理財的第一步通常是？', options:['All in','記帳與預算','借錢','買飆股群'], answer:1 },
        { q:'如果你發現自己常被衝動影響，你可以？', options:['放棄','設定延遲購買、找人討論','把卡給陌生人','亂花'], answer:1 }
      ]
    };

    const SCENARIOS = [
      {
        id:'friend_loan',
        title:'朋友借錢',
        desc:'朋友說「我只差一點點就能過關」，希望你先借他。',
        weight: 1,
        options: [
          {
            label:'先問清楚用途與還款方式（較安全）',
            apply: ({stats}) => {
              const ok = stats.security >= 55;
              if(ok){
                return { mood:+2, security:+2, log:'你先確認用途與還款方式，避免了情緒勒索。' };
              }
              return { mood:-4, security:-2, log:'你試著確認，但仍被話術影響，感覺有點不舒服。' };
            }
          },
          {
            label:'直接借 1000（高風險）',
            apply: ({stats}) => {
              const lose = Math.random() < 0.6;
              if(lose){
                return { money:-1000, mood:-10, security:-2, log:'你借出 1000，但朋友遲遲沒還，心情下滑。' };
              }
              return { money:-1000, money2:+1100, mood:+1, security:+0, log:'朋友如期還款並多還 100，算是好結果。' };
            }
          },
          {
            label:'婉拒並提供資源（例如社福或就服）',
            apply: () => ({ mood:+3, security:+1, log:'你婉拒借錢，改提供求助管道，界線更清楚。' })
          }
        ]
      },
      {
        id:'scam_romance',
        title:'愛情詐騙',
        desc:'網友甜言蜜語，突然說遇到急難需要你匯款。',
        weight: 1,
        options: [
          {
            label:'不匯款，要求視訊並查證（較安全）',
            apply: ({stats}) => {
              if(stats.security >= 55){
                return { mood:+2, security:+3, log:'你要求查證，對方立刻消失，成功避開詐騙。' };
              }
              return { mood:-4, security:-1, log:'你有懷疑但仍受情緒影響，心裡不安。' };
            }
          },
          {
            label:'匯款 2000（高風險）',
            apply: () => ({ money:-2000, mood:-18, security:-6, log:'你匯款後對方失聯，疑似遭遇愛情詐騙。' })
          }
        ]
      },
      {
        id:'scam_job',
        title:'求職詐騙',
        desc:'對方說「先付訓練費/保證金」才能上工，並要你點連結登入。',
        weight: 1,
        options: [
          {
            label:'拒絕付款並查證公司（較安全）',
            apply: ({stats}) => {
              if(stats.security >= 50){
                return { mood:+2, security:+4, log:'你查證後發現是假公司，成功避開求職詐騙。' };
              }
              return { mood:-5, security:-2, log:'你半信半疑，最後雖未付款，但被嚇到心情變差。' };
            }
          },
          {
            label:'付 1500 當保證金（高風險）',
            apply: () => ({ money:-1500, mood:-15, security:-6, log:'你付了保證金，對方失聯，疑似求職詐騙。' })
          }
        ]
      },
      {
        id:'accident',
        title:'意外受傷',
        desc:'你不小心跌倒扭傷，需要休息或就醫。',
        weight: 1,
        options: [
          {
            label:'去看醫生（較佳）',
            apply: ({hasItem}) => {
              if(hasItem('accident_insurance')){
                return { money:-200, health:-2, mood:-2, log:'有意外險支援，花費較少，狀況穩住。' };
              }
              return { money:-1200, health:-10, mood:-6, log:'沒有保險支援，醫療花費高，體力下降。' };
            }
          },
          {
            label:'硬撐不看（風險）',
            apply: () => ({ health:-16, mood:-8, security:-1, log:'你硬撐不看醫生，結果更不舒服。' })
          }
        ]
      },
      {
        id:'sickness',
        title:'突然生病',
        desc:'你發燒、身體不舒服，可能影響工作與生活。',
        weight: 1,
        options: [
          {
            label:'先休息並補充營養',
            apply: ({hasItem}) => {
              if(hasItem('health_insurance')){
                return { money:-150, health:+4, mood:+1, log:'有基本醫療保障，你休息後緩解。' };
              }
              return { money:-800, health:-8, mood:-4, log:'沒有保障，買藥與看診讓你壓力變大。' };
            }
          },
          {
            label:'不管它，繼續衝',
            apply: () => ({ health:-14, mood:-10, security:-1, log:'你硬撐，病更嚴重，情緒也下滑。' })
          }
        ]
      },
      {
        id:'police',
        title:'臨檢與關懷',
        desc:'你在外遊走，遇到警方臨檢並關心你的狀況。',
        weight: 1,
        options: [
          {
            label:'如實說明並配合（建議）',
            apply: ({stats, hasItem}) => {
              const adult = stats.age >= 18;
              const good = hasItem('good_citizen_card');
              if(adult && good){
                return { mood:+4, security:+4, ap:+1, log:'你態度良好且有良民證明，警方提醒安全後放行。' };
              }
              if(adult && !good){
                return { mood:-2, security:+1, ap:-1, log:'你配合但缺乏證明，花了點時間說明。' };
              }
              // 未滿18
              return { mood:-4, security:-1, ap:-1, log:'未滿 18，警方建議尋求監護/社工支持並提醒安全。' };
            }
          },
          {
            label:'不耐煩頂嘴（不建議）',
            apply: ({stats}) => {
              if(stats.age >= 18){
                return { mood:-10, security:-6, ap:-2, log:'你態度不佳，臨檢延長，情緒與資安感下降。' };
              }
              return { mood:-12, security:-8, ap:-2, log:'未滿 18 又頂嘴，狀況更麻煩，壓力暴增。' };
            }
          }
        ]
      }
    ];

    const PAY_METHODS = [
      { key:'cash', label:'現金' },
      { key:'credit', label:'信用卡（下週扣）', ageMin:18 },
      { key:'bnpl', label:'分期後付（4週）', ageMin:18 }
    ];

    // ===== SVG Icons (內建 React Component) =====
    function IconWrapper({ children }){
      return (
        <svg viewBox="0 0 24 24" className="w-7 h-7" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          {children}
        </svg>
      );
    }
    const IconHome = () => <IconWrapper><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v10h14V10"/></IconWrapper>;
    const IconHouse = () => <IconWrapper><path d="M3 11 12 3l9 8"/><path d="M5 10v10h14V10"/><path d="M9 20v-6h6v6"/></IconWrapper>;
    const IconBriefcase = () => <IconWrapper><path d="M9 6h6"/><path d="M10 6V4h4v2"/><path d="M4 8h16v12H4z"/><path d="M4 12h16"/></IconWrapper>;
    const IconMap = () => <IconWrapper><path d="M3 6l6-2 6 2 6-2v14l-6 2-6-2-6 2z"/><path d="M9 4v14"/><path d="M15 6v14"/></IconWrapper>;
    const IconWallet = () => <IconWrapper><path d="M3 7h18v12H3z"/><path d="M3 7V5h14v2"/><path d="M16 12h5"/><path d="M18 10v4"/></IconWrapper>;
    const IconSpark = () => <IconWrapper><path d="M12 2l1.8 6.2L20 10l-6.2 1.8L12 18l-1.8-6.2L4 10l6.2-1.8z"/></IconWrapper>;
    const IconShield = () => <IconWrapper><path d="M12 2l8 4v6c0 5-3.5 9.5-8 10-4.5-.5-8-5-8-10V6z"/><path d="M9 12l2 2 4-4"/></IconWrapper>;
    const IconHeart = () => <IconWrapper><path d="M12 21s-7-4.5-9-9a5 5 0 0 1 9-2 5 5 0 0 1 9 2c-2 4.5-9 9-9 9z"/></IconWrapper>;
    const IconBolt = () => <IconWrapper><path d="M13 2 3 14h7l-1 8 10-12h-7z"/></IconWrapper>;
    const IconCart = () => <IconWrapper><circle cx="9" cy="20" r="1.5"/><circle cx="17" cy="20" r="1.5"/><path d="M3 4h2l2 12h12l2-8H7"/></IconWrapper>;

    // ===== UI Components =====
    function StatPill({ label, value, colorClass }){
      return (
        <div className="neo-shadow bg-white rounded-2xl px-3 py-2 min-w-[92px]">
          <div className="text-[11px] text-slate-600 font-medium truncate">{label}</div>
          <div className="flex items-center gap-2 mt-1">
            <div className="text-sm font-bold pixel-title">{value}</div>
            <div className="flex-1 h-2 rounded-full bg-slate-200 overflow-hidden">
              <div className={"h-2 " + colorClass} style={{ width: clamp(value,0,100) + '%' }} />
            </div>
          </div>
        </div>
      );
    }

    function APBar({ ap, maxAp }){
      const boxes = [];
      for(let i=0;i<maxAp;i++){
        const filled = i < ap;
        boxes.push(
          <div key={i} className={"w-4 h-4 rounded-md border-2 border-black " + (filled ? "bg-emerald-300" : "bg-white")} />
        );
      }
      return <div className="flex items-center gap-1">{boxes}</div>;
    }

    function StatBar({ stats, livingCost }){
      return (
        <div className="p-3 bg-white/90 backdrop-blur border-b-2 border-black">
          <div className="flex items-start justify-between gap-2">
            <div className="min-w-0">
              <div className="pixel-title text-xl leading-none">Week {stats.week}/{stats.maxWeeks}</div>
              <div className="text-[11px] text-slate-600 mt-1 break-words">本週基本支出：{livingCost} 元</div>
            </div>
            <div className="flex items-center gap-2">
              <div className="text-[11px] text-slate-600 font-semibold">AP</div>
              <APBar ap={stats.ap} maxAp={stats.maxAp} />
            </div>
          </div>

          <div className="mt-3 flex gap-2 flex-wrap">
            <StatPill label="體力" value={stats.health} colorClass="bg-emerald-400" />
            <StatPill label="心情" value={stats.mood} colorClass="bg-amber-400" />
            <StatPill label="資安" value={stats.security} colorClass="bg-sky-400" />
          </div>
        </div>
      );
    }

    function AppIcon({ title, subtitle, icon, onClick }){
      return (
        <button onClick={onClick} className="neo-btn w-full p-3 text-left">
          <div className="flex items-center gap-3">
            <div className="neo-shadow rounded-2xl p-2 bg-slate-50 shrink-0 text-slate-900">
              {icon}
            </div>
            <div className="min-w-0">
              <div className="font-black text-lg leading-tight break-words">{title}</div>
              <div className="text-[12px] text-slate-600 leading-snug break-words">{subtitle}</div>
            </div>
            <div className="ml-auto text-xl font-black">→</div>
          </div>
        </button>
      );
    }

    function ModalWrapper({ title, children, onClose, footer }){
      return (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
          <div className="neo-card modal-pop w-full max-w-[380px] max-h-[82vh] flex flex-col">
            <div className="px-4 py-3 border-b-2 border-black flex items-start gap-2">
              <div className="font-black text-lg leading-tight break-words flex-1">{title}</div>
              <button className="neo-btn px-3 py-1 text-sm font-black" onClick={onClose}>關閉</button>
            </div>
            <div className="p-4 scroll-area flex-1">
              {children}
            </div>
            {footer ? (
              <div className="p-4 border-t-2 border-black bg-white">
                {footer}
              </div>
            ) : null}
          </div>
        </div>
      );
    }

    function FloatingTextOverlay({ items }){
      return (
        <div className="pointer-events-none absolute inset-0 z-40 flex items-start justify-center">
          <div className="mt-24 flex flex-col gap-1 items-center">
            {items.map(it => (
              <div
                key={it.id}
                className={"float-text text-lg font-black " + (it.kind === 'good' ? "text-emerald-600" : "text-rose-600")}
              >
                {it.text}
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ===== Main App =====
    function App(){
      const [screen, setScreen] = useState('landing'); // landing | home | job | house | resource | finance
      const [stats, setStats] = useState({ ...INITIAL_STATS });
      const [logs, setLogs] = useState([]);
      const [modal, setModal] = useState(null); // {type, ...}
      const [floating, setFloating] = useState([]);
      const [glitch, setGlitch] = useState(false);

      const [hasHouse, setHasHouse] = useState(false);
      const [houseName, setHouseName] = useState('');
      const [houseType, setHouseType] = useState('');

      const [inventory, setInventory] = useState({
        accompaniment_card: false,
        good_citizen_card: false,
        health_insurance: false,
        accident_insurance: false,
        nice_clothes: false,
        new_phone: false
      });

      const [bills, setBills] = useState([]); // {id,name,weeklyAmount,remainingWeeks,type}
      const [wheel, setWheel] = useState({ spinning:false, done:false, tier:null, money:0, age:15 });

      // === 任務/成就追蹤 ===
      const [jobSuccessCount, setJobSuccessCount] = useState(0);
      const [resourceSuccessCount, setResourceSuccessCount] = useState(0);
      const [housingEver, setHousingEver] = useState(false);
      const [scamAvoidCount, setScamAvoidCount] = useState(0);
      const [scamHitCount, setScamHitCount] = useState(0);

      const prevStatsRef = useRef(stats);

      function addLog(text){
        const w = prevStatsRef.current.week;
        const line = `[W${w}] ${text}`;
        setLogs(prev => [line, ...prev].slice(0, 30));
      }

      function hasItem(key){
        return !!inventory[key];
      }

      function markResourceSuccess(){
        setResourceSuccessCount(v => v + 1);
      }

      function showGlitchPulse(){
        setGlitch(true);
        window.setTimeout(() => setGlitch(false), 600);
      }

      // Calculate living cost per spec
      const livingCost = useMemo(() => {
        let cost = 1500;
        if(hasHouse && houseType !== 'ccsa') cost += 500;
        return cost;
      }, [hasHouse, houseType]);

      function applyDelta(delta){
        setStats(prev => {
          let next = { ...prev };
          for(const k of Object.keys(delta || {})){
            if(k === 'money2'){
              next.money = (next.money || 0) + (delta.money2 || 0);
              continue;
            }
            if(typeof next[k] === 'number' && typeof delta[k] === 'number'){
              next[k] = next[k] + delta[k];
            }else if(typeof delta[k] === 'number'){
              next[k] = delta[k];
            }
          }
          // clamp
          next.health = clamp(next.health, 0, 100);
          next.mood = clamp(next.mood, 0, 100);
          next.security = clamp(next.security, 0, 100);
          next.ap = clamp(next.ap, 0, next.maxAp);
          return next;
        });
      }

      function openMessage(title, message, onOk){
        setModal({ type:'message', title, message, onOk });
      }

      function closeModal(){
        setModal(null);
      }

      // Floating text overlay: compare stats changes
      useEffect(() => {
        const prev = prevStatsRef.current;
        const cur = stats;
        const diffs = [];

        function pushDiff(key, label){
          const d = (cur[key] || 0) - (prev[key] || 0);
          if(d !== 0){
            diffs.push({
              id: uid('ft'),
              text: `${label} ${d>0?'+':''}${d}`,
              kind: d>0 ? 'good' : 'bad'
            });
          }
        }

        pushDiff('money', '金錢');
        pushDiff('health', '體力');
        pushDiff('mood', '心情');
        pushDiff('security', '資安');
        pushDiff('ap', 'AP');

        if(diffs.length){
          setFloating(prevF => [...diffs, ...prevF].slice(0, 6));
          window.setTimeout(() => {
            setFloating(prevF => prevF.filter(x => !diffs.some(d => d.id === x.id)));
          }, 950);
        }

        // glitch trigger when low mood/security
        if((cur.mood < 30 && prev.mood >= 30) || (cur.security < 30 && prev.security >= 30)){
          showGlitchPulse();
        }

        prevStatsRef.current = stats;
      }, [stats]);

      // ===== Onboarding wheel =====
      function startWheel(){
        if(wheel.spinning) return;
        setWheel(prev => ({ ...prev, spinning:true }));
        addLog('你啟動了命運轉盤。');

        window.setTimeout(() => {
          // weighted by prob
          const weighted = CHARACTER_ORIGINS.map(x => ({ ...x, weight: x.prob }));
          const pick = weightedPick(weighted);
          const age = 15 + Math.floor(Math.random() * 5); // 15~19
          setWheel({ spinning:false, done:true, tier: pick.tier, money: pick.money, age });
          // set initial stats money + age
          setStats(prev => ({ ...prev, money: pick.money, age }));
          addLog(`命運轉盤結果：等級 ${pick.tier}（${pick.label}），初始金額 ${pick.money} 元，年齡 ${age}。`);
        }, 2000);
      }

      function choosePassword(option){
        if(option === 'weak'){
          applyDelta({ security: -20 });
          addLog('你選了弱密碼 123456：資安下降。');
        }else{
          applyDelta({ security: +10 });
          addLog('你選擇開啟 2FA：資安提升。');
        }
        addLog('你啟動了遊戲。');
        setScreen('home');
      }

      // ===== Quiz system =====
      function pickQuestionsFromKey(quizKey, count=3){
        const src = QUIZ_DB[quizKey] ? [...QUIZ_DB[quizKey]] : [];
        const mixed = shuffleArray(src);
        let out = mixed.slice(0, count);

        // fallback fill
        if(out.length < count){
          const fill = shuffleArray(GENERIC_JOB_QUESTIONS).slice(0, count - out.length);
          out = out.concat(fill);
        }
        return out;
      }

      function openQuiz(title, quizKey, onPass, onFail, hint){
        const questions = pickQuestionsFromKey(quizKey, 3);
        setModal({
          type:'quiz',
          title,
          quizKey,
          hint: hint || '',
          questions,
          onPass,
          onFail
        });
      }

      // ===== Job flow =====
      function canApplyJob(job){
        if(stats.ap < job.apCost) return { ok:false, msg:'AP 不足，先休息或下一週再試。' };

        if(stats.age >= job.minAge) return { ok:true, msg:'' };

        // age < minAge
        if(hasItem('accompaniment_card') && !job.strictAge){
          return { ok:true, msg:'你有社工陪同卡，部分年齡限制可彈性處理。' };
        }
        return { ok:false, msg:`年齡不足（需要 ${job.minAge}+）。` };
      }

      function startJobInterview(job){
        const gate = canApplyJob(job);
        if(!gate.ok){
          openMessage('無法應徵', gate.msg);
          return;
        }

        // consume AP
        applyDelta({ ap: -job.apCost });
        addLog(`你前往應徵「${job.title}」，消耗 ${job.apCost} AP。`);

        // build 3 questions from job.interviews + generic
        const pool = [...(job.interviews || []), ...GENERIC_JOB_QUESTIONS];
        const questions = shuffleArray(pool).slice(0, 3);

        setModal({
          type:'interview',
          title:`面試：${job.title}`,
          job,
          questions
        });
      }

      // ===== Housing flow =====
      function bookHouseViewing(h){
        if(stats.ap < 1){
          openMessage('AP 不足', '你現在 AP 不足，先休息或下一週再預約看房。');
          return;
        }

        applyDelta({ ap: -1 });
        addLog(`你預約看房：「${h.title}」，消耗 1 AP。`);

        openQuiz(
          `看房/簽約測驗：${h.title}`,
          h.quizKey,
          () => {
            // signing rules
            if(stats.age < 18 && !hasItem('accompaniment_card') && h.type !== 'ccsa'){
              addLog('你未滿 18 且沒有陪同卡，無法簽約（非 CCSA 住房）。');
              openMessage('無法簽約', '你未滿 18 且沒有「社工陪同卡」，除 CCSA 自立宿舍外不建議/多半無法簽約。');
              return;
            }

            // deposit
            if(h.deposit > 0){
              applyDelta({ money: -h.deposit });
              addLog(`簽約押金支出：-${h.deposit} 元。`);
            }else{
              addLog('此房源免押金。');
            }

            applyDelta({ security: h.securityDelta });
            setHasHouse(true);
            setHousingEver(true);
            setHouseName(h.title);
            setHouseType(h.type);

            // add rent bill if rent > 0
            if(h.rent > 0){
              const rentBillId = uid('bill_rent');
              setBills(prev => {
                // remove old rent bills first
                const filtered = prev.filter(b => b.type !== 'rent');
                return [
                  { id: rentBillId, name:`房租：${h.title}`, weeklyAmount: h.rent, remainingWeeks: 99, type:'rent' },
                  ...filtered
                ];
              });
              addLog(`你入住後每週房租：${h.rent} 元（列入帳單）。`);
            }else{
              // remove rent bills if any
              setBills(prev => prev.filter(b => b.type !== 'rent'));
            }

            addLog(`入住成功：${h.title}（資安${h.securityDelta>=0?'+':''}${h.securityDelta}）。`);
            closeModal();
          },
          () => {
            addLog(`看房測驗未通過：你暫時無法租下「${h.title}」。`);
            applyDelta({ mood: -6 });
            closeModal();
          },
          '答對 3 題才算通過。'
        );
      }

      // ===== Resource flow =====
      function doResourceAction(actionKey){
        const actions = {
          job_test: {
            title:'就業服務站：就業準備測驗',
            quizKey:'job_test',
            success: () => ({ money:+1000, security:+3, mood:+2, log:'你完成就服測驗，獲得獎勵 1000 元，並提升警覺。' }),
            fail: () => ({ mood:-6, log:'就服測驗沒過，先把求職詐騙與面試守則再複習。' }),
            cond: () => ({ ok:true, msg:'' })
          },
          welfare_help: {
            title:'社會福利中心：基本支持',
            quizKey:'welfare_help',
            success: () => ({ health:+20, mood:+6, log:'你成功連結社福支持：體力+20、心情提升。' }),
            fail: () => ({ mood:-6, log:'你申請時說不清需求，這次沒有成功連結。' }),
            cond: () => ({ ok:true, msg:'' })
          },
          finance_help: {
            title:'社會福利中心：緊急經濟協助',
            quizKey:'finance_help',
            success: () => ({ money:+5000, mood:+6, security:+2, log:'你符合條件並成功申請：+5000 元，壓力下降。' }),
            fail: () => ({ mood:-8, log:'申請未通過：可能需要補件或改找替代資源。' }),
            cond: () => {
              if(stats.money < 2000) return { ok:true, msg:'' };
              return { ok:false, msg:'此項目僅限「餘額 < 2000」時申請（避免濫用資源）。' };
            }
          },
          ccsa_aid: {
            title:'CCSA 自立服務：經濟支持',
            quizKey:'ccsa_aid',
            success: () => ({ money:+3000, mood:+6, security:+2, log:'你成功申請 CCSA 支持：+3000 元。' }),
            fail: () => ({ mood:-6, log:'你這次說明不夠清楚，未能成功申請支持。' }),
            cond: () => ({ ok:true, msg:'' })
          },
          ccsa_counseling: {
            title:'CCSA 自立服務：心理諮商',
            quizKey:'ccsa_counseling',
            success: () => ({ mood:+30, health:+10, log:'諮商完成：心情+30、體力+10。' }),
            fail: () => ({ mood:-4, log:'你很難開口，這次諮商效果有限。' }),
            cond: () => ({ ok:true, msg:'' })
          },
          ccsa_training: {
            title:'CCSA 自立服務：自立培訓',
            quizKey:'ccsa_training',
            success: () => ({ maxAp:+1, ap:+1, mood:+10, security:+2, log:'培訓完成：最大 AP +1，心情提升。' }),
            fail: () => ({ mood:-4, log:'培訓測驗沒過：先把基礎觀念再練一次。' }),
            cond: () => ({ ok:true, msg:'' })
          }
        };

        if(actionKey === 'apply_accompaniment'){
          if(stats.ap < 1){
            openMessage('AP 不足', '你現在 AP 不足，無法申請陪同。');
            return;
          }
          if(hasItem('accompaniment_card')){
            openMessage('已擁有', '你已經有「社工陪同卡」，不需要重複申請。');
            return;
          }
          applyDelta({ ap:-1 });
          setInventory(prev => ({ ...prev, accompaniment_card:true }));
          addLog('你申請社工陪同：獲得「社工陪同卡」。');
          markResourceSuccess();
          openMessage('申請成功', '你獲得「社工陪同卡」。在求職/租屋遇到年齡或流程障礙時，可以更有支持。');
          return;
        }

        if(actionKey === 'police_good'){
          if(stats.age < 18){
            openMessage('無法申請', '未滿 18 需要法定代理人/監護人協助，建議先與社工討論。');
            return;
          }
          if(hasItem('good_citizen_card')){
            openMessage('已擁有', '你已經領過「良民證明」。');
            return;
          }
          setInventory(prev => ({ ...prev, good_citizen_card:true }));
          addLog('你在警察局取得「良民證明」。');
          markResourceSuccess();
          openMessage('取得成功', '你取得「良民證明」。遇到臨檢情境可能更順利。');
          return;
        }

        const cfg = actions[actionKey];
        if(!cfg){
          openMessage('尚未設定', '此功能尚未設定。');
          return;
        }

        const gate = cfg.cond();
        if(!gate.ok){
          openMessage('不符合條件', gate.msg);
          return;
        }

        openQuiz(
          cfg.title,
          cfg.quizKey,
          () => {
            const out = cfg.success();
            const { log, ...delta } = out;
            applyDelta(delta);
            if(log) addLog(log);
            markResourceSuccess();
            closeModal();
          },
          () => {
            const out = cfg.fail();
            const { log, ...delta } = out;
            applyDelta(delta);
            if(log) addLog(log);
            closeModal();
          },
          '答對 3 題才算通過。'
        );
      }

      // ===== Shop & finance =====
      function addBill(name, weeklyAmount, remainingWeeks, type='bill'){
        const b = { id: uid('bill'), name, weeklyAmount, remainingWeeks, type };
        setBills(prev => [b, ...prev]);
      }

      function buyItem(item, payMethod){
        const method = PAY_METHODS.find(p => p.key === payMethod) || PAY_METHODS[0];

        if(method.ageMin && stats.age < method.ageMin){
          openMessage('年齡限制', `${method.label} 需要年齡 ${method.ageMin}+。`);
          return;
        }

        if(item.ageMin && stats.age < item.ageMin){
          openMessage('年齡限制', `「${item.title}」建議年齡 ${item.ageMin}+。`);
          return;
        }

        // scam item
        if(item.scam){
          // immediate loss (no item granted)
          if(payMethod === 'cash'){
            applyDelta({ money: -item.price, mood: item.mood, security: item.security });
          }else if(payMethod === 'credit'){
            addBill(`信用卡帳單：${item.title}`, item.price, 1, 'credit');
            applyDelta({ mood: item.mood, security: item.security });
          }else{
            const total = Math.round(item.price * 1.2);
            const weekly = Math.ceil(total / 4);
            addBill(`分期後付：${item.title}`, weekly, 4, 'bnpl');
            applyDelta({ mood: item.mood, security: item.security });
          }
          setScamHitCount(v => v + 1);
          addLog(`你購買了「${item.title}」：結果疑似投資詐騙，損失與情緒重挫。`);
          openMessage('投資詐騙提醒', '「保證高報酬」往往是詐騙。下次建議先查證、不要匯款/不要加入陌生群組。');
          closeModal();
          return;
        }

        // normal purchase
        if(payMethod === 'cash'){
          if(stats.money < item.price){
            openMessage('金額不足', '現金不足，請改用其他方式或先增加收入。');
            return;
          }
          applyDelta({ money: -item.price, mood: item.mood || 0, health: item.health || 0, security: item.security || 0 });
        }else if(payMethod === 'credit'){
          addBill(`信用卡帳單：${item.title}`, item.price, 1, 'credit');
          applyDelta({ mood: item.mood || 0, health: item.health || 0, security: item.security || 0 });
        }else{
          const total = Math.round(item.price * 1.2);
          const weekly = Math.ceil(total / 4);
          addBill(`分期後付：${item.title}`, weekly, 4, 'bnpl');
          applyDelta({ mood: item.mood || 0, health: item.health || 0, security: item.security || 0 });
        }

        if(item.itemKey){
          setInventory(prev => ({ ...prev, [item.itemKey]: true }));
          addLog(`你購買「${item.title}」，獲得道具效果。`);
        }else{
          addLog(`你購買「${item.title}」。`);
        }
        closeModal();
      }

      function addLedgerEntry(name, amount){
        if(!name || !String(name).trim()){
          openMessage('缺少名稱', '請填寫名稱。');
          return;
        }
        if(!Number.isFinite(amount) || amount === 0){
          openMessage('金額無效', '請輸入有效金額（不可為 0）。');
          return;
        }
        applyDelta({ money: amount });
        addLog(`你記帳：${name}（${amount>0?'+':''}${amount} 元）。`);
      }

      // ===== Weekly settlement =====
      function advanceWeek(){
        if(modal) return;

        // settle costs and bills
        addLog('你選擇結束本週，進入結算。');

        // deduct living cost
        applyDelta({ money: -livingCost, mood: -5, security: -2 });

        // bills update (deduct each bill weeklyAmount, decrement remainingWeeks)
        setBills(prev => {
          const next = [];
          for(const b of prev){
            // deduct
            setStats(s => {
              const moneyAfter = (s.money || 0) - (b.weeklyAmount || 0);
              return { ...s, money: moneyAfter };
            });

            const remain = (b.remainingWeeks || 0) - 1;
            if(remain > 0){
              next.push({ ...b, remainingWeeks: remain });
            }else{
              addLog(`帳單完成：${b.name}（已扣款結束）。`);
            }
          }
          return next;
        });

        // week+1 and ap reset
        setStats(prev => {
          const next = { ...prev, week: prev.week + 1, ap: prev.maxAp };
          return next;
        });

        // eviction check after a tick to ensure money updated
        window.setTimeout(() => {
          setStats(s => {
            const moneyNow = s.money;
            if(moneyNow < 0 && hasHouse && houseType !== 'ccsa'){
              // evict
              setHasHouse(false);
              setHouseName('');
              setHouseType('');
              setBills(prev => prev.filter(b => b.type !== 'rent')); // remove rent bills
              addLog('你在結算後出現赤字，且非 CCSA 住房：被迫搬離，狀態受挫。');
              // apply penalty
              return {
                ...s,
                mood: clamp(s.mood - 30, 0, 100),
                security: clamp(s.security - 10, 0, 100)
              };
            }
            return s;
          });

          // if ended game after finishing week 8 settlement
          window.setTimeout(() => {
            // trigger end or random event
            if(stats.week + 1 > stats.maxWeeks){
              // stats.week hasn't updated in closure reliably; compute by reading ref
              const final = prevStatsRef.current;
              if(final.week > final.maxWeeks){
                openMessage('第 8 週結算', buildEndMessage(final));
                return;
              }
            }
            triggerRandomEvent();
          }, 400);
        }, 60);
      }

      // ===== Random events =====
      function triggerRandomEvent(){
        // if already game end
        const cur = prevStatsRef.current;
        if(cur.week > cur.maxWeeks){
          openMessage('第 8 週結算', buildEndMessage(cur));
          return;
        }

        const roll = Math.random();
        if(roll > 0.6){
          addLog('本週沒有突發事件。');
          setScreen('home');
          return;
        }

        // build weighted pool
        const pool = [];
        for(const e of SCENARIOS){
          let w = e.weight || 1;

          // if no house, increase police weight
          if(!hasHouse && e.id === 'police') w += 2.2;

          // health < 50 increase sickness weight
          if(cur.health < 50 && e.id === 'sickness') w += 2.0;

          // if has house reduce police weight a bit
          if(hasHouse && e.id === 'police') w -= 0.6;

          if(w > 0) pool.push({ ...e, weight: w });
        }

        const picked = weightedPick(pool);
        setModal({ type:'event', scenario: picked });
      }

      // ===== Ending system =====
      function computeEnding(finalStats){
        const taskStableHousing = hasHouse; // 結算時仍有住處
        const taskStableWork = jobSuccessCount >= 2; // 成功上工>=2
        const taskLinkedResource = resourceSuccessCount >= 1; // 成功連結資源>=1

        const tasks = [
          { key:'housing', label:'穩定租屋', done: taskStableHousing },
          { key:'work', label:'穩定工作（成功上工 ≥ 2 次）', done: taskStableWork },
          { key:'resource', label:'成功連結社福資源', done: taskLinkedResource }
        ];
        const doneCount = tasks.filter(t => t.done).length;

        const isWin = (finalStats.money > 0) && (doneCount >= 2);

        let title = '努力前行的挑戰者';
        if(finalStats.money < 0){
          title = '負債累累的倖存者';
        }else if(finalStats.money >= 0 && !taskStableHousing){
          title = '漂泊中的努力者';
        }else if(finalStats.money > 0 && taskStableHousing && doneCount >= 2 && finalStats.money < 15000){
          title = '自立自強的模範生';
        }else if(finalStats.money >= 15000 && taskStableHousing && doneCount === 3){
          title = '全能自立王';
        }else if(finalStats.money > 0 && taskStableHousing && doneCount < 2){
          title = '有殼但仍需支持';
        }

        const achievements = [];
        if(housingEver) achievements.push('有殼蝸牛');
        if(finalStats.money >= 10000) achievements.push('理財達人');
        if(resourceSuccessCount >= 2) achievements.push('善用資源');
        if(scamAvoidCount >= 2 && scamHitCount === 0) achievements.push('反詐高手');
        if(jobSuccessCount >= 4) achievements.push('職場耐力王');
        if(achievements.length === 0) achievements.push('起步者');

        let comment = '';
        if(isWin){
          comment =
`你做到了：自立不只是賺錢，而是「把生活撐穩、把支持接上」。
你能在壓力下仍做出查證、規劃與求助的選擇，這就是自立的核心能力。`;
        }else{
          comment =
`這次卡住不代表你不行，通常是「支出壓力、突發事件、或詐騙風險」疊加造成。
下一輪建議優先做到兩件事：
1) 先把「住處或工作」其中一個穩住（降低不確定性）
2) 早一點連結資源（就業服務站/福利中心/CCSA），把風險分攤出去。`;
        }

        return { isWin, title, tasks, doneCount, achievements, comment };
      }

      function buildEndMessage(finalStats){
        const r = computeEnding(finalStats);

        const taskLines = r.tasks
          .map(t => `- ${t.done ? '✅' : '⬜'} ${t.label}`)
          .join('\n');

        const ach = r.achievements.map(a => `#${a}`).join('  ');
        const resultLine = r.isWin ? '🎉 結果：通關成功（Happy Ending）' : '🌧️ 結果：未通關（Bad Ending）';

        return (
`${resultLine}

【結局稱號】${r.title}

【勝負條件檢核】
存款：${finalStats.money} 元（需 > 0）
任務完成：${r.doneCount}/3（需 ≥ 2）
${taskLines}

【成就標籤】
${ach}

【溫暖小語】
${r.comment}

【你的最終狀態】
- 體力：${finalStats.health}
- 心情：${finalStats.mood}
- 資安：${finalStats.security}

你可以重新開始，再挑戰一次。`
        );
      }

      function resetGame(){
        setScreen('landing');
        setStats({ ...INITIAL_STATS });
        setLogs([]);
        setModal(null);
        setFloating([]);
        setGlitch(false);

        setHasHouse(false);
        setHouseName('');
        setHouseType('');

        setInventory({
          accompaniment_card: false,
          good_citizen_card: false,
          health_insurance: false,
          accident_insurance: false,
          nice_clothes: false,
          new_phone: false
        });

        setBills([]);
        setWheel({ spinning:false, done:false, tier:null, money:0, age:15 });

        setJobSuccessCount(0);
        setResourceSuccessCount(0);
        setHousingEver(false);
        setScamAvoidCount(0);
        setScamHitCount(0);
      }

      // ===== Render screens =====
      function renderLanding(){
        const deg = wheel.spinning ? 720 : 0;
        return (
          <div className={"h-full w-full flex flex-col " + (glitch ? 'glitch-effect' : '')}>
            <div className="p-4">
              <div className="neo-card p-4">
                <div className="pixel-title text-3xl leading-none break-words">自立大冒險</div>
                <div className="text-sm text-slate-700 mt-2 leading-snug break-words">
                  8 週自立模擬：你需要在有限資源下，兼顧生活、身心、資安與支持系統。
                </div>
              </div>
            </div>

            <div className="flex-1 px-4 pb-4">
              <div className="neo-card p-4">
                <div className="flex items-center justify-between gap-3">
                  <div className="font-black text-lg break-words">命運轉盤</div>
                  <div className="text-[12px] text-slate-600 break-words">抽初始金額與年齡</div>
                </div>

                <div className="mt-4 flex items-center justify-center">
                  <div className="relative w-[260px] h-[260px]">
                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 z-10 text-rose-600 font-black">▼</div>

                    <div
                      className="w-full h-full rounded-full neo-shadow bg-white flex items-center justify-center"
                      style={{
                        transform: `rotate(${deg}deg)`,
                        transition: wheel.spinning ? 'transform 2s cubic-bezier(.2,.9,.1,1)' : 'transform .2s ease'
                      }}
                    >
                      <div className="absolute inset-3 rounded-full border-2 border-black overflow-hidden">
                        <div className="absolute inset-0 grid grid-cols-2 grid-rows-2">
                          <div className="bg-emerald-200 border-r-2 border-b-2 border-black flex items-center justify-center">
                            <div className="text-center">
                              <div className="font-black">A</div>
                              <div className="text-[12px] text-slate-700">8000</div>
                            </div>
                          </div>
                          <div className="bg-sky-200 border-b-2 border-black flex items-center justify-center">
                            <div className="text-center">
                              <div className="font-black">B</div>
                              <div className="text-[12px] text-slate-700">6000</div>
                            </div>
                          </div>
                          <div className="bg-amber-200 border-r-2 border-black flex items-center justify-center">
                            <div className="text-center">
                              <div className="font-black">C</div>
                              <div className="text-[12px] text-slate-700">4000</div>
                            </div>
                          </div>
                          <div className="bg-rose-200 flex items-center justify-center">
                            <div className="text-center">
                              <div className="font-black">D/E</div>
                              <div className="text-[12px] text-slate-700">2000/0</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className="w-16 h-16 rounded-full border-2 border-black bg-white flex items-center justify-center neo-shadow">
                        <div className="text-2xl text-slate-900"><IconSpark/></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="mt-4 flex flex-col gap-2">
                  <button className="neo-btn px-4 py-3 font-black text-base bg-emerald-200" onClick={startWheel} disabled={wheel.spinning}>
                    {wheel.spinning ? '轉動中…' : '開始轉盤'}
                  </button>

                  {!wheel.done ? (
                    <div className="text-[12px] text-slate-600 leading-snug break-words">
                      轉盤會抽到 A~E 初始金額，並隨機年齡 15~19。
                    </div>
                  ) : (
                    <div className="neo-card p-3 bg-slate-50">
                      <div className="font-black text-base break-words">身分確認卡</div>
                      <div className="text-[12px] text-slate-700 mt-1 break-words">
                        等級：{wheel.tier}　｜　年齡：{wheel.age}　｜　初始金額：{wheel.money} 元
                      </div>

                      <div className="mt-3">
                        <div className="font-black text-base break-words">第一關：手機密碼</div>
                        <div className="text-[12px] text-slate-700 mt-1 break-words">
                          你要怎麼設定手機安全？（會影響資安）
                        </div>

                        <div className="mt-3 grid grid-cols-1 gap-2">
                          <button className="neo-btn px-4 py-3 font-black bg-rose-200" onClick={()=>choosePassword('weak')}>
                            123456（資安 -20）
                          </button>
                          <button className="neo-btn px-4 py-3 font-black bg-sky-200" onClick={()=>choosePassword('2fa')}>
                            開啟 2FA（資安 +10）
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>

              </div>
            </div>
          </div>
        );
      }

      function renderHome(){
        const lowMood = stats.mood < 30;
        const billsReminder = bills.length > 0;

        return (
          <div className={"h-full w-full flex flex-col " + (glitch ? 'glitch-effect' : '')}>
            <StatBar stats={stats} livingCost={livingCost} />

            <div className="flex-1 scroll-area p-4 space-y-3">
              <div className="neo-card p-4">
                <div className="flex items-start justify-between gap-3">
                  <div className="min-w-0">
                    <div className="font-black text-xl leading-tight break-words">Home</div>
                    <div className="text-[12px] text-slate-700 mt-1 break-words">
                      餘額：<span className="font-black">{stats.money}</span> 元　｜　年齡：<span className="font-black">{stats.age}</span>
                    </div>
                    {hasHouse ? (
                      <div className="text-[12px] text-slate-700 mt-1 break-words">
                        目前住處：<span className="font-black">{houseName}</span>
                      </div>
                    ) : (
                      <div className="text-[12px] text-rose-700 mt-1 break-words font-semibold">
                        目前無住處：漂泊風險提高，可能更容易觸發臨檢事件。
                      </div>
                    )}
                  </div>

                  <div className="shrink-0 text-right">
                    {billsReminder ? (
                      <div className="neo-shadow rounded-2xl px-3 py-2 bg-amber-100 border-2 border-black">
                        <div className="text-[11px] font-black break-words">帳單提醒</div>
                        <div className="text-[11px] text-slate-700 break-words">{bills.length} 筆</div>
                      </div>
                    ) : (
                      <div className="neo-shadow rounded-2xl px-3 py-2 bg-emerald-100 border-2 border-black">
                        <div className="text-[11px] font-black break-words">帳單</div>
                        <div className="text-[11px] text-slate-700 break-words">目前正常</div>
                      </div>
                    )}
                  </div>
                </div>

                {lowMood ? (
                  <div className="mt-3 neo-shadow bg-rose-100 border-2 border-black rounded-2xl px-3 py-2">
                    <div className="text-[12px] font-black text-rose-800 break-words">
                      ⚠ 心情偏低：建議優先休息/諮商/連結資源，避免衝動消費或高風險選擇。
                    </div>
                  </div>
                ) : null}
              </div>

              <div className="grid grid-cols-1 gap-3">
                <AppIcon
                  title="租屋中心"
                  subtitle="看房、簽約、入住（需答對 3 題測驗）"
                  icon={<IconHouse/>}
                  onClick={()=>setScreen('house')}
                />
                <AppIcon
                  title="人力銀行"
                  subtitle="應徵工作（消耗 1 AP，面試 3 題全對才錄取）"
                  icon={<IconBriefcase/>}
                  onClick={()=>setScreen('job')}
                />
                <AppIcon
                  title="資源地圖"
                  subtitle="社福、就服、CCSA 支持、警察局"
                  icon={<IconMap/>}
                  onClick={()=>setScreen('resource')}
                />
                <AppIcon
                  title="財務管家"
                  subtitle="帳單、固定支出、商店、簡易記帳"
                  icon={<IconWallet/>}
                  onClick={()=>setScreen('finance')}
                />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <button className="neo-btn p-3 bg-emerald-200 font-black text-base leading-tight break-words" onClick={advanceWeek}>
                  結束本週<br/><span className="text-[12px] font-bold">進入下一週</span>
                </button>
                <button className="neo-btn p-3 bg-slate-50 font-black text-base leading-tight break-words" onClick={()=>{
                  openMessage('小提示', '自立不只是賺錢：\n1) 先把住處或工作穩住\n2) 早點連結資源\n3) 保護資安避免詐騙');
                }}>
                  小提示<br/><span className="text-[12px] font-bold">策略提醒</span>
                </button>
              </div>

              <div className="terminal p-4">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-black text-sm">SYSTEM LOGS</div>
                  <div className="text-[11px] opacity-90">最近 5 筆</div>
                </div>
                <div className="mt-2 space-y-1 text-[12px] leading-snug break-words">
                  {logs.slice(0,5).map((l, i)=>(
                    <div key={i} className="break-words">• {l}</div>
                  ))}
                  {logs.length === 0 ? <div className="opacity-80">• 尚無紀錄</div> : null}
                </div>
              </div>

            </div>

            {floating.length ? <FloatingTextOverlay items={floating} /> : null}
          </div>
        );
      }

      function TopBack({ title }){
        return (
          <div className="p-3 bg-white/90 backdrop-blur border-b-2 border-black flex items-center gap-2">
            <div className="font-black text-lg break-words flex-1">{title}</div>
            <button className="neo-btn px-3 py-2 text-sm font-black" onClick={()=>setScreen('home')}>
              <span className="inline-flex items-center gap-2"><IconHome/>回家</span>
            </button>
          </div>
        );
      }

      function renderJob(){
        return (
          <div className={"h-full w-full flex flex-col " + (glitch ? 'glitch-effect' : '')}>
            <StatBar stats={stats} livingCost={livingCost} />
            <TopBack title="人力銀行" />
            <div className="flex-1 scroll-area p-4 space-y-3">
              <div className="neo-card p-3 bg-slate-50">
                <div className="text-[12px] text-slate-700 break-words leading-snug">
                  應徵每次消耗 1 AP，面試會出 <span className="font-black">3 題</span>，<span className="font-black">全對</span>才錄取。
                </div>
              </div>

              {JOBS.map(job => {
                const gate = canApplyJob(job);
                const ageOk = gate.ok;
                return (
                  <div key={job.id} className="neo-card p-4">
                    <div className="flex items-start justify-between gap-2">
                      <div className="min-w-0">
                        <div className="font-black text-xl leading-tight break-words">{job.title}</div>
                        <div className="text-[12px] text-slate-700 mt-1 leading-snug break-words">{job.desc}</div>
                        <div className="text-[12px] text-slate-600 mt-2 break-words">
                          時薪 <span className="font-black">{job.wage}</span>｜體力 -{job.energy}｜心情 {job.mood>=0?'+':''}{job.mood}｜年齡 {job.minAge}+
                        </div>
                      </div>
                      <div className="shrink-0 text-right">
                        <div className={"neo-shadow rounded-2xl px-3 py-2 border-2 border-black " + (ageOk ? "bg-emerald-100" : "bg-rose-100")}>
                          <div className="text-[11px] font-black break-words">年齡</div>
                          <div className="text-[11px] break-words">{ageOk ? 'OK' : '不足'}</div>
                        </div>
                        <div className="mt-2 neo-shadow rounded-2xl px-3 py-2 border-2 border-black bg-slate-50">
                          <div className="text-[11px] font-black break-words">AP</div>
                          <div className="text-[11px] break-words">-1</div>
                        </div>
                      </div>
                    </div>

                    <div className="mt-3 flex flex-col gap-2">
                      {!ageOk ? (
                        <div className="text-[12px] text-rose-700 font-semibold break-words">
                          {gate.msg}{hasItem('accompaniment_card') && !job.strictAge ? '（可因陪同卡彈性）' : ''}
                        </div>
                      ) : null}
                      <button className="neo-btn px-4 py-3 font-black bg-emerald-200" onClick={()=>startJobInterview(job)} disabled={!ageOk}>
                        立即應徵（面試 3 題）
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
            {floating.length ? <FloatingTextOverlay items={floating} /> : null}
          </div>
        );
      }

      function renderHouse(){
        return (
          <div className={"h-full w-full flex flex-col " + (glitch ? 'glitch-effect' : '')}>
            <StatBar stats={stats} livingCost={livingCost} />
            <TopBack title="租屋中心" />
            <div className="flex-1 scroll-area p-4 space-y-3">
              <div className="neo-card p-3 bg-slate-50">
                <div className="text-[12px] text-slate-700 break-words leading-snug">
                  預約看房會消耗 <span className="font-black">1 AP</span>，並進入 <span className="font-black">3 題測驗</span>，全對才能租下。<br/>
                  未滿 18 且沒有「社工陪同卡」時，除 CCSA 外多半無法簽約。
                </div>
              </div>

              {hasHouse ? (
                <div className="neo-card p-4 bg-emerald-50">
                  <div className="font-black text-lg break-words">已入住</div>
                  <div className="text-[12px] text-slate-700 mt-1 break-words">
                    住處：<span className="font-black">{houseName}</span>
                  </div>
                  <div className="text-[12px] text-slate-700 mt-1 break-words">
                    提醒：穩定住處能降低風險；若出現赤字且非 CCSA，可能被迫搬離。
                  </div>
                </div>
              ) : null}

              {HOUSING.map(h => (
                <div key={h.id} className="neo-card p-4">
                  <div className="flex items-start justify-between gap-2">
                    <div className="min-w-0">
                      <div className="font-black text-xl leading-tight break-words">{h.title}</div>
                      <div className="text-[12px] text-slate-700 mt-1 leading-snug break-words">{h.desc}</div>
                      <div className="text-[12px] text-slate-600 mt-2 break-words">
                        每週房租 <span className="font-black">{h.rent}</span>｜押金 <span className="font-black">{h.deposit}</span>｜資安 {h.securityDelta>=0?'+':''}{h.securityDelta}
                      </div>
                    </div>
                    <div className="shrink-0 text-right">
                      <div className="neo-shadow rounded-2xl px-3 py-2 border-2 border-black bg-slate-50">
                        <div className="text-[11px] font-black break-words">AP</div>
                        <div className="text-[11px] break-words">-1</div>
                      </div>
                    </div>
                  </div>

                  <div className="mt-3">
                    <button className="neo-btn px-4 py-3 font-black bg-sky-200 w-full" onClick={()=>bookHouseViewing(h)}>
                      預約看房（測驗 3 題）
                    </button>
                  </div>
                </div>
              ))}
            </div>
            {floating.length ? <FloatingTextOverlay items={floating} /> : null}
          </div>
        );
      }

      function ResourceSection({ title, tag, children }){
        return (
          <div className="neo-card p-4">
            <div className="flex items-start justify-between gap-2">
              <div className="font-black text-xl leading-tight break-words">{title}</div>
              <div className="neo-shadow px-3 py-1 rounded-2xl border-2 border-black bg-amber-100 text-[12px] font-black break-words">{tag}</div>
            </div>
            <div className="mt-2">{children}</div>
          </div>
        );
      }

      function ActionBtn({ label, color, onClick, disabled }){
        const bg = color || 'bg-slate-50';
        return (
          <button className={"neo-btn px-3 py-3 font-black w-full leading-tight break-words " + bg} onClick={onClick} disabled={disabled}>
            {label}
          </button>
        );
      }

      function renderResource(){
        return (
          <div className={"h-full w-full flex flex-col " + (glitch ? 'glitch-effect' : '')}>
            <StatBar stats={stats} livingCost={livingCost} />
            <TopBack title="資源地圖" />
            <div className="flex-1 scroll-area p-4 space-y-3">

              <ResourceSection title="就業服務站" tag="就業">
                <div className="text-[12px] text-slate-700 leading-snug break-words">
                  完成就業測驗（3 題全對）可獲得獎勵金 +1000，並提升資安警覺。
                </div>
                <div className="mt-3 grid grid-cols-2 gap-2">
                  <ActionBtn label="就業測驗" color="bg-emerald-200" onClick={()=>doResourceAction('job_test')} />
                  <ActionBtn label="回到 Home" color="bg-slate-50" onClick={()=>setScreen('home')} />
                </div>
              </ResourceSection>

              <ResourceSection title="社會福利中心" tag="協助">
                <div className="text-[12px] text-slate-700 leading-snug break-words">
                  基本支持：體力 +20。<br/>
                  緊急經濟協助：餘額 < 2000 才可申請，成功 +5000。
                </div>
                <div className="mt-3 grid grid-cols-2 gap-2">
                  <ActionBtn label="基本支持" color="bg-amber-200" onClick={()=>doResourceAction('welfare_help')} />
                  <ActionBtn label="緊急補助" color="bg-sky-200" onClick={()=>doResourceAction('finance_help')} />
                </div>
              </ResourceSection>

              <ResourceSection title="CCSA 自立服務" tag="支持">
                <div className="text-[12px] text-slate-700 leading-snug break-words">
                  經濟支持、陪同、諮商與培訓（提升 maxAP）。<br/>
                  申請陪同會消耗 1 AP，獲得「社工陪同卡」。
                </div>
                <div className="mt-3 grid grid-cols-2 gap-2">
                  <ActionBtn label="經濟支持" color="bg-emerald-200" onClick={()=>doResourceAction('ccsa_aid')} />
                  <ActionBtn label={hasItem('accompaniment_card') ? "已擁有陪同卡" : "申請陪同卡"} color="bg-slate-50" onClick={()=>doResourceAction('apply_accompaniment')} disabled={hasItem('accompaniment_card')} />
                  <ActionBtn label="心理諮商" color="bg-amber-200" onClick={()=>doResourceAction('ccsa_counseling')} />
                  <ActionBtn label="自立培訓" color="bg-sky-200" onClick={()=>doResourceAction('ccsa_training')} />
                </div>
              </ResourceSection>

              <ResourceSection title="警察局" tag="規範">
                <div className="text-[12px] text-slate-700 leading-snug break-words">
                  18+ 可申請「良民證明」。未滿 18 需要監護人/法代協助，建議先與社工討論。
                </div>
                <div className="mt-3 grid grid-cols-2 gap-2">
                  <ActionBtn label={hasItem('good_citizen_card') ? "已取得良民證明" : "申請良民證明"} color="bg-slate-50" onClick={()=>doResourceAction('police_good')} disabled={hasItem('good_citizen_card')} />
                  <ActionBtn label="安全提醒" color="bg-rose-200" onClick={()=>{
                    openMessage('安全提醒', '外出務必注意：\n- 不交出帳密/OTP\n- 不點不明連結\n- 遇到求職/投資「保證獲利」先查證\n- 需要時優先連結社工與資源');
                  }} />
                </div>
              </ResourceSection>

            </div>
            {floating.length ? <FloatingTextOverlay items={floating} /> : null}
          </div>
        );
      }

      function renderFinance(){
        return (
          <div className={"h-full w-full flex flex-col " + (glitch ? 'glitch-effect' : '')}>
            <StatBar stats={stats} livingCost={livingCost} />
            <TopBack title="財務管家" />
            <div className="flex-1 scroll-area p-4 space-y-3">
              <div className="neo-card p-4">
                <div className="flex items-start justify-between gap-2">
                  <div className="min-w-0">
                    <div className="font-black text-xl leading-tight break-words">現金餘額</div>
                    <div className="pixel-title text-3xl leading-none break-words">{stats.money} 元</div>
                    <div className="text-[12px] text-slate-700 mt-2 break-words">
                      本週固定支出（基本）：<span className="font-black">{livingCost}</span> 元
                    </div>
                  </div>
                  <button className="neo-btn px-3 py-2 font-black bg-emerald-200" onClick={()=>setModal({ type:'shop' })}>
                    <span className="inline-flex items-center gap-2"><IconCart/>打開商店</span>
                  </button>
                </div>

                <div className="mt-3 neo-card p-3 bg-slate-50">
                  <div className="font-black text-base break-words">未繳帳單</div>
                  <div className="mt-2 space-y-2">
                    {bills.length === 0 ? (
                      <div className="text-[12px] text-slate-600 break-words">目前沒有帳單。</div>
                    ) : (
                      bills.map(b => (
                        <div key={b.id} className="neo-shadow rounded-2xl border-2 border-black bg-white px-3 py-2">
                          <div className="font-black text-[12px] break-words">{b.name}</div>
                          <div className="text-[12px] text-slate-700 break-words">
                            每週扣款：<span className="font-black">{b.weeklyAmount}</span>｜剩餘週數：<span className="font-black">{b.remainingWeeks}</span>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              </div>

              <LedgerTool onAdd={addLedgerEntry} />

              <div className="neo-card p-4">
                <div className="font-black text-lg break-words">道具/狀態</div>
                <div className="mt-2 grid grid-cols-2 gap-2 text-[12px]">
                  <Tag ok={inventory.accompaniment_card} label="社工陪同卡" />
                  <Tag ok={inventory.good_citizen_card} label="良民證明" />
                  <Tag ok={inventory.health_insurance} label="基本醫療保障" />
                  <Tag ok={inventory.accident_insurance} label="意外險" />
                  <Tag ok={inventory.nice_clothes} label="面試新衣" />
                  <Tag ok={inventory.new_phone} label="新手機" />
                </div>
              </div>
            </div>

            {floating.length ? <FloatingTextOverlay items={floating} /> : null}
          </div>
        );
      }

      function Tag({ ok, label }){
        return (
          <div className={"neo-shadow rounded-2xl border-2 border-black px-3 py-2 break-words " + (ok ? "bg-emerald-100" : "bg-slate-50")}>
            <div className="font-black">{ok ? '✅' : '⬜'} {label}</div>
          </div>
        );
      }

      function LedgerTool({ onAdd }){
        const [name, setName] = useState('');
        const [amount, setAmount] = useState('');
        const [type, setType] = useState('expense');

        return (
          <div className="neo-card p-4">
            <div className="font-black text-lg break-words">記帳小工具</div>
            <div className="text-[12px] text-slate-700 mt-1 break-words">
              新增一筆收入/支出（立刻影響餘額，並寫入 LOG）。
            </div>

            <div className="mt-3 grid grid-cols-1 gap-2">
              <input
                className="neo-shadow border-2 border-black rounded-2xl px-3 py-2 text-sm w-full"
                placeholder="名稱（例如：交通、餐費、打工收入）"
                value={name}
                onChange={e=>setName(e.target.value)}
              />
              <div className="grid grid-cols-2 gap-2">
                <select
                  className="neo-shadow border-2 border-black rounded-2xl px-3 py-2 text-sm w-full bg-white"
                  value={type}
                  onChange={e=>setType(e.target.value)}
                >
                  <option value="expense">支出（扣錢）</option>
                  <option value="income">收入（加錢）</option>
                </select>
                <input
                  className="neo-shadow border-2 border-black rounded-2xl px-3 py-2 text-sm w-full"
                  placeholder="金額"
                  value={amount}
                  onChange={e=>setAmount(e.target.value)}
                  inputMode="numeric"
                />
              </div>
              <button
                className="neo-btn px-4 py-3 font-black bg-amber-200"
                onClick={()=>{
                  const n = String(name || '').trim();
                  const v = Number(amount);
                  if(!Number.isFinite(v)){
                    onAdd(n, NaN);
                    return;
                  }
                  const signed = type === 'income' ? Math.abs(v) : -Math.abs(v);
                  onAdd(n, signed);
                  setName('');
                  setAmount('');
                }}
              >
                新增記帳
              </button>
            </div>
          </div>
        );
      }

      // ===== Modals =====
      function renderModalLayer(){
        if(!modal) return null;

        if(modal.type === 'message'){
          return (
            <ModalWrapper
              title={modal.title}
              onClose={()=>{
                const cb = modal.onOk;
                closeModal();
                if(typeof cb === 'function') cb();
              }}
              footer={
                <button className="neo-btn w-full px-4 py-3 font-black bg-emerald-200" onClick={()=>{
                  const cb = modal.onOk;
                  closeModal();
                  if(typeof cb === 'function') cb();
                }}>確認</button>
              }
            >
              <div className="text-sm text-slate-800 whitespace-pre-wrap break-words leading-snug">{modal.message}</div>
            </ModalWrapper>
          );
        }

        if(modal.type === 'quiz'){
          return <QuizModal modal={modal} onClose={closeModal} />;
        }

        if(modal.type === 'interview'){
          return <InterviewModal modal={modal} onClose={closeModal} onPass={(job)=>{
            // pass: money += wage*8; health -= energy; mood += job.mood
            const gain = job.wage * 8;
            applyDelta({ money: gain, health: -job.energy, mood: job.mood });
            setJobSuccessCount(v => v + 1);
            addLog(`面試通過：你獲得工作「${job.title}」，本週收入 +${gain} 元。`);
            closeModal();
          }} onFail={(job)=>{
            applyDelta({ mood: -10 });
            addLog(`面試失敗：你沒有錄取「${job.title}」，心情下降。`);
            closeModal();
          }} />;
        }

        if(modal.type === 'shop'){
          return (
            <ShopModal
              onClose={closeModal}
              onBuy={(item, method)=>buyItem(item, method)}
              stats={stats}
            />
          );
        }

        if(modal.type === 'event'){
          const s = modal.scenario;
          const ctx = {
            stats: prevStatsRef.current,
            hasItem
          };

          function choose(option){
            const out = (option.apply ? option.apply(ctx) : {}) || {};
            const { log, ...delta } = out;

            // heuristics to count scam hit/avoid
            if(typeof delta.money === 'number' && delta.money <= -1500){
              setScamHitCount(v => v + 1);
            }else{
              if(s.id === 'scam_romance' || s.id === 'scam_job'){
                setScamAvoidCount(v => v + 1);
              }
            }

            // support ap delta in event
            if(typeof delta.ap === 'number'){
              // applyDelta can handle ap
              applyDelta(delta);
            }else{
              applyDelta(delta);
            }
            if(log) addLog(log);

            closeModal();
            setScreen('home');
          }

          return (
            <ModalWrapper
              title={s.title}
              onClose={()=>{
                closeModal();
                setScreen('home');
              }}
            >
              <div className="text-sm text-slate-800 leading-snug break-words whitespace-pre-wrap">{s.desc}</div>
              <div className="mt-3 space-y-2">
                {s.options.map((op, i)=>(
                  <button key={i} className="neo-btn w-full px-4 py-3 font-black bg-slate-50 text-left leading-snug break-words" onClick={()=>choose(op)}>
                    {op.label}
                  </button>
                ))}
              </div>
              <div className="mt-3 text-[12px] text-slate-600 break-words">
                小提醒：資安越高，越能避開詐騙與風險；心情過低時，容易做出衝動決策。
              </div>
            </ModalWrapper>
          );
        }

        return null;
      }

      function QuizModal({ modal, onClose }){
        const { questions, hint, onPass, onFail } = modal;
        const [answers, setAnswers] = useState(() => Array(questions.length).fill(null));

        const allAnswered = answers.every(a => a !== null);

        function submit(){
          if(!allAnswered){
            openMessage('尚未完成', '請先回答全部題目。');
            return;
          }
          const ok = questions.every((q, i) => answers[i] === q.answer);
          if(ok){
            if(typeof onPass === 'function') onPass();
          }else{
            if(typeof onFail === 'function') onFail();
          }
        }

        return (
          <ModalWrapper
            title={modal.title}
            onClose={onClose}
            footer={
              <div className="flex gap-2">
                <button className="neo-btn flex-1 px-4 py-3 font-black bg-slate-50" onClick={onClose}>取消</button>
                <button className="neo-btn flex-1 px-4 py-3 font-black bg-emerald-200" onClick={submit}>送出</button>
              </div>
            }
          >
            {hint ? (
              <div className="neo-shadow bg-amber-100 border-2 border-black rounded-2xl px-3 py-2 text-[12px] font-black break-words">
                {hint}
              </div>
            ) : null}

            <div className="mt-3 space-y-3">
              {questions.map((q, idx)=>(
                <div key={idx} className="neo-shadow bg-white border-2 border-black rounded-2xl p-3">
                  <div className="font-black text-sm leading-snug break-words">Q{idx+1}. {q.q}</div>
                  <div className="mt-2 grid grid-cols-1 gap-2">
                    {q.options.map((op, oi)=>(
                      <label key={oi} className={"neo-btn px-3 py-2 text-sm font-bold leading-snug break-words cursor-pointer " + (answers[idx]===oi ? "bg-sky-200" : "bg-slate-50")}>
                        <input
                          type="radio"
                          name={`q_${idx}`}
                          className="mr-2"
                          checked={answers[idx]===oi}
                          onChange={()=>setAnswers(prev=>{
                            const next = [...prev];
                            next[idx] = oi;
                            return next;
                          })}
                        />
                        {op}
                      </label>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-3 text-[12px] text-slate-600 break-words">
              完成度：{answers.filter(a=>a!==null).length}/{questions.length}
            </div>
          </ModalWrapper>
        );
      }

      function InterviewModal({ modal, onClose, onPass, onFail }){
        const { job, questions } = modal;
        const [answers, setAnswers] = useState(() => Array(questions.length).fill(null));
        const allAnswered = answers.every(a => a !== null);

        function submit(){
          if(!allAnswered){
            openMessage('尚未完成', '面試共有 3 題，請全部作答。');
            return;
          }
          const ok = questions.every((q, i) => answers[i] === q.answer);
          if(ok){
            if(typeof onPass === 'function') onPass(job);
          }else{
            if(typeof onFail === 'function') onFail(job);
          }
        }

        return (
          <ModalWrapper
            title={`面試：${job.title}`}
            onClose={onClose}
            footer={
              <div className="flex gap-2">
                <button className="neo-btn flex-1 px-4 py-3 font-black bg-slate-50" onClick={onClose}>取消</button>
                <button className="neo-btn flex-1 px-4 py-3 font-black bg-emerald-200" onClick={submit}>送出</button>
              </div>
            }
          >
            <div className="neo-shadow bg-slate-50 border-2 border-black rounded-2xl px-3 py-2 text-[12px] break-words leading-snug">
              提醒：面試會出 <span className="font-black">3 題</span>，<span className="font-black">全對</span>才錄取。<br/>
              錄取後：收入 +{job.wage*8} 元｜體力 -{job.energy}｜心情 {job.mood>=0?'+':''}{job.mood}
            </div>

            <div className="mt-3 space-y-3">
              {questions.map((q, idx)=>(
                <div key={idx} className="neo-shadow bg-white border-2 border-black rounded-2xl p-3">
                  <div className="font-black text-sm leading-snug break-words">Q{idx+1}. {q.q}</div>
                  <div className="mt-2 grid grid-cols-1 gap-2">
                    {q.options.map((op, oi)=>(
                      <label key={oi} className={"neo-btn px-3 py-2 text-sm font-bold leading-snug break-words cursor-pointer " + (answers[idx]===oi ? "bg-amber-200" : "bg-slate-50")}>
                        <input
                          type="radio"
                          name={`iq_${idx}`}
                          className="mr-2"
                          checked={answers[idx]===oi}
                          onChange={()=>setAnswers(prev=>{
                            const next = [...prev];
                            next[idx] = oi;
                            return next;
                          })}
                        />
                        {op}
                      </label>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-3 text-[12px] text-slate-600 break-words">
              完成度：{answers.filter(a=>a!==null).length}/{questions.length}
            </div>
          </ModalWrapper>
        );
      }

      function ShopModal({ onClose, onBuy, stats }){
        const [method, setMethod] = useState('cash');

        return (
          <ModalWrapper
            title="商店"
            onClose={onClose}
            footer={
              <button className="neo-btn w-full px-4 py-3 font-black bg-slate-50" onClick={onClose}>返回</button>
            }
          >
            <div className="neo-shadow bg-slate-50 border-2 border-black rounded-2xl px-3 py-2 text-[12px] break-words leading-snug">
              付款方式：
              <select
                className="ml-2 border-2 border-black rounded-xl px-2 py-1 bg-white text-[12px]"
                value={method}
                onChange={e=>setMethod(e.target.value)}
              >
                {PAY_METHODS.map(m => (
                  <option key={m.key} value={m.key}>
                    {m.label}{m.ageMin ? `（${m.ageMin}+）` : ''}
                  </option>
                ))}
              </select>
              <div className="mt-2 break-words">
                現金：立即扣款｜信用卡：下週扣｜分期後付：總價 +20% 分 4 週扣
              </div>
            </div>

            <div className="mt-3 space-y-3">
              {SHOP_ITEMS.map(it => {
                const disabledByMoney = (method === 'cash' && stats.money < it.price && !it.scam);
                const disabledByAge = (it.ageMin && stats.age < it.ageMin) || (PAY_METHODS.find(x=>x.key===method)?.ageMin && stats.age < PAY_METHODS.find(x=>x.key===method).ageMin);
                const disabled = disabledByMoney || disabledByAge;

                return (
                  <div key={it.id} className="neo-shadow bg-white border-2 border-black rounded-2xl p-3">
                    <div className="flex items-start justify-between gap-2">
                      <div className="min-w-0">
                        <div className="font-black text-base leading-tight break-words">{it.title}</div>
                        <div className="text-[12px] text-slate-700 mt-1 break-words leading-snug">{it.desc}</div>
                        <div className="text-[12px] text-slate-600 mt-2 break-words">
                          價格：<span className="font-black">{it.price}</span> 元
                          {it.scam ? <span className="ml-2 text-rose-700 font-black">（疑似詐騙）</span> : null}
                        </div>
                      </div>
                      <button className={"neo-btn px-3 py-2 font-black " + (it.scam ? "bg-rose-200" : "bg-emerald-200")} disabled={disabled} onClick={()=>onBuy(it, method)}>
                        購買
                      </button>
                    </div>

                    {(it.ageMin && stats.age < it.ageMin) ? (
                      <div className="mt-2 text-[12px] text-rose-700 font-semibold break-words">
                        年齡限制：{it.ageMin}+ 才能購買。
                      </div>
                    ) : null}

                    {(PAY_METHODS.find(x=>x.key===method)?.ageMin && stats.age < PAY_METHODS.find(x=>x.key===method).ageMin) ? (
                      <div className="mt-2 text-[12px] text-rose-700 font-semibold break-words">
                        付款方式年齡限制：{PAY_METHODS.find(x=>x.key===method).ageMin}+。
                      </div>
                    ) : null}

                    {disabledByMoney ? (
                      <div className="mt-2 text-[12px] text-rose-700 font-semibold break-words">
                        現金不足：請改用其他方式或先增加收入。
                      </div>
                    ) : null}
                  </div>
                );
              })}
            </div>
          </ModalWrapper>
        );
      }

      // ===== Main render switch =====
      let content = null;
      if(screen === 'landing') content = renderLanding();
      if(screen === 'home') content = renderHome();
      if(screen === 'job') content = renderJob();
      if(screen === 'house') content = renderHouse();
      if(screen === 'resource') content = renderResource();
      if(screen === 'finance') content = renderFinance();

      // Restart button in corner (only after start)
      const showRestart = screen !== 'landing';

      return (
        <div className="min-h-screen flex items-center justify-center px-4 py-6">
          <div className="phone-shell">
            <div className="phone-notch"></div>
            <div className="side-btn left1"></div>
            <div className="side-btn left2"></div>
            <div className="side-btn right1"></div>

            <div className="screen">
              <div className="absolute inset-0">
                {content}
                {renderModalLayer()}
                {showRestart ? (
                  <div className="absolute top-2 right-2 z-30">
                    <button className="neo-btn px-3 py-2 text-xs font-black bg-white" onClick={()=>{
                      openMessage('重新開始', '確定要重新開始嗎？（目前進度會清空）', ()=>{
                        resetGame();
                      });
                    }}>
                      重新開始
                    </button>
                  </div>
                ) : null}
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

</body>
</html>
