<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>自立大冒險 - 自立生活模擬器</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 / ReactDOM 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel standalone -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --neo-stroke: 3px;
      --neo-shadow: 6px;
      --ink: #111827;
      --paper: #ffffff;
      --bg: #0b1220;
      --bg2: #0a1a2d;
      --scan: rgba(255,255,255,0.06);
      --danger: #ef4444;
      --ok: #22c55e;
    }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 30% 20%, rgba(37,99,235,0.22), transparent 55%),
                  radial-gradient(900px 500px at 80% 40%, rgba(20,184,166,0.12), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      overflow: hidden;
    }
    .font-pixel{ font-family: "VT323", monospace; letter-spacing: 0.2px; }
    .neo-card{
      background: var(--paper);
      border: var(--neo-stroke) solid #000;
      border-radius: 18px;
      box-shadow: var(--neo-shadow) var(--neo-shadow) 0 #000;
    }
    .neo-card-soft{
      background: var(--paper);
      border: 2px solid #000;
      border-radius: 16px;
      box-shadow: 4px 4px 0 #000;
    }
    .neo-btn{
      border: 2px solid #000;
      border-radius: 14px;
      box-shadow: 4px 4px 0 #000;
      transform: translate(0,0);
      transition: transform 90ms ease, box-shadow 90ms ease, filter 120ms ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .neo-btn:active{
      transform: translate(3px,3px);
      box-shadow: 1px 1px 0 #000;
      filter: brightness(0.97);
    }
    .neo-chip{
      border: 2px solid #000;
      border-radius: 999px;
      box-shadow: 3px 3px 0 #000;
      padding: 6px 10px;
      background: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      max-width: 100%;
    }
    .scanlines{
      pointer-events: none;
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.0) 0px,
        rgba(255,255,255,0.0) 3px,
        var(--scan) 4px,
        rgba(255,255,255,0.0) 6px
      );
      opacity: 0.5;
      mix-blend-mode: overlay;
    }
    .glitch{
      animation: glitchFlash 0.16s linear 0s 3;
    }
    @keyframes glitchFlash{
      0%{ filter: contrast(1) saturate(1); transform: translate(0,0); }
      25%{ filter: contrast(1.2) saturate(1.2); transform: translate(1px,-1px); }
      50%{ filter: contrast(0.9) saturate(1.3); transform: translate(-1px,1px); }
      75%{ filter: contrast(1.15) saturate(0.95); transform: translate(1px,0px); }
      100%{ filter: contrast(1) saturate(1); transform: translate(0,0); }
    }
    .modal-pop{
      animation: popIn 180ms ease-out;
    }
    @keyframes popIn{
      0%{ transform: translateY(10px) scale(0.98); opacity: 0; }
      100%{ transform: translateY(0) scale(1); opacity: 1; }
    }
    .float-text{
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-family: "VT323", monospace;
      font-size: 28px;
      border: 2px solid #000;
      border-radius: 999px;
      box-shadow: 3px 3px 0 #000;
      padding: 2px 10px;
      background: #fff;
      pointer-events: none;
      opacity: 0;
      animation: floatUp 900ms ease-out forwards;
      max-width: 90%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @keyframes floatUp{
      0%{ opacity: 0; transform: translate(-50%, 8px); }
      20%{ opacity: 1; }
      100%{ opacity: 0; transform: translate(-50%, -34px); }
    }
    .phone-shell{
      width: min(420px, 94vw);
      height: min(820px, 92vh);
      position: relative;
      border-radius: 44px;
      background: linear-gradient(180deg, #0a0f1a, #0b1730);
      border: 4px solid rgba(255,255,255,0.10);
      box-shadow: 0 20px 50px rgba(0,0,0,0.55);
      overflow: hidden;
    }
    .phone-glass{
      position: absolute;
      inset: 12px;
      border-radius: 36px;
      background: #111827;
      border: 3px solid rgba(255,255,255,0.12);
      overflow: hidden;
    }
    .notch{
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 170px;
      height: 28px;
      background: #0b0f18;
      border-radius: 0 0 18px 18px;
      border: 2px solid rgba(255,255,255,0.08);
      z-index: 40;
    }
    .side-btn{
      position: absolute;
      width: 6px;
      height: 56px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
    }
    .side-btn.left1{ left: 6px; top: 140px; }
    .side-btn.left2{ left: 6px; top: 210px; height: 42px; }
    .side-btn.right1{ right: 6px; top: 170px; height: 74px; }

    .screen{
      position: absolute;
      inset: 18px;
      border-radius: 30px;
      background: #f3f4f6;
      overflow: hidden;
    }
    .screen-inner{
      position: relative;
      height: 100%;
      background: #f9fafb;
      overflow: hidden;
    }
    .screen-scroll{
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .screen-scroll::-webkit-scrollbar{ width: 10px; }
    .screen-scroll::-webkit-scrollbar-thumb{
      background: rgba(0,0,0,0.35);
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.65);
    }

    .statbar{
      position: sticky;
      top: 0;
      z-index: 30;
      background: rgba(249,250,251,0.92);
      backdrop-filter: blur(6px);
      border-bottom: 3px solid #000;
    }
    .mono-log{
      background: #052e1a;
      color: #bbf7d0;
      border: 3px solid #000;
      border-radius: 18px;
      box-shadow: 6px 6px 0 #000;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.35;
    }
    .muted{
      color: rgba(17,24,39,0.74);
    }
    .safe-wrap{
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    /* error panel */
    #error-message{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      z-index: 9999;
      display: none;
      background: #ffe4e6;
      border: 3px solid #991b1b;
      color: #7f1d1d;
      border-radius: 14px;
      box-shadow: 8px 8px 0 #000;
      padding: 12px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      max-height: 35vh;
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>

  <script>
    (function(){
      function showError(text){
        var el = document.getElementById('error-message');
        if(!el) return;
        el.style.display = 'block';
        el.textContent = text;
      }
      window.onerror = function(message, source, lineno, colno, error){
        var msg = "⚠️ 捕捉到錯誤 (window.onerror)\n\n" +
                  String(message || "未知錯誤") + "\n" +
                  "來源：" + String(source || "") + "\n" +
                  "行：" + String(lineno || 0) + " 列：" + String(colno || 0) + "\n\n" +
                  (error && error.stack ? String(error.stack) : "");
        showError(msg);
        return false;
      };
      window.onunhandledrejection = function(event){
        var reason = event && event.reason ? event.reason : "未知 Promise 錯誤";
        var msg = "⚠️ 捕捉到錯誤 (unhandledrejection)\n\n" +
                  (reason && reason.stack ? String(reason.stack) : String(reason));
        showError(msg);
      };
    })();
  </script>
</head>

<body>
  <div id="root"></div>
  <div id="error-message"></div>

  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useRef, useState } = React;

    /***********************
     * 資料：可直接調整
     ***********************/
    const INITIAL_STATS = {
      money: 0,
      health: 100,
      mood: 60,
      security: 60,
      week: 1,
      maxWeeks: 8,
      age: 16,
      ap: 3,
      maxAp: 3
    };

    // 命運轉盤：A~E
    const CHARACTER_ORIGINS = [
      { key: "A", label: "等級 A（資源較少）", money: 0,    prob: 0.10 },
      { key: "B", label: "等級 B（一般）",     money: 2000, prob: 0.30 },
      { key: "C", label: "等級 C（一般偏穩）", money: 4000, prob: 0.30 },
      { key: "D", label: "等級 D（相對穩定）", money: 6000, prob: 0.20 },
      { key: "E", label: "等級 E（起點優勢）", money: 8000, prob: 0.10 },
    ];

    const GENERIC_JOB_QUESTIONS = [
      {
        q: "面試時遇到不確定的問題，你較好的回應是？",
        options: ["亂回答帶過", "承認不確定，提出你會如何查證", "直接沉默", "把問題丟回對方"],
        a: 1
      },
      {
        q: "被問到缺點，你較合適的回答是？",
        options: ["我沒有缺點", "講一個可改善的缺點，並說明你如何調整", "一直抱怨前主管", "隨便說都可以"],
        a: 1
      },
      {
        q: "入職前要注意的資安觀念是？",
        options: ["把帳密分享給同事比較快", "用簡單密碼 123456", "開啟雙重驗證、避免公開個資", "隨便點工作群組連結"],
        a: 2
      },
      {
        q: "打工合約你最該先確認？",
        options: ["是否提供免費飲料", "工時、薪資、加班、休假與責任", "主管脾氣", "能不能請很多假"],
        a: 1
      },
      {
        q: "通勤太遠影響出勤，你可以？",
        options: ["硬撐到遲到", "提前出門、調整交通方案並跟主管說明", "直接消失不去上班", "怪公司地點不好"],
        a: 1
      }
    ];

    // 工作清單（至少 8）
    const JOBS = [
      {
        id: "flyer",
        title: "派報／傳單",
        desc: "走路多、日曬雨淋，適合短期賺錢。",
        wage: 190,
        energy: 10,
        mood: -2,
        minAge: 15,
        strictAge: false,
        apCost: 1,
        interviews: [
          {
            q: "遇到路人拒絕拿傳單，你第一步會？",
            options: ["先反駁", "先禮貌致意並回報主管", "直接丟掉", "把路人趕走"],
            a: 1
          }
        ]
      },
      {
        id: "convenience",
        title: "超商店員",
        desc: "輪班、要記流程，服務態度很重要。",
        wage: 185,
        energy: 12,
        mood: -1,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        interviews: [
          {
            q: "客人抱怨時，較好的處理是？",
            options: ["跟他吵", "先聽完、致歉並找主管/依流程處理", "直接不理", "反問他是不是想找麻煩"],
            a: 1
          }
        ]
      },
      {
        id: "construction",
        title: "工地助手",
        desc: "體力活，薪水較高，但安全與年齡限制更嚴。",
        wage: 230,
        energy: 20,
        mood: -3,
        minAge: 18,
        strictAge: true,
        apCost: 1,
        interviews: [
          {
            q: "安全帽與防護裝備的態度應該是？",
            options: ["覺得麻煩不想戴", "看心情戴", "一定要穿戴，遵守安全規範", "主管不在就不用"],
            a: 2
          }
        ]
      },
      {
        id: "tutor",
        title: "補習班助教",
        desc: "需要耐心與溝通，適合喜歡小孩與教學的人。",
        wage: 200,
        energy: 8,
        mood: +3,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        interviews: [
          {
            q: "小朋友分心時，你會？",
            options: ["罵到他哭", "用簡短目標與鼓勵拉回注意", "放著不管", "叫他去外面罰站很久"],
            a: 1
          }
        ]
      },
      {
        id: "restaurant",
        title: "餐飲外場",
        desc: "忙碌、要記單，常遇到客訴與尖峰時段。",
        wage: 180,
        energy: 14,
        mood: -1,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        interviews: [
          {
            q: "尖峰時段忙不過來，你應該？",
            options: ["直接放棄", "先分優先順序，並主動求援", "怪同事", "開始滑手機"],
            a: 1
          }
        ]
      },
      {
        id: "delivery",
        title: "外送（腳踏車）",
        desc: "彈性，但要注意交通安全與時間管理。",
        wage: 175,
        energy: 15,
        mood: 0,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        interviews: [
          {
            q: "外送途中遇到大雨，你會？",
            options: ["硬衝闖紅燈", "評估安全、通知客服/客人延遲", "直接消失", "把餐點隨便放路邊"],
            a: 1
          }
        ]
      },
      {
        id: "sampling",
        title: "賣場試吃推廣",
        desc: "需要開口與整理攤位，溝通表達很重要。",
        wage: 190,
        energy: 10,
        mood: +1,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        interviews: [
          {
            q: "推廣時遇到冷場，你可以？",
            options: ["開始抱怨", "調整開場句、主動邀請但不打擾", "一直逼人吃", "直接收攤"],
            a: 1
          }
        ]
      },
      {
        id: "gas",
        title: "加油站工讀",
        desc: "站立久、要注意安全與找零。",
        wage: 185,
        energy: 13,
        mood: -1,
        minAge: 16,
        strictAge: false,
        apCost: 1,
        interviews: [
          {
            q: "找零最重要的習慣是？",
            options: ["憑感覺", "每次都口頭確認金額並當場點清", "交給同事算", "先把錢塞口袋再說"],
            a: 1
          }
        ]
      }
    ];

    // 租屋清單（至少 8）
    const HOUSING = [
      {
        id: "ccsa",
        title: "CCSA 自立宿舍",
        type: "ccsa",
        desc: "相對安全、可連結支持，但有規範與面談。",
        rent: 0,
        deposit: 0,
        securityDelta: +15,
        quizType: "ccsa_interview"
      },
      {
        id: "rooftop",
        title: "頂樓加蓋雅房",
        type: "rooftop",
        desc: "租金便宜但安全與合法性需留意。",
        rent: 3500,
        deposit: 7000,
        securityDelta: -8,
        quizType: "house_check"
      },
      {
        id: "basement",
        title: "地下室套房",
        type: "basement",
        desc: "潮濕與逃生風險，務必確認消防與採光。",
        rent: 4200,
        deposit: 8400,
        securityDelta: -10,
        quizType: "house_check"
      },
      {
        id: "shared",
        title: "合租雅房",
        type: "shared",
        desc: "費用較低，但要確認室友規則與合約。",
        rent: 5000,
        deposit: 10000,
        securityDelta: -3,
        quizType: "contract_check"
      },
      {
        id: "dorm",
        title: "青年旅宿床位",
        type: "dorm",
        desc: "短期過渡，隱私較少，安全要自顧。",
        rent: 3000,
        deposit: 3000,
        securityDelta: -5,
        quizType: "rule_check"
      },
      {
        id: "relative",
        title: "親戚借住（客廳一角）",
        type: "relative",
        desc: "省錢但界線與規則要談清楚。",
        rent: 1000,
        deposit: 0,
        securityDelta: +2,
        quizType: "relative_check"
      },
      {
        id: "coliving",
        title: "共居空間（Co-living）",
        type: "coliving",
        desc: "相對舒適，但租金較高；注意合約與費用。",
        rent: 6500,
        deposit: 13000,
        securityDelta: +2,
        quizType: "contract_check"
      },
      {
        id: "studio",
        title: "小套房（獨立套房）",
        type: "studio",
        desc: "隱私高但壓力也高；需穩定收入。",
        rent: 7500,
        deposit: 15000,
        securityDelta: +1,
        quizType: "contract_check"
      }
    ];

    // 商店（必做：包含詐騙品項）
    const SHOP_ITEMS = [
      { id:"bento", title:"便當", price:120, desc:"補充體力，心情小幅回升。", effect:{ health:+5, mood:+2 } },
      { id:"nhicard", title:"健保（補辦證件費）", price:300, desc:"辦好證件更安心。", effect:{ security:+3 } },
      { id:"acc_ins", title:"意外險（保險）", price:600, desc:"遇到意外/事故較能過關。", effect:{}, grantItem:"insurance" },
      { id:"bvit", title:"B 群", price:250, desc:"精神比較好。", effect:{ health:+8 } },
      { id:"drink", title:"手搖飲", price:70, desc:"當下爽，但錢會少。", effect:{ mood:+6 } },
      { id:"clothes", title:"新衣服", price:800, desc:"外表整潔有助自信。", effect:{ mood:+10, security:+2 } },
      { id:"concert", title:"演唱會", price:2000, desc:"放鬆一下，但要衡量支出。", effect:{ mood:+18, health:+3 } },
      { id:"iphone", title:"iPhone（分期誘惑）", price:28000, desc:"如果沒規劃，容易負債壓力上升。", effect:{ mood:+8, security:-2 } },
      { id:"stock_scam", title:"飆股內線（詐騙）", price:5000, desc:"聽起來很賺，其實是陷阱。", effect:{}, scam:true }
    ];

    // 題庫（包含各種測驗）
    const QUIZ_DB = {
      password: [
        { q:"手機密碼的好習慣是？", options:["用生日/123456", "每個月改一次弱密碼", "使用長密碼並開啟 2FA", "把密碼貼在手機背面"], a:2 }
      ],
      job_test: [
        { q:"收到「點連結領獎金」的訊息，你應該？", options:["立刻點", "先查證來源、不要亂點", "轉傳給所有朋友", "提供身分證給他"], a:1 },
        { q:"面試要帶什麼？", options:["什麼都不帶", "履歷/證件、筆記、提前到", "只帶手機", "帶很多零食"], a:1 },
        { q:"工作群組要你提供 OTP，你應該？", options:["立刻給", "不提供，並確認是否詐騙", "貼上公開", "把帳密一起給"], a:1 }
      ],
      house_check: [
        { q:"看房時最重要要確認？", options:["窗簾顏色", "逃生動線/消防/採光與安全", "房東星座", "附近有沒有手搖"], a:1 },
        { q:"遇到『先匯押金才給看房』你應該？", options:["先匯再說", "拒絕並查證，避免詐騙", "借錢匯", "把帳密給房東"], a:1 },
        { q:"頂樓加蓋/地下室常見風險？", options:["沒有風險", "合法且安全", "漏水、逃生、消防與合法性問題", "只會比較熱"], a:2 }
      ],
      contract_check: [
        { q:"簽約前你應該？", options:["不看就簽", "確認租金、押金、期限、退租條件", "只看圖片", "先付錢再拿合約"], a:1 },
        { q:"合租最該先談？", options:["誰比較帥", "打掃、費用分攤、訪客規則", "誰的手機型號", "要不要天天聚餐"], a:1 },
        { q:"房東要求提供銀行 OTP，你應該？", options:["提供比較快", "拒絕並保護帳戶", "拍照上傳身分證正反面", "把密碼寫給他"], a:1 }
      ],
      rule_check: [
        { q:"青年旅宿/宿舍你要注意？", options:["完全不用管", "作息、財物保管、出入與安全規範", "只要有床就好", "把包包放走道"], a:1 },
        { q:"共用空間最好的習慣？", options:["用完不收", "用完清潔與尊重他人", "把垃圾丟別人房門", "製造噪音"], a:1 },
        { q:"陌生室友邀你掃碼領錢，你應該？", options:["立刻掃", "先拒絕、查證、保護個資", "把手機借他", "把銀行帳密給他"], a:1 }
      ],
      relative_check: [
        { q:"親戚借住最重要要先談？", options:["不要談比較好", "界線、規則、生活費分攤、期限", "先買很多東西", "能不能天天晚歸"], a:1 },
        { q:"借住期間你應該？", options:["完全不幫忙", "維持基本家務與尊重", "天天吵架", "把家裡密碼公開"], a:1 },
        { q:"親戚要你提供網銀資料『幫你理財』？", options:["給他", "婉拒，必要時尋求社工/專業協助", "把 OTP 也給", "把卡片交給他"], a:1 }
      ],
      ccsa_interview: [
        { q:"CCSA 自立宿舍面談時，較好的態度是？", options:["隨便說都可以", "誠實說明需求與目標，願意配合規範", "一直嗆人", "只想拿錢"], a:1 },
        { q:"宿舍規範的意義是？", options:["限制自由", "建立安全、穩定與自立習慣", "只是形式", "可以不用遵守"], a:1 },
        { q:"遇到壓力時，你願意？", options:["自己撐到爆", "適時求助與練習調節", "用酒解決", "離家出走"], a:1 }
      ],
      welfare_help: [
        { q:"社福中心可提供什麼？", options:["只有罵人", "資源評估、補助轉介、支持服務", "買股票", "幫你改命"], a:1 },
        { q:"你要帶什麼去申請？", options:["不需要", "基本證件/狀況說明/可佐證資料", "只有手機", "只要講可憐就好"], a:1 }
      ],
      finance_help: [
        { q:"財務補助最重要原則？", options:["拿到就花", "用在必要支出與穩定生活", "全部買娛樂", "借給朋友"], a:1 },
        { q:"遇到緊急缺口時，你可以？", options:["躲起來", "求助社福/社工並評估計畫", "借高利貸", "賣帳戶"], a:1 }
      ],
      ccsa_aid: [
        { q:"經濟支持要怎麼用？", options:["衝動消費", "先付必要支出，保留緊急預備金", "全部請客", "買內線股"], a:1 },
        { q:"與社工合作的好處？", options:["沒有", "一起規劃、降低風險、連結資源", "讓你不用努力", "可以幫你報復"], a:1 }
      ],
      ccsa_counseling: [
        { q:"心情很低落時，你可以先做？", options:["一直忍", "先覺察身體/情緒並找可支持的人談", "去做危險事", "把自己鎖起來"], a:1 },
        { q:"諮商的目標是？", options:["馬上變完美", "更理解自己、學調節與求助", "拿到很多錢", "不用上班"], a:1 }
      ],
      ccsa_training: [
        { q:"自立培訓最像？", options:["考運氣", "練習技能、建立習慣與規劃", "賭一把", "躺平"], a:1 },
        { q:"提升 AP（行動力）代表？", options:["更能做選擇與承擔", "可以亂花錢", "可以不睡覺", "不用規劃"], a:0 }
      ]
    };

    // 事件場景池
    const SCENARIOS = {
      friend_loan: {
        id: "friend_loan",
        title: "朋友借錢",
        desc: "朋友說臨時週轉，想借你一筆錢。你怎麼辦？",
        choices: [
          { label: "借 1000（不寫借據）", effect: (s)=>({ money: -1000, mood: -3, security: -3 }), log:"你借了 1000 給朋友（無借據），心裡有點不安。" },
          { label: "婉拒並建議他找正式管道", effect: (s)=>({ mood: +2, security: +2 }), log:"你婉拒借錢，並建議朋友尋求正式協助。" },
          { label: "借 500（留訊息/轉帳備註）", effect: (s)=>({ money: -500, mood: -1, security: +1 }), log:"你借了 500 並留下紀錄，風險較低。" },
        ]
      },
      scam_romance: {
        id: "scam_romance",
        title: "交友詐騙（戀愛）",
        desc: "網路上認識的人說要跟你交往，但希望你先幫忙『代付』。",
        threshold: 55,
        pass: { delta:{ mood:+1, security:+5 }, log:"你察覺可疑，拒絕代付並封鎖對方。" },
        fail: { delta:{ money:-2000, mood:-15, security:-8 }, log:"你被甜言蜜語說服，代付後對方消失了。" }
      },
      scam_job: {
        id: "scam_job",
        title: "求職詐騙",
        desc: "對方說『高薪立即入職』，但要你先提供帳戶與 OTP。",
        threshold: 60,
        pass: { delta:{ security:+6, mood:+1 }, log:"你拒絕提供帳戶/OTP，並查證後發現是詐騙。" },
        fail: { delta:{ money:-3000, mood:-12, security:-10 }, log:"你提供了資料，帳戶被盜用，損失一筆錢。" }
      },
      accident: {
        id: "accident",
        title: "小意外",
        desc: "你在路上摔倒受傷，需要處理醫療或休養。",
        pass: { delta:{ health:-5, mood:-2 }, log:"你有保險/準備，損失較小，休息後恢復。" },
        fail: { delta:{ health:-15, mood:-8, money:-1200 }, log:"你沒有保險，醫療支出讓你壓力上升。" }
      },
      sickness: {
        id: "sickness",
        title: "生病了",
        desc: "你感冒發燒，影響生活與出勤。",
        pass: { delta:{ health:+3, mood:-2, money:-300 }, log:"你及時就醫與休息，恢復得比較快。" },
        fail: { delta:{ health:-18, mood:-10, money:-800 }, log:"你硬撐不就醫，狀況變差又花了更多錢。" }
      },
      police: {
        id: "police",
        title: "臨檢／警察關心",
        desc: "你被臨檢詢問。如何回應會影響你的情緒與行動力。",
        apply: (s)=>{
          const hasCard = !!(s.items && s.items.good_citizen_card);
          if(s.age >= 18 && hasCard){
            return { delta:{ mood:+2, security:+2, ap: 0 }, log:"你有良民證且年滿 18，過程順利，安全感提升。" };
          }
          if(s.age >= 18 && !hasCard){
            return { delta:{ mood:-4, security:-2, ap: -1 }, log:"你年滿 18，但沒有相關證明，過程有點緊張（AP-1）。" };
          }
          // 未滿 18
          return { delta:{ mood:-6, security:-3, ap: -1 }, log:"你未滿 18，臨檢讓你很緊張（AP-1）。若有陪同/支持系統會更好。" };
        }
      }
    };

    /***********************
     * 工具函式
     ***********************/
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1; i>0; i--){
        const j = Math.floor(Math.random() * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function pickWeighted(items){
      const total = items.reduce((sum, it)=>sum + (it.weight || 0), 0);
      if(total <= 0) return items[0];
      let r = Math.random() * total;
      for(const it of items){
        r -= (it.weight || 0);
        if(r <= 0) return it;
      }
      return items[items.length-1];
    }

    function formatMoney(n){
      const v = Math.round(Number(n||0));
      const sign = v < 0 ? "-" : "";
      const abs = Math.abs(v);
      return sign + "$" + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function nowId(){
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function safeText(s){ return (s===null || s===undefined) ? "" : String(s); }

    /***********************
     * SVG Icons（內建）
     ***********************/
    function IconWrapper({children}){
      return (
        <svg viewBox="0 0 24 24" className="w-7 h-7" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          {children}
        </svg>
      );
    }
    const IconHome = ()=>(
      <IconWrapper>
        <path d="M3 10.5L12 3l9 7.5" />
        <path d="M5 10v10h14V10" />
        <path d="M9 20v-7h6v7" />
      </IconWrapper>
    );
    const IconHouse = ()=>(
      <IconWrapper>
        <path d="M4 11l8-7 8 7" />
        <path d="M6 10v10h12V10" />
        <path d="M10 20v-6h4v6" />
      </IconWrapper>
    );
    const IconJob = ()=>(
      <IconWrapper>
        <rect x="4" y="7" width="16" height="13" rx="2" />
        <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" />
        <path d="M4 12h16" />
      </IconWrapper>
    );
    const IconMap = ()=>(
      <IconWrapper>
        <path d="M3 6l6-2 6 2 6-2v14l-6 2-6-2-6 2V6z" />
        <path d="M9 4v14" />
        <path d="M15 6v14" />
      </IconWrapper>
    );
    const IconWallet = ()=>(
      <IconWrapper>
        <path d="M3 7h18v12H3V7z" />
        <path d="M3 7l2-3h16v3" />
        <path d="M17 13h4" />
      </IconWrapper>
    );
    const IconAlert = ()=>(
      <IconWrapper>
        <path d="M12 9v4" />
        <path d="M12 17h.01" />
        <path d="M10.3 4.3l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.7-2.7l-8-14a2 2 0 0 0-3.4 0z" />
      </IconWrapper>
    );
    const IconCheck = ()=>(
      <IconWrapper>
        <path d="M20 6L9 17l-5-5" />
      </IconWrapper>
    );

    /***********************
     * UI 元件
     ***********************/
    function StatPill({label, value, colorClass}){
      return (
        <div className="neo-card-soft px-2 py-2 flex-1 min-w-0">
          <div className="flex items-center justify-between gap-2">
            <div className="font-pixel text-2xl leading-none">{label}</div>
            <div className="font-pixel text-2xl leading-none">{value}</div>
          </div>
          <div className="mt-2 h-3 rounded-full border-2 border-black bg-white overflow-hidden">
            <div className={"h-full " + colorClass} style={{ width: clamp(value,0,100) + "%" }}></div>
          </div>
        </div>
      );
    }

    function StatBar({stats, livingCost}){
      const apBoxes = [];
      for(let i=0;i<stats.maxAp;i++){
        apBoxes.push(
          <div key={i} className={"w-4 h-4 border-2 border-black rounded-sm " + (i < stats.ap ? "bg-black" : "bg-white")}></div>
        );
      }
      return (
        <div className="statbar px-3 py-3">
          <div className="flex items-start justify-between gap-2">
            <div className="min-w-0">
              <div className="font-pixel text-2xl leading-tight safe-wrap">
                第 {stats.week} 週 / {stats.maxWeeks}（本週基本支出：{livingCost}）
              </div>
            </div>
            <div className="shrink-0">
              <div className="flex items-center gap-2">
                <div className="font-pixel text-2xl">AP</div>
                <div className="flex items-center gap-1">{apBoxes}</div>
              </div>
            </div>
          </div>

          <div className="mt-3 flex gap-2">
            <StatPill label="體力" value={stats.health} colorClass="bg-emerald-300" />
            <StatPill label="心情" value={stats.mood} colorClass="bg-yellow-300" />
            <StatPill label="資安" value={stats.security} colorClass="bg-sky-300" />
          </div>
        </div>
      );
    }

    function AppIcon({title, subtitle, icon, onClick}){
      return (
        <button onClick={onClick} className="neo-card-soft p-3 text-left w-full neo-btn bg-white">
          <div className="flex items-start gap-3">
            <div className="w-12 h-12 neo-card-soft flex items-center justify-center shrink-0 bg-white">
              <div className="text-black">{icon}</div>
            </div>
            <div className="min-w-0">
              <div className="font-pixel text-3xl leading-none safe-wrap">{title}</div>
              <div className="text-xs muted mt-1 safe-wrap">{subtitle}</div>
            </div>
            <div className="font-pixel text-3xl ml-auto shrink-0">→</div>
          </div>
        </button>
      );
    }

    function ModalWrapper({ title, children, onClose, footer }){
      return (
        <div className="absolute inset-0 z-50 flex items-end sm:items-center justify-center">
          <div className="absolute inset-0 bg-black/50" onClick={onClose} />
          <div
            className="modal-pop neo-card w-[96%] max-w-[360px] mx-auto mb-3 sm:mb-0 p-3 flex flex-col"
            style={{ maxHeight: "78vh" }}
          >
            <div className="shrink-0 flex items-start justify-between gap-2">
              <div className="min-w-0">
                <div className="font-pixel text-[28px] leading-tight text-slate-900 break-words">
                  {title}
                </div>
              </div>
              <button className="neo-btn px-3 py-1 bg-white font-pixel text-2xl shrink-0" onClick={onClose}>
                關閉
              </button>
            </div>

            <div
              className="mt-3 flex-1 min-h-0 overflow-y-auto pr-1 text-sm text-slate-800"
              style={{ WebkitOverflowScrolling: "touch", overflowWrap: "anywhere" }}
            >
              <div className="break-words whitespace-pre-wrap leading-relaxed">
                {children}
              </div>
              <div className="h-16"></div>
            </div>

            {footer ? (
              <div className="shrink-0 mt-2 pt-2 border-t border-black/10 bg-white">
                {footer}
              </div>
            ) : null}
          </div>
        </div>
      );
    }

    function FloatingTextOverlay({ items }){
      return (
        <div className="absolute inset-0 pointer-events-none z-40">
          {items.map((it)=>(
            <div
              key={it.id}
              className="float-text"
              style={{
                top: it.top + "px",
                background: it.kind === "good" ? "#dcfce7" : "#fee2e2",
                color: "#000"
              }}
            >
              {it.text}
            </div>
          ))}
        </div>
      );
    }

    function ErrorBoundary({ children }){
      const [err, setErr] = useState(null);
      if(err){
        return (
          <div className="p-4">
            <div className="neo-card p-3 bg-white">
              <div className="font-pixel text-3xl">畫面渲染錯誤</div>
              <pre className="mt-2 text-xs whitespace-pre-wrap">{String(err && err.stack ? err.stack : err)}</pre>
            </div>
          </div>
        );
      }
      return (
        <React.ErrorBoundary
          fallbackRender={({error}) => {
            setErr(error);
            return null;
          }}
        >
          {children}
        </React.ErrorBoundary>
      );
    }

    // React.ErrorBoundary 在部分環境可能不存在；提供 fallback（避免 #310 類型崩潰）
    if(!React.ErrorBoundary){
      React.ErrorBoundary = function FallbackBoundary({ children, fallbackRender }){
        const [error, setError] = useState(null);
        if(error) return fallbackRender({ error });
        try{
          return children;
        }catch(e){
          setError(e);
          return null;
        }
      };
    }

    /***********************
     * 主程式 App
     ***********************/
    function App(){
      const [screen, setScreen] = useState("onboarding"); // onboarding | home | app_job | app_house | app_resource | app_finance
      const [stats, setStats] = useState(()=>({ ...INITIAL_STATS }));
      const [origin, setOrigin] = useState(null);
      const [spinning, setSpinning] = useState(false);

      const [logs, setLogs] = useState([
        "[W1] 歡迎來到《自立大冒險》。先抽一次命運轉盤吧！"
      ]);

      const [bills, setBills] = useState([]); // {id,name,weeklyAmount,remainingWeeks}
      const [hasHouse, setHasHouse] = useState(false);
      const [houseName, setHouseName] = useState("");
      const [houseType, setHouseType] = useState("");
      const [items, setItems] = useState({
        accompaniment_card: false,
        good_citizen_card: false,
        insurance: false
      });

      const [missions, setMissions] = useState({
        stable_house: false,
        stable_job: false,
        resource_link: false
      });

      const [ledger, setLedger] = useState([]); // {id,name,amount}
      const [glitchOn, setGlitchOn] = useState(false);

      const [floatTexts, setFloatTexts] = useState([]);

      const [modal, setModal] = useState(null); // {type, ...payload}
      // type: quiz | event | shop | end

      const livingCost = useMemo(()=>{
        let cost = 1500;
        if(hasHouse && houseType !== "ccsa") cost += 500;
        return cost;
      }, [hasHouse, houseType]);

      // 低心情/低資安觸發 glitch（短暫）
      useEffect(()=>{
        if(stats.mood < 30 || stats.security < 30){
          setGlitchOn(true);
          const t = setTimeout(()=>setGlitchOn(false), 520);
          return ()=>clearTimeout(t);
        }
      }, [stats.mood, stats.security]);

      function pushLog(text){
        setLogs(prev=>{
          const next = prev.concat([text]);
          return next.slice(-50);
        });
      }

      function spawnFloat(text, kind){
        const id = nowId();
        const top = 130 + Math.floor(Math.random()*120);
        setFloatTexts(prev => prev.concat([{ id, text, kind, top }]));
        setTimeout(()=>{
          setFloatTexts(prev => prev.filter(x=>x.id!==id));
        }, 920);
      }

      function applyDelta(delta, reasonLabel){
        // delta: {money,health,mood,security,ap,maxAp}
        setStats(prev=>{
          const next = { ...prev };
          const keys = ["money","health","mood","security","ap","maxAp"];
          keys.forEach(k=>{
            if(delta && typeof delta[k] === "number"){
              let v = next[k] + delta[k];
              if(k === "health" || k === "mood" || k === "security"){
                v = clamp(v, 0, 100);
              }
              if(k === "ap"){
                v = clamp(v, 0, next.maxAp);
              }
              if(k === "maxAp"){
                v = clamp(v, 1, 6);
                // maxAp 改變時，讓 ap 不超過 maxAp
                next.ap = clamp(next.ap, 0, v);
              }
              next[k] = v;
            }
          });

          // 浮字：只顯示 money/health/mood/security 的變動
          const displayKeys = ["money","health","mood","security"];
          displayKeys.forEach(k=>{
            if(delta && typeof delta[k] === "number" && delta[k] !== 0){
              const sign = delta[k] > 0 ? "+" : "";
              const label = (k==="money") ? "金錢" : (k==="health") ? "體力" : (k==="mood") ? "心情" : "資安";
              const valTxt = (k==="money") ? (sign + formatMoney(delta[k])) : (sign + delta[k]);
              spawnFloat(label + " " + valTxt, delta[k] > 0 ? "good" : "bad");
            }
          });

          if(reasonLabel){
            // 不強制寫 log，保留給外面呼叫
          }
          return next;
        });
      }

      function consumeAp(cost){
        if(stats.ap < cost) return false;
        applyDelta({ ap: -cost });
        return true;
      }

      function spinWheel(){
        if(spinning) return;
        setSpinning(true);
        pushLog("[W1] 命運轉盤旋轉中...（2 秒）");

        setTimeout(()=>{
          const weighted = CHARACTER_ORIGINS.map(x=>({ ...x, weight: x.prob }));
          const pick = pickWeighted(weighted);
          const age = 15 + Math.floor(Math.random()*5); // 15~19
          setOrigin(pick);
          setStats(prev=>({
            ...prev,
            money: pick.money,
            age
          }));
          pushLog(`[W1] 命運轉盤結果：等級 ${pick.key}，初始金額 ${pick.money} 元；年齡 ${age}。`);
          setSpinning(false);
        }, 2000);
      }

      function goHome(){
        setScreen("home");
      }

      function startPasswordChallenge(choice){
        if(choice === "weak"){
          applyDelta({ security: -20 });
          pushLog("[W1] 你選擇了弱密碼 123456，資安下降。");
        } else {
          applyDelta({ security: +10 });
          pushLog("[W1] 你開啟了 2FA，資安提升。");
        }
        pushLog("[W1] 你啟程了！");
        goHome();
      }

      function openQuizModal({ title, questions, onPass, onFail, passLabel }){
        // 確保問題至少 1 題
        const qlist = Array.isArray(questions) ? questions : [];
        setModal({
          type: "quiz",
          title,
          questions: qlist,
          onPass,
          onFail,
          passLabel: passLabel || "送出"
        });
      }

      function openShop(){
        setModal({ type:"shop" });
      }

      function triggerRandomEvent(){
        const roll = Math.random();
        if(roll > 0.6){
          return; // 不觸發事件，留在 home
        }

        const pool = [
          { id:"friend_loan", weight: 3 },
          { id:"scam_romance", weight: 2 },
          { id:"scam_job", weight: 2 },
          { id:"accident", weight: 2 },
          { id:"sickness", weight: 2 },
        ];

        if(!hasHouse){
          pool.push({ id:"police", weight: 3 });
        } else {
          pool.push({ id:"police", weight: 1 });
        }

        if(stats.health < 50){
          pool.push({ id:"sickness", weight: 3 });
        }

        const pick = pickWeighted(pool.map(p=>({ ...p })));
        const scenario = SCENARIOS[pick.id];
        if(!scenario) return;

        setModal({ type:"event", scenarioId: scenario.id });
      }

      function advanceWeek(){
        // 若已結束，不再前進
        if(stats.week >= stats.maxWeeks){
          // 已到第 8 週，顯示結算（若沒有顯示）
          openEndModal();
          return;
        }

        // 先扣本週生活費
        applyDelta({ money: -livingCost });
        pushLog(`[W${stats.week}] 本週生活支出 -${livingCost}。`);

        // 扣帳單（每週扣款）
        if(bills.length > 0){
          setBills(prev=>{
            const next = [];
            prev.forEach(b=>{
              applyDelta({ money: -b.weeklyAmount });
              pushLog(`[W${stats.week}] 扣款：${b.name} -${b.weeklyAmount}（剩 ${Math.max(0,b.remainingWeeks-1)} 週）`);
              const remain = b.remainingWeeks - 1;
              if(remain > 0){
                next.push({ ...b, remainingWeeks: remain });
              } else {
                pushLog(`[W${stats.week}] 帳單完成：${b.name}。`);
              }
            });
            return next;
          });
        }

        // 週數+1、AP 重置、心情-5、資安-2
        setStats(prev=>{
          const next = { ...prev };
          next.week = prev.week + 1;
          next.ap = prev.maxAp;
          next.mood = clamp(prev.mood - 5, 0, 100);
          next.security = clamp(prev.security - 2, 0, 100);
          spawnFloat("心情 -5", "bad");
          spawnFloat("資安 -2", "bad");
          return next;
        });

        // 驅逐判定：若扣完後 money < 0 且租的是非 CCSA
        // 用 setTimeout 等 state 更新後再判斷（避免讀到舊值）
        setTimeout(()=>{
          setStats(prev=>{
            if(prev.money < 0 && hasHouse && houseType !== "ccsa"){
              setHasHouse(false);
              setHouseName("");
              setHouseType("");
              pushLog(`[W${prev.week-1}] 你因赤字被迫退租（非 CCSA）。`);
              spawnFloat("退租！", "bad");
              return {
                ...prev,
                mood: clamp(prev.mood - 30, 0, 100),
                security: clamp(prev.security - 10, 0, 100)
              };
            }
            return prev;
          });

          // 結算後 1 秒觸發事件
          setTimeout(()=>{
            triggerRandomEvent();
          }, 1000);
        }, 0);
      }

      function markMission(key){
        setMissions(prev=>{
          if(prev[key]) return prev;
          return { ...prev, [key]: true };
        });
      }

      function completedMissionsCount(ms){
        return Object.values(ms).filter(Boolean).length;
      }

      function openEndModal(){
        // 勝負判定：第 8 週結算時（這裡以 stats.week==8 的狀態為主）
        const tasks = completedMissionsCount(missions);
        const isWin = (stats.money > 0) && (tasks >= 2);

        const title = getEndingTitle({ money: stats.money, hasHouse, tasks });
        const achievements = getAchievements({ stats, hasHouse, missions, items, ledger, bills, logs });

        const warm = getWarmComment({ isWin, stats, tasks, hasHouse });

        setModal({
          type: "end",
          isWin,
          title,
          tasks,
          achievements,
          warm
        });
      }

      function resetGame(){
        setScreen("onboarding");
        setStats({ ...INITIAL_STATS });
        setOrigin(null);
        setSpinning(false);
        setLogs(["[W1] 歡迎回來！再試一次命運轉盤吧！"]);
        setBills([]);
        setHasHouse(false);
        setHouseName("");
        setHouseType("");
        setItems({ accompaniment_card:false, good_citizen_card:false, insurance:false });
        setMissions({ stable_house:false, stable_job:false, resource_link:false });
        setLedger([]);
        setModal(null);
        setFloatTexts([]);
      }

      /***********************
       * 各 App 畫面：renderXXX
       ***********************/
      function renderOnboarding(){
        return (
          <div className="p-4">
            <div className="neo-card p-4 bg-white">
              <div className="font-pixel text-4xl leading-none safe-wrap">自立大冒險</div>
              <div className="mt-1 text-sm muted safe-wrap">自立生活模擬器（8 週）</div>

              <div className="mt-4 neo-card-soft p-3 bg-white">
                <div className="font-pixel text-3xl leading-none safe-wrap">命運轉盤</div>
                <div className="text-xs muted mt-1 safe-wrap">
                  依機率抽出起始金額等級（A~E），並隨機年齡 15~19。
                </div>
                <div className="mt-3">
                  <button
                    className={"neo-btn w-full px-4 py-3 font-pixel text-3xl " + (spinning ? "bg-gray-100" : "bg-yellow-200")}
                    onClick={spinWheel}
                    disabled={spinning}
                  >
                    {spinning ? "轉盤中..." : "開始轉盤"}
                  </button>
                </div>

                {origin ? (
                  <div className="mt-4">
                    <div className="neo-card-soft p-3 bg-white">
                      <div className="font-pixel text-3xl leading-none safe-wrap">身分確認卡</div>
                      <div className="mt-2 text-sm safe-wrap">
                        起點：<b>等級 {origin.key}</b>（{origin.label}）<br/>
                        年齡：<b>{stats.age}</b> 歲<br/>
                        初始金額：<b>{formatMoney(stats.money)}</b>
                      </div>
                    </div>

                    <div className="neo-card-soft p-3 bg-white mt-3">
                      <div className="font-pixel text-3xl leading-none safe-wrap">第一關：手機密碼</div>
                      <div className="text-xs muted mt-1 safe-wrap">選一個做法，會影響你的「資安」。</div>
                      <div className="mt-3 grid grid-cols-1 gap-2">
                        <button className="neo-btn px-3 py-3 bg-white font-pixel text-3xl" onClick={()=>startPasswordChallenge("weak")}>
                          123456（資安 -20）
                        </button>
                        <button className="neo-btn px-3 py-3 bg-emerald-200 font-pixel text-3xl" onClick={()=>startPasswordChallenge("2fa")}>
                          開啟 2FA（資安 +10）
                        </button>
                      </div>
                    </div>
                  </div>
                ) : null}
              </div>

              <div className="mt-4 text-xs muted safe-wrap">
                小提醒：自立不只有賺錢，還包含安全、資源連結與穩定生活。
              </div>
            </div>
          </div>
        );
      }

      function renderHome(){
        const moodLow = stats.mood < 30;
        const hasBills = bills.length > 0;

        return (
          <div className="p-4">
            <div className="neo-card p-3 bg-white">
              <div className="flex items-start justify-between gap-3">
                <div className="min-w-0">
                  <div className="font-pixel text-4xl leading-none safe-wrap">主畫面</div>
                  <div className="mt-1 text-sm safe-wrap">
                    餘額：<b>{formatMoney(stats.money)}</b>　年齡：<b>{stats.age}</b> 歲
                  </div>
                </div>
                <button
                  className="neo-btn px-3 py-2 bg-white font-pixel text-3xl shrink-0"
                  onClick={()=>setScreen("onboarding")}
                  title="回到首頁（不重置）"
                >
                  回首頁
                </button>
              </div>

              {hasBills ? (
                <div className="mt-3 neo-card-soft p-2 bg-yellow-100">
                  <div className="flex items-center gap-2">
                    <div className="text-black"><IconAlert/></div>
                    <div className="font-pixel text-3xl leading-none safe-wrap">未繳帳單提醒</div>
                  </div>
                  <div className="text-xs mt-1 safe-wrap">你有 {bills.length} 筆待扣款/分期，請留意餘額。</div>
                </div>
              ) : null}

              {moodLow ? (
                <div className="mt-3 neo-card-soft p-2 bg-red-100">
                  <div className="flex items-center gap-2">
                    <div className="text-black"><IconAlert/></div>
                    <div className="font-pixel text-3xl leading-none safe-wrap">心情偏低</div>
                  </div>
                  <div className="text-xs mt-1 safe-wrap">
                    你目前心情較低（{stats.mood}）。建議：休息、找支持系統、或使用資源地圖（諮商/社福）。
                  </div>
                </div>
              ) : null}

              <div className="mt-4 grid grid-cols-1 gap-3">
                <AppIcon
                  title="租屋中心"
                  subtitle="看房、簽約、住處安全檢核"
                  icon={<IconHouse/>}
                  onClick={()=>setScreen("app_house")}
                />
                <AppIcon
                  title="人力銀行"
                  subtitle="應徵打工：面試小測驗（3 題全對才錄取）"
                  icon={<IconJob/>}
                  onClick={()=>setScreen("app_job")}
                />
                <AppIcon
                  title="資源地圖"
                  subtitle="社福中心、就服站、CCSA 自立服務、警察局"
                  icon={<IconMap/>}
                  onClick={()=>setScreen("app_resource")}
                />
                <AppIcon
                  title="財務管家"
                  subtitle="帳單、支出、記帳、商店"
                  icon={<IconWallet/>}
                  onClick={()=>setScreen("app_finance")}
                />
              </div>

              <div className="mt-4 grid grid-cols-2 gap-3">
                <button
                  className="neo-btn px-3 py-3 bg-emerald-200 font-pixel text-3xl"
                  onClick={advanceWeek}
                >
                  結束本週<br/><span className="text-xl">前往下一週</span>
                </button>

                <div className="neo-card-soft p-3 bg-white">
                  <div className="font-pixel text-3xl leading-none safe-wrap">小提示</div>
                  <div className="text-xs mt-1 muted safe-wrap">
                    勝利條件：第 8 週結算時<br/>
                    ① 存款 &gt; 0　② 任務 ≥ 2（住處/工作/資源）
                  </div>
                </div>
              </div>

              <div className="mt-4 mono-log p-3">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-3xl text-green-100">系統紀錄</div>
                  <div className="text-green-100/80 text-xs">最近 5 筆</div>
                </div>
                <div className="mt-2 space-y-1">
                  {logs.slice(-5).map((l, idx)=>(
                    <div key={idx} className="safe-wrap">• {l}</div>
                  ))}
                </div>
              </div>

              <div className="mt-4">
                <button
                  className="neo-btn px-3 py-3 bg-white w-full font-pixel text-3xl"
                  onClick={()=>{
                    if(stats.week >= stats.maxWeeks){
                      openEndModal();
                    }else{
                      pushLog(`[W${stats.week}] 你查看了勝利條件。`);
                    }
                  }}
                >
                  查看結算／結局
                </button>
              </div>
            </div>
          </div>
        );
      }

      function buildInterviewQuestions(job){
        const pool = []
          .concat(job.interviews || [])
          .concat(GENERIC_JOB_QUESTIONS || []);
        const shuffled = shuffleArray(pool);
        const picked = shuffled.slice(0, 3);
        // 保證 3 題（若不足就補）
        while(picked.length < 3 && pool.length > 0){
          picked.push(pool[picked.length % pool.length]);
        }
        return picked;
      }

      function renderJobApp(){
        return (
          <div className="p-4">
            <div className="neo-card p-3 bg-white">
              <div className="flex items-start justify-between gap-2">
                <div className="min-w-0">
                  <div className="font-pixel text-4xl leading-none safe-wrap">人力銀行</div>
                  <div className="text-xs muted mt-1 safe-wrap">應徵會消耗 1 AP，並進行 3 題面試測驗（全對才錄取）。</div>
                </div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-3xl shrink-0" onClick={goHome}>
                  <span className="inline-flex items-center gap-2"><IconHome/>回家</span>
                </button>
              </div>

              <div className="mt-3 grid grid-cols-1 gap-3">
                {JOBS.map(job=>{
                  const ageOk = stats.age >= job.minAge;
                  const canByAccomp = (!ageOk && items.accompaniment_card && !job.strictAge);
                  const ageLabel = ageOk ? "年齡 OK" : (canByAccomp ? "可陪同" : "年齡不足");
                  const ageBadge = ageOk ? "bg-emerald-200" : (canByAccomp ? "bg-sky-200" : "bg-gray-200");

                  return (
                    <div key={job.id} className="neo-card-soft p-3 bg-white">
                      <div className="flex items-start gap-3">
                        <div className={"neo-chip " + ageBadge + " font-pixel text-2xl shrink-0"}>{ageLabel}</div>
                        <div className="min-w-0">
                          <div className="font-pixel text-4xl leading-none safe-wrap">{job.title}</div>
                          <div className="text-xs muted mt-1 safe-wrap">{job.desc}</div>
                        </div>
                      </div>

                      <div className="mt-3 grid grid-cols-4 gap-2">
                        <div className="neo-card-soft p-2 bg-white text-center min-w-0">
                          <div className="text-xs muted">時薪</div>
                          <div className="font-pixel text-3xl">{job.wage}</div>
                        </div>
                        <div className="neo-card-soft p-2 bg-white text-center min-w-0">
                          <div className="text-xs muted">體力</div>
                          <div className="font-pixel text-3xl">-{job.energy}</div>
                        </div>
                        <div className="neo-card-soft p-2 bg-white text-center min-w-0">
                          <div className="text-xs muted">心情</div>
                          <div className="font-pixel text-3xl">{job.mood>=0?"+":""}{job.mood}</div>
                        </div>
                        <div className="neo-card-soft p-2 bg-white text-center min-w-0">
                          <div className="text-xs muted">AP</div>
                          <div className="font-pixel text-3xl">-{job.apCost}</div>
                        </div>
                      </div>

                      <div className="mt-3">
                        <button
                          className={"neo-btn w-full px-3 py-3 font-pixel text-3xl " + ((stats.ap < job.apCost) ? "bg-gray-100" : "bg-emerald-200")}
                          disabled={stats.ap < job.apCost}
                          onClick={()=>{
                            const ageOk2 = stats.age >= job.minAge;
                            const canByAccomp2 = (!ageOk2 && items.accompaniment_card && !job.strictAge);
                            if(!(ageOk2 || canByAccomp2)){
                              pushLog(`[W${stats.week}] 你想應徵「${job.title}」，但年齡不符（可到資源地圖申請陪同）。`);
                              spawnFloat("年齡不符", "bad");
                              return;
                            }
                            if(!consumeAp(job.apCost)){
                              pushLog(`[W${stats.week}] AP 不足，無法應徵「${job.title}」。`);
                              return;
                            }
                            const qs = buildInterviewQuestions(job);
                            openQuizModal({
                              title: `面試：${job.title}`,
                              questions: qs,
                              passLabel: "送出（全對才錄取）",
                              onPass: ()=>{
                                const earn = job.wage * 8;
                                applyDelta({ money: earn, health: -job.energy, mood: job.mood });
                                pushLog(`[W${stats.week}] 你錄取了「${job.title}」，本週收入 +${earn}。`);
                                markMission("stable_job");
                                setModal(null);
                              },
                              onFail: ()=>{
                                applyDelta({ mood: -10 });
                                pushLog(`[W${stats.week}] 你面試未通過「${job.title}」（心情 -10）。`);
                                setModal(null);
                              }
                            });
                          }}
                        >
                          應徵
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      function renderHouseApp(){
        const ageUnder18 = stats.age < 18;
        const canSignNonCCSA = !ageUnder18 || items.accompaniment_card;

        return (
          <div className="p-4">
            <div className="neo-card p-3 bg-white">
              <div className="flex items-start justify-between gap-2">
                <div className="min-w-0">
                  <div className="font-pixel text-4xl leading-none safe-wrap">租屋中心</div>
                  <div className="text-xs muted mt-1 safe-wrap">
                    預約看房消耗 1 AP，需通過測驗才能簽約。未滿 18 歲若無陪同，除 CCSA 外不可簽約。
                  </div>
                </div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-3xl shrink-0" onClick={goHome}>
                  <span className="inline-flex items-center gap-2"><IconHome/>回家</span>
                </button>
              </div>

              {hasHouse ? (
                <div className="mt-3 neo-card-soft p-3 bg-emerald-50">
                  <div className="font-pixel text-3xl leading-none safe-wrap">已入住</div>
                  <div className="mt-1 text-sm safe-wrap">
                    目前住處：<b>{houseName}</b><br/>
                    類型：<b>{houseType.toUpperCase()}</b>
                  </div>
                  <div className="mt-2 text-xs muted safe-wrap">
                    小提醒：住處穩定是重要任務之一（穩定租屋/住處安全）。
                  </div>
                </div>
              ) : null}

              <div className="mt-3 grid grid-cols-1 gap-3">
                {HOUSING.map(h=>{
                  const isCCSA = h.type === "ccsa";
                  const canSign = isCCSA || canSignNonCCSA;

                  return (
                    <div key={h.id} className="neo-card-soft p-3 bg-white">
                      <div className="flex items-start justify-between gap-2">
                        <div className="min-w-0">
                          <div className="font-pixel text-4xl leading-none safe-wrap">{h.title}</div>
                          <div className="text-xs muted mt-1 safe-wrap">{h.desc}</div>
                        </div>
                        <div className={"neo-chip font-pixel text-2xl shrink-0 " + (h.securityDelta >=0 ? "bg-sky-200" : "bg-red-100")}>
                          資安 {h.securityDelta>=0?"+":""}{h.securityDelta}
                        </div>
                      </div>

                      <div className="mt-3 grid grid-cols-2 gap-2">
                        <div className="neo-card-soft p-2 bg-white min-w-0">
                          <div className="text-xs muted">月租</div>
                          <div className="font-pixel text-3xl safe-wrap">{h.rent===0 ? "免費" : formatMoney(h.rent)}</div>
                        </div>
                        <div className="neo-card-soft p-2 bg-white min-w-0">
                          <div className="text-xs muted">押金</div>
                          <div className="font-pixel text-3xl safe-wrap">{h.deposit===0 ? "免押金" : formatMoney(h.deposit)}</div>
                        </div>
                      </div>

                      <div className="mt-3">
                        <button
                          className={"neo-btn w-full px-3 py-3 font-pixel text-3xl " + (stats.ap<1 ? "bg-gray-100" : "bg-yellow-200")}
                          disabled={stats.ap<1}
                          onClick={()=>{
                            // 年齡限制（未滿18且無陪同，除 CCSA 外不可）
                            if(!canSign){
                              pushLog(`[W${stats.week}] 你想簽約「${h.title}」，但未滿 18 且沒有陪同（請先到資源地圖申請陪同）。`);
                              spawnFloat("需陪同", "bad");
                              return;
                            }
                            if(!consumeAp(1)){
                              pushLog(`[W${stats.week}] AP 不足，無法預約看房。`);
                              return;
                            }

                            const quizList = QUIZ_DB[h.quizType] ? QUIZ_DB[h.quizType].slice() : [];
                            // 若題庫不足，補一些通用題
                            const fallback = (QUIZ_DB.contract_check || []);
                            const merged = shuffleArray(quizList.concat(fallback)).slice(0,3);

                            openQuizModal({
                              title: `看房／簽約：${h.title}`,
                              questions: merged,
                              passLabel: "送出（全對才可簽約）",
                              onPass: ()=>{
                                // 簽約成功：扣押金（rent=0 可免）
                                const deposit = Number(h.deposit||0);
                                if(deposit > 0){
                                  applyDelta({ money: -deposit });
                                  pushLog(`[W${stats.week}] 你支付押金 -${deposit}。`);
                                } else {
                                  pushLog(`[W${stats.week}] 你免押金入住。`);
                                }
                                applyDelta({ security: h.securityDelta });
                                setHasHouse(true);
                                setHouseName(h.title);
                                setHouseType(h.type);
                                markMission("stable_house");
                                pushLog(`[W${stats.week}] 你成功入住「${h.title}」。`);
                                setModal(null);
                              },
                              onFail: ()=>{
                                applyDelta({ mood: -6 });
                                pushLog(`[W${stats.week}] 你未通過看房／簽約測驗（心情 -6）。`);
                                setModal(null);
                              }
                            });
                          }}
                        >
                          預約看房
                        </button>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      function renderResourceApp(){
        return (
          <div className="p-4">
            <div className="neo-card p-3 bg-white">
              <div className="flex items-start justify-between gap-2">
                <div className="min-w-0">
                  <div className="font-pixel text-4xl leading-none safe-wrap">資源地圖</div>
                  <div className="text-xs muted mt-1 safe-wrap">透過資源連結，有機會提升體力/心情/金錢/行動力。</div>
                </div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-3xl shrink-0" onClick={goHome}>
                  <span className="inline-flex items-center gap-2"><IconHome/>回家</span>
                </button>
              </div>

              <div className="mt-3 grid grid-cols-1 gap-3">
                {/* 就服站 */}
                <div className="neo-card-soft p-3 bg-white">
                  <div className="flex items-start justify-between gap-2">
                    <div className="min-w-0">
                      <div className="font-pixel text-4xl leading-none safe-wrap">就業服務站</div>
                      <div className="text-xs muted mt-1 safe-wrap">完成求職測驗（全對）可獲得獎勵。</div>
                    </div>
                    <div className="neo-chip bg-emerald-200 font-pixel text-2xl shrink-0">就業</div>
                  </div>

                  <button
                    className="neo-btn w-full mt-3 px-3 py-3 bg-emerald-200 font-pixel text-3xl"
                    onClick={()=>{
                      openQuizModal({
                        title: "就服站：求職測驗",
                        questions: shuffleArray(QUIZ_DB.job_test || []).slice(0,3),
                        passLabel: "送出（全對才有獎勵）",
                        onPass: ()=>{
                          applyDelta({ money: +1000 });
                          pushLog(`[W${stats.week}] 你完成就服站測驗，獎勵 +1000。`);
                          markMission("resource_link");
                          setModal(null);
                        },
                        onFail: ()=>{
                          applyDelta({ mood: -4 });
                          pushLog(`[W${stats.week}] 就服站測驗未通過（心情 -4）。`);
                          setModal(null);
                        }
                      });
                    }}
                  >
                    開始測驗
                  </button>
                </div>

                {/* 社會福利中心 */}
                <div className="neo-card-soft p-3 bg-white">
                  <div className="flex items-start justify-between gap-2">
                    <div className="min-w-0">
                      <div className="font-pixel text-4xl leading-none safe-wrap">社會福利中心</div>
                      <div className="text-xs muted mt-1 safe-wrap">
                        welfare_help：過關給體力 +20。<br/>
                        finance_help：餘額 &lt; 2000 才可申請，過關 +5000。
                      </div>
                    </div>
                    <div className="neo-chip bg-yellow-200 font-pixel text-2xl shrink-0">協助</div>
                  </div>

                  <div className="mt-3 grid grid-cols-2 gap-2">
                    <button
                      className="neo-btn px-3 py-3 bg-yellow-200 font-pixel text-3xl"
                      onClick={()=>{
                        openQuizModal({
                          title: "社福中心：基本協助",
                          questions: shuffleArray(QUIZ_DB.welfare_help || []).slice(0,2),
                          passLabel: "送出",
                          onPass: ()=>{
                            applyDelta({ health:+20 });
                            pushLog(`[W${stats.week}] 社福中心提供協助（體力 +20）。`);
                            markMission("resource_link");
                            setModal(null);
                          },
                          onFail: ()=>{
                            applyDelta({ mood:-4 });
                            pushLog(`[W${stats.week}] 你沒有完成社福中心流程（心情 -4）。`);
                            setModal(null);
                          }
                        });
                      }}
                    >
                      基本協助
                    </button>

                    <button
                      className={"neo-btn px-3 py-3 font-pixel text-3xl " + (stats.money < 2000 ? "bg-sky-200" : "bg-gray-100")}
                      onClick={()=>{
                        if(stats.money >= 2000){
                          pushLog(`[W${stats.week}] 你目前餘額較高（≥2000），暫不符合財務補助資格。`);
                          spawnFloat("不符合", "bad");
                          return;
                        }
                        openQuizModal({
                          title: "社福中心：財務補助",
                          questions: shuffleArray(QUIZ_DB.finance_help || []).slice(0,2),
                          passLabel: "送出",
                          onPass: ()=>{
                            applyDelta({ money:+5000 });
                            pushLog(`[W${stats.week}] 社福中心核發補助 +5000。`);
                            markMission("resource_link");
                            setModal(null);
                          },
                          onFail: ()=>{
                            applyDelta({ mood:-5 });
                            pushLog(`[W${stats.week}] 補助流程未完成（心情 -5）。`);
                            setModal(null);
                          }
                        });
                      }}
                    >
                      財務補助
                    </button>
                  </div>
                </div>

                {/* CCSA 自立服務 */}
                <div className="neo-card-soft p-3 bg-white">
                  <div className="flex items-start justify-between gap-2">
                    <div className="min-w-0">
                      <div className="font-pixel text-4xl leading-none safe-wrap">CCSA 自立服務</div>
                      <div className="text-xs muted mt-1 safe-wrap">經濟支持、陪同、諮商與培訓（提升 maxAP）。</div>
                    </div>
                    <div className="neo-chip bg-emerald-200 font-pixel text-2xl shrink-0">支持</div>
                  </div>

                  <div className="mt-3 grid grid-cols-2 gap-2">
                    <button
                      className="neo-btn px-3 py-3 bg-emerald-200 font-pixel text-3xl"
                      onClick={()=>{
                        openQuizModal({
                          title: "CCSA：經濟支持",
                          questions: shuffleArray(QUIZ_DB.ccsa_aid || []).slice(0,2),
                          passLabel: "送出",
                          onPass: ()=>{
                            applyDelta({ money:+3000 });
                            pushLog(`[W${stats.week}] CCSA 提供支持 +3000。`);
                            markMission("resource_link");
                            setModal(null);
                          },
                          onFail: ()=>{
                            applyDelta({ mood:-4 });
                            pushLog(`[W${stats.week}] 你沒有完成支持流程（心情 -4）。`);
                            setModal(null);
                          }
                        });
                      }}
                    >
                      經濟支持
                    </button>

                    <button
                      className={"neo-btn px-3 py-3 font-pixel text-3xl " + (items.accompaniment_card ? "bg-gray-100" : "bg-white")}
                      onClick={()=>{
                        if(items.accompaniment_card){
                          pushLog(`[W${stats.week}] 你已擁有「社工陪同」。`);
                          return;
                        }
                        if(!consumeAp(1)){
                          pushLog(`[W${stats.week}] AP 不足，無法申請陪同。`);
                          return;
                        }
                        setItems(prev=>({ ...prev, accompaniment_card:true }));
                        pushLog(`[W${stats.week}] 你申請了「社工陪同」（可協助未滿 18 的部分情境）。`);
                        markMission("resource_link");
                        spawnFloat("獲得：陪同", "good");
                      }}
                    >
                      申請陪同
                    </button>

                    <button
                      className="neo-btn px-3 py-3 bg-yellow-200 font-pixel text-3xl"
                      onClick={()=>{
                        openQuizModal({
                          title: "CCSA：心理諮商",
                          questions: shuffleArray(QUIZ_DB.ccsa_counseling || []).slice(0,2),
                          passLabel: "送出",
                          onPass: ()=>{
                            applyDelta({ mood:+30, health:+10 });
                            pushLog(`[W${stats.week}] 你完成諮商（心情 +30、體力 +10）。`);
                            markMission("resource_link");
                            setModal(null);
                          },
                          onFail: ()=>{
                            applyDelta({ mood:-3 });
                            pushLog(`[W${stats.week}] 你沒有完成諮商流程（心情 -3）。`);
                            setModal(null);
                          }
                        });
                      }}
                    >
                      諮商
                    </button>

                    <button
                      className="neo-btn px-3 py-3 bg-indigo-200 font-pixel text-3xl"
                      onClick={()=>{
                        openQuizModal({
                          title: "CCSA：自立培訓",
                          questions: shuffleArray(QUIZ_DB.ccsa_training || []).slice(0,2),
                          passLabel: "送出",
                          onPass: ()=>{
                            applyDelta({ maxAp:+1, mood:+10 });
                            pushLog(`[W${stats.week}] 你完成培訓（maxAP +1、心情 +10）。`);
                            markMission("resource_link");
                            setModal(null);
                          },
                          onFail: ()=>{
                            applyDelta({ mood:-4 });
                            pushLog(`[W${stats.week}] 培訓未完成（心情 -4）。`);
                            setModal(null);
                          }
                        });
                      }}
                    >
                      培訓
                    </button>
                  </div>
                </div>

                {/* 警察局 */}
                <div className="neo-card-soft p-3 bg-white">
                  <div className="flex items-start justify-between gap-2">
                    <div className="min-w-0">
                      <div className="font-pixel text-4xl leading-none safe-wrap">警察局</div>
                      <div className="text-xs muted mt-1 safe-wrap">18+ 可領「良民證」。未滿 18 需法代/監護人。</div>
                    </div>
                    <div className="neo-chip bg-slate-200 font-pixel text-2xl shrink-0">公部門</div>
                  </div>

                  <button
                    className={"neo-btn w-full mt-3 px-3 py-3 font-pixel text-3xl " + (items.good_citizen_card ? "bg-gray-100" : "bg-white")}
                    onClick={()=>{
                      if(items.good_citizen_card){
                        pushLog(`[W${stats.week}] 你已領取「良民證」。`);
                        return;
                      }
                      if(stats.age < 18){
                        pushLog(`[W${stats.week}] 你未滿 18，需法代/監護人才能辦理良民證。`);
                        spawnFloat("未滿 18", "bad");
                        return;
                      }
                      setItems(prev=>({ ...prev, good_citizen_card:true }));
                      pushLog(`[W${stats.week}] 你領取了「良民證」。`);
                      spawnFloat("獲得：良民證", "good");
                      markMission("resource_link");
                    }}
                  >
                    領取良民證
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      function renderFinanceApp(){
        // 避免任何 undefined component：此函式必須永遠回傳有效 React Element
        const [entryName, setEntryName] = useState("");
        const [entryAmount, setEntryAmount] = useState("");

        function addLedger(amountSigned){
          const name = entryName.trim() || "未命名";
          const amt = Number(entryAmount);
          if(!Number.isFinite(amt) || amt <= 0){
            pushLog(`[W${stats.week}] 記帳失敗：請輸入正確金額。`);
            spawnFloat("金額錯誤", "bad");
            return;
          }
          const finalAmt = amountSigned > 0 ? amt : -amt;
          setLedger(prev=>prev.concat([{ id: nowId(), name, amount: finalAmt }]));
          applyDelta({ money: finalAmt });
          pushLog(`[W${stats.week}] 記帳：${name} ${finalAmt>0?"+":""}${formatMoney(finalAmt)}。`);
          setEntryName("");
          setEntryAmount("");
        }

        return (
          <div className="p-4">
            <div className="neo-card p-3 bg-white">
              <div className="flex items-start justify-between gap-2">
                <div className="min-w-0">
                  <div className="font-pixel text-4xl leading-none safe-wrap">財務管家</div>
                  <div className="text-xs muted mt-1 safe-wrap">查看本週支出、帳單，並可記帳與進入商店。</div>
                </div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-3xl shrink-0" onClick={goHome}>
                  <span className="inline-flex items-center gap-2"><IconHome/>回家</span>
                </button>
              </div>

              <div className="mt-3 grid grid-cols-2 gap-2">
                <div className="neo-card-soft p-3 bg-white min-w-0">
                  <div className="text-xs muted">現金餘額</div>
                  <div className="font-pixel text-4xl leading-none safe-wrap">{formatMoney(stats.money)}</div>
                </div>
                <div className="neo-card-soft p-3 bg-white min-w-0">
                  <div className="text-xs muted">本週固定支出</div>
                  <div className="font-pixel text-4xl leading-none safe-wrap">{livingCost}</div>
                </div>
              </div>

              <div className="mt-3 neo-card-soft p-3 bg-white">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-3xl leading-none safe-wrap">未繳帳單</div>
                  <div className="text-xs muted">{bills.length} 筆</div>
                </div>
                {bills.length === 0 ? (
                  <div className="text-xs muted mt-2 safe-wrap">目前沒有分期/待扣款帳單。</div>
                ) : (
                  <div className="mt-2 space-y-2">
                    {bills.map(b=>(
                      <div key={b.id} className="neo-card-soft p-2 bg-white">
                        <div className="flex items-start justify-between gap-2">
                          <div className="min-w-0">
                            <div className="font-pixel text-3xl leading-none safe-wrap">{b.name}</div>
                            <div className="text-xs muted mt-1 safe-wrap">每週扣款：{b.weeklyAmount}｜剩餘：{b.remainingWeeks} 週</div>
                          </div>
                          <div className="font-pixel text-3xl shrink-0">📌</div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="mt-3">
                <button className="neo-btn w-full px-3 py-3 bg-yellow-200 font-pixel text-3xl" onClick={openShop}>
                  打開商店
                </button>
              </div>

              <div className="mt-3 neo-card-soft p-3 bg-white">
                <div className="font-pixel text-3xl leading-none safe-wrap">記帳小工具</div>
                <div className="text-xs muted mt-1 safe-wrap">新增一筆收入或支出（會立刻影響餘額）。</div>

                <div className="mt-3 grid grid-cols-1 gap-2">
                  <input
                    className="w-full border-2 border-black rounded-xl px-3 py-2 text-sm"
                    placeholder="名稱（例如：餐費/交通/薪資）"
                    value={entryName}
                    onChange={(e)=>setEntryName(e.target.value)}
                  />
                  <input
                    className="w-full border-2 border-black rounded-xl px-3 py-2 text-sm"
                    placeholder="金額（正數）"
                    inputMode="numeric"
                    value={entryAmount}
                    onChange={(e)=>setEntryAmount(e.target.value)}
                  />
                </div>

                <div className="mt-3 grid grid-cols-2 gap-2">
                  <button className="neo-btn px-3 py-3 bg-emerald-200 font-pixel text-3xl" onClick={()=>addLedger(+1)}>
                    新增收入
                  </button>
                  <button className="neo-btn px-3 py-3 bg-white font-pixel text-3xl" onClick={()=>addLedger(-1)}>
                    新增支出
                  </button>
                </div>

                <div className="mt-3">
                  <div className="text-xs muted safe-wrap">最近 5 筆記帳：</div>
                  <div className="mt-2 space-y-1">
                    {ledger.slice(-5).reverse().map(x=>(
                      <div key={x.id} className="text-sm safe-wrap">
                        • {x.name}：{x.amount>0?"+":""}{formatMoney(x.amount)}
                      </div>
                    ))}
                    {ledger.length === 0 ? <div className="text-xs muted mt-1 safe-wrap">尚無記帳資料。</div> : null}
                  </div>
                </div>
              </div>

              <div className="mt-3">
                <button
                  className="neo-btn w-full px-3 py-3 bg-white font-pixel text-3xl"
                  onClick={()=>{
                    if(stats.week >= stats.maxWeeks){
                      openEndModal();
                    }else{
                      pushLog(`[W${stats.week}] 你查看了結算條件。`);
                      spawnFloat("查看結算", "good");
                    }
                  }}
                >
                  查看結算／結局
                </button>
              </div>
            </div>
          </div>
        );
      }

      /***********************
       * Modal：Quiz
       ***********************/
      function QuizModal({ payload }){
        const { title, questions, onPass, onFail, passLabel } = payload;
        const [answers, setAnswers] = useState(()=>questions.map(()=>null));

        function choose(qIndex, optionIndex){
          setAnswers(prev=>{
            const next = prev.slice();
            next[qIndex] = optionIndex;
            return next;
          });
        }

        function submit(){
          const allAnswered = answers.every(a=>a!==null && a!==undefined);
          if(!allAnswered){
            pushLog(`[W${stats.week}] 你尚未完成所有題目。`);
            spawnFloat("題目未完成", "bad");
            return;
          }
          const correct = answers.every((a, i)=>a === questions[i].a);
          if(correct){
            onPass && onPass();
          }else{
            onFail && onFail();
          }
        }

        return (
          <ModalWrapper
            title={title}
            onClose={()=>{
              // 允許關閉視為失敗（避免卡住）
              onFail && onFail();
            }}
            footer={
              <div className="grid grid-cols-2 gap-2">
                <button className="neo-btn px-3 py-3 bg-white font-pixel text-3xl" onClick={()=>{ onFail && onFail(); }}>
                  取消
                </button>
                <button className="neo-btn px-3 py-3 bg-emerald-200 font-pixel text-3xl" onClick={submit}>
                  {passLabel || "送出"}
                </button>
              </div>
            }
          >
            <div className="text-xs muted safe-wrap">提示：需作答 {questions.length} 題；全對才算通過。</div>
            <div className="mt-3 space-y-3">
              {questions.map((q, qi)=>(
                <div key={qi} className="neo-card-soft p-3 bg-white">
                  <div className="font-pixel text-3xl leading-tight safe-wrap">
                    {qi+1}. {q.q}
                  </div>
                  <div className="mt-2 grid grid-cols-1 gap-2">
                    {q.options.map((opt, oi)=>{
                      const selected = answers[qi] === oi;
                      return (
                        <button
                          key={oi}
                          className={"neo-btn px-3 py-3 text-left text-sm bg-white " + (selected ? "ring-4 ring-indigo-200" : "")}
                          onClick={()=>choose(qi, oi)}
                        >
                          <div className="safe-wrap">{opt}</div>
                        </button>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </ModalWrapper>
        );
      }

      /***********************
       * Modal：Event
       ***********************/
      function EventModal({ scenarioId }){
        const sc = SCENARIOS[scenarioId];
        if(!sc) return null;

        function closeToHome(){
          setModal(null);
          setScreen("home");
        }

        function applyScenarioChoice(choice){
          const delta = (typeof choice.effect === "function") ? (choice.effect({ ...stats, items })) : {};
          if(delta) applyDelta(delta);
          if(choice.log) pushLog(`[W${stats.week}] ${choice.log}`);
          closeToHome();
        }

        function resolveSimpleScamOrAccident(){
          if(sc.id === "police"){
            const out = sc.apply({ ...stats, items, hasHouse, houseType });
            if(out && out.delta) applyDelta(out.delta);
            if(out && out.log) pushLog(`[W${stats.week}] ${out.log}`);
            closeToHome();
            return;
          }

          // sickness / accident : 是否有保險
          if(sc.id === "sickness" || sc.id === "accident"){
            const hasIns = !!items.insurance;
            const out = hasIns ? sc.pass : sc.fail;
            applyDelta(out.delta);
            pushLog(`[W${stats.week}] ${out.log}`);
            closeToHome();
            return;
          }

          // scam_* : security 閾值判斷
          if(sc.id === "scam_romance" || sc.id === "scam_job"){
            const pass = stats.security >= (sc.threshold || 60);
            const out = pass ? sc.pass : sc.fail;
            applyDelta(out.delta);
            pushLog(`[W${stats.week}] ${out.log}`);
            closeToHome();
            return;
          }
        }

        return (
          <ModalWrapper
            title={sc.title}
            onClose={closeToHome}
            footer={
              sc.choices ? (
                <div className="grid grid-cols-1 gap-2">
                  {sc.choices.map((c, idx)=>(
                    <button key={idx} className="neo-btn px-3 py-3 bg-white font-pixel text-3xl" onClick={()=>applyScenarioChoice(c)}>
                      {c.label}
                    </button>
                  ))}
                </div>
              ) : (
                <div className="grid grid-cols-1 gap-2">
                  <button className="neo-btn px-3 py-3 bg-emerald-200 font-pixel text-3xl" onClick={resolveSimpleScamOrAccident}>
                    確認
                  </button>
                </div>
              )
            }
          >
            <div className="text-sm safe-wrap">{sc.desc}</div>
            {sc.id === "scam_romance" || sc.id === "scam_job" ? (
              <div className="mt-3 text-xs muted safe-wrap">
                判定：你的資安 {stats.security}（門檻 {sc.threshold}）。
              </div>
            ) : null}
            {sc.id === "police" ? (
              <div className="mt-3 text-xs muted safe-wrap">
                判定：年齡 {stats.age}｜良民證：{items.good_citizen_card ? "有" : "無"}
              </div>
            ) : null}
            {sc.id === "sickness" || sc.id === "accident" ? (
              <div className="mt-3 text-xs muted safe-wrap">
                判定：保險：{items.insurance ? "有" : "無"}
              </div>
            ) : null}
          </ModalWrapper>
        );
      }

      /***********************
       * Modal：Shop
       ***********************/
      function ShopModal(){
        const [payMethod, setPayMethod] = useState("cash"); // cash | credit | bnpl
        const [selectedId, setSelectedId] = useState(null);

        function close(){
          setModal(null);
        }

        function buy(){
          const item = SHOP_ITEMS.find(x=>x.id===selectedId);
          if(!item){
            pushLog(`[W${stats.week}] 請先選擇商品。`);
            spawnFloat("未選商品", "bad");
            return;
          }

          // 年齡限制：信用卡/BNPL 需 18+
          if((payMethod === "credit" || payMethod === "bnpl") && stats.age < 18){
            pushLog(`[W${stats.week}] 你未滿 18，不能使用信用卡/分期。`);
            spawnFloat("未滿 18", "bad");
            return;
          }

          // 詐騙品項
          if(item.scam){
            applyDelta({ money: -item.price, mood: -25, security: -8 });
            pushLog(`[W${stats.week}] 你購買了「${item.title}」，結果是投資詐騙（大幅損失）。`);
            close();
            return;
          }

          // 付款方式
          if(payMethod === "cash"){
            applyDelta({ money: -item.price });
            pushLog(`[W${stats.week}] 你以現金購買「${item.title}」-${item.price}。`);
          } else if(payMethod === "credit"){
            // 下週扣款
            const bill = { id: nowId(), name: `信用卡：${item.title}`, weeklyAmount: item.price, remainingWeeks: 1 };
            setBills(prev=>prev.concat([bill]));
            pushLog(`[W${stats.week}] 你使用信用卡購買「${item.title}」（下週扣款 ${item.price}）。`);
          } else if(payMethod === "bnpl"){
            // BNPL：總價+20% 分4週扣
            const total = Math.round(item.price * 1.2);
            const weekly = Math.ceil(total / 4);
            const bill = { id: nowId(), name: `分期：${item.title}`, weeklyAmount: weekly, remainingWeeks: 4 };
            setBills(prev=>prev.concat([bill]));
            pushLog(`[W${stats.week}] 你使用分期購買「${item.title}」（總額 ${total}，每週扣 ${weekly}，共 4 週）。`);
          }

          // 道具/效果
          if(item.grantItem){
            setItems(prev=>({ ...prev, [item.grantItem]: true }));
            pushLog(`[W${stats.week}] 你獲得道具：${item.grantItem === "insurance" ? "保險" : item.grantItem}。`);
          }

          if(item.effect){
            applyDelta(item.effect);
          }

          // 記任務：買健保或保險可算資源連結的一部分（輕量）
          if(item.id === "nhicard" || item.id === "acc_ins"){
            markMission("resource_link");
          }

          close();
        }

        return (
          <ModalWrapper
            title="商店"
            onClose={close}
            footer={
              <div className="grid grid-cols-2 gap-2">
                <button className="neo-btn px-3 py-3 bg-white font-pixel text-3xl" onClick={close}>關閉</button>
                <button className="neo-btn px-3 py-3 bg-emerald-200 font-pixel text-3xl" onClick={buy}>購買</button>
              </div>
            }
          >
            <div className="neo-card-soft p-2 bg-white">
              <div className="font-pixel text-3xl leading-none safe-wrap">付款方式</div>
              <div className="mt-2 grid grid-cols-3 gap-2">
                <button className={"neo-btn px-2 py-2 font-pixel text-2xl " + (payMethod==="cash" ? "bg-emerald-200" : "bg-white")} onClick={()=>setPayMethod("cash")}>現金</button>
                <button className={"neo-btn px-2 py-2 font-pixel text-2xl " + (payMethod==="credit" ? "bg-yellow-200" : "bg-white")} onClick={()=>setPayMethod("credit")}>信用卡</button>
                <button className={"neo-btn px-2 py-2 font-pixel text-2xl " + (payMethod==="bnpl" ? "bg-sky-200" : "bg-white")} onClick={()=>setPayMethod("bnpl")}>分期</button>
              </div>
              <div className="text-xs muted mt-2 safe-wrap">信用卡/分期需年滿 18 歲。</div>
            </div>

            <div className="mt-3 space-y-2">
              {SHOP_ITEMS.map(it=>{
                const sel = selectedId === it.id;
                return (
                  <button
                    key={it.id}
                    className={"neo-btn w-full p-3 text-left bg-white " + (sel ? "ring-4 ring-indigo-200" : "")}
                    onClick={()=>setSelectedId(it.id)}
                  >
                    <div className="flex items-start justify-between gap-2">
                      <div className="min-w-0">
                        <div className="font-pixel text-3xl leading-none safe-wrap">{it.title}</div>
                        <div className="text-xs muted mt-1 safe-wrap">{it.desc}</div>
                      </div>
                      <div className={"neo-chip font-pixel text-2xl shrink-0 " + (it.scam ? "bg-red-100" : "bg-white")}>
                        {formatMoney(it.price)}
                      </div>
                    </div>
                    {it.scam ? (
                      <div className="mt-2 text-xs text-red-700 safe-wrap">⚠️ 這是詐騙陷阱（買了只會受傷）。</div>
                    ) : null}
                  </button>
                );
              })}
            </div>
          </ModalWrapper>
        );
      }

      /***********************
       * Modal：End
       ***********************/
      function EndModal({ payload }){
        const { isWin, title, tasks, achievements, warm } = payload;
        const tasksText = `任務完成數：${tasks} / 3（住處/工作/資源）`;

        return (
          <ModalWrapper
            title={`第 8 週結算：你的結局`}
            onClose={()=>{
              // 結局允許關閉回到 home（但仍可再開）
              setModal(null);
              setScreen("home");
            }}
            footer={
              <div className="grid grid-cols-2 gap-2">
                <button className="neo-btn px-3 py-3 bg-yellow-200 font-pixel text-3xl" onClick={resetGame}>
                  再玩一次
                </button>
                <button className="neo-btn px-3 py-3 bg-white font-pixel text-3xl" onClick={()=>{ setModal(null); setScreen("home"); }}>
                  關閉
                </button>
              </div>
            }
          >
            <div className={"neo-card-soft p-3 " + (isWin ? "bg-emerald-50" : "bg-red-50")}>
              <div className="flex items-center gap-2">
                <div className="text-black">{isWin ? <IconCheck/> : <IconAlert/>}</div>
                <div className="font-pixel text-4xl leading-none safe-wrap">{isWin ? "通關成功（Happy Ending）" : "未通關（Bad Ending）"}</div>
              </div>
              <div className="mt-2 text-sm safe-wrap">
                存款：<b>{formatMoney(stats.money)}</b><br/>
                {tasksText}
              </div>
              <div className="mt-2 text-xs muted safe-wrap">
                勝利條件：第 8 週結算時，存款 &gt; 0 且 任務 ≥ 2。
              </div>
            </div>

            <div className="mt-3 neo-card-soft p-3 bg-white">
              <div className="font-pixel text-4xl leading-none safe-wrap">結局稱號</div>
              <div className="mt-2 text-sm safe-wrap"><b>{title}</b></div>
            </div>

            <div className="mt-3 neo-card-soft p-3 bg-white">
              <div className="font-pixel text-4xl leading-none safe-wrap">成就標籤</div>
              <div className="mt-2 flex flex-wrap gap-2">
                {(achievements.length ? achievements : ["（尚無）"]).map((a, idx)=>(
                  <span key={idx} className="neo-chip bg-indigo-100 font-pixel text-2xl safe-wrap">{a}</span>
                ))}
              </div>
            </div>

            <div className="mt-3 neo-card-soft p-3 bg-white">
              <div className="font-pixel text-4xl leading-none safe-wrap">溫暖評語</div>
              <div className="mt-2 text-sm safe-wrap">{warm}</div>
            </div>
          </ModalWrapper>
        );
      }

      /***********************
       * 結局與成就
       ***********************/
      function getEndingTitle({ money, hasHouse, tasks }){
        if(money < 0){
          return "負債累累的倖存者";
        }
        if(money >= 0 && tasks < 2){
          return "漂泊的努力者（資源仍不足）";
        }
        // win
        if(money > 15000 && hasHouse){
          return "自立自強的模範生";
        }
        if(money > 0 && hasHouse){
          return "穩定前進的自立新手";
        }
        return "翻盤成功的行動派";
      }

      function getAchievements({ stats, hasHouse, missions, items, ledger, bills, logs }){
        const a = [];
        if(hasHouse || missions.stable_house) a.push("有殼蝸牛");
        if(missions.stable_job) a.push("穩定打工人");
        if(missions.resource_link) a.push("善用資源");
        if(items.accompaniment_card) a.push("懂得求助");
        if(items.good_citizen_card) a.push("良民認證");
        if(items.insurance) a.push("風險管理");
        if(ledger && ledger.length >= 3) a.push("記帳習慣");
        if(stats.money >= 8000) a.push("理財達人");
        if((bills||[]).length >= 2) a.push("分期觀察員");
        // 防詐修煉：若 logs 出現詐騙相關
        const scamHit = (logs||[]).some(l => String(l).includes("詐騙"));
        if(scamHit) a.push("防詐修煉");
        return a.slice(0, 10);
      }

      function getWarmComment({ isWin, stats, tasks, hasHouse }){
        if(isWin){
          return "你不只撐過 8 週，還建立了至少兩項穩定支點（住處／工作／資源）。這代表你在現實中也具備把生活拉回穩定的能力。接下來可以把「記帳、求助、風險辨識」變成習慣，讓自立更穩。";
        }
        // 失敗：鼓勵 + 指引
        const parts = [];
        if(stats.money < 0){
          parts.push("你的結算出現赤字，可能與衝動消費、詐騙或缺乏預備金有關。先把固定支出列出、建立『先活下來』的預算。");
        } else {
          parts.push("你雖然沒有負債，但穩定支點不足（住處／工作／資源未達 2）。這表示生活仍容易被突發事件打亂。");
        }
        if(!hasHouse){
          parts.push("建議優先把『安全住處』當作第一目標：若未滿 18，可先申請社工陪同或嘗試 CCSA 宿舍。");
        }
        parts.push("如果你願意，下一輪可以把策略改成：先連結資源 → 再穩定工作 → 再提升資安與預備金。");
        return parts.join(" ");
      }

      /***********************
       * 主畫面渲染
       ***********************/
      function renderMain(){
        if(screen === "onboarding") return renderOnboarding();
        if(screen === "home") return renderHome();
        if(screen === "app_job") return renderJobApp();
        if(screen === "app_house") return renderHouseApp();
        if(screen === "app_resource") return renderResourceApp();
        if(screen === "app_finance") return renderFinanceApp();
        return renderHome();
      }

      // 當週數達 maxWeeks 並且使用者仍在遊戲內，可提示結算
      useEffect(()=>{
        if(stats.week >= stats.maxWeeks){
          pushLog(`[W${stats.week}] 你已到達第 8 週，可查看結算。`);
        }
      }, [stats.week]);

      // Modal 控制（避免進財務壞掉：任何 modal 都要確保 payload 合法）
      function renderModal(){
        if(!modal) return null;
        if(modal.type === "quiz"){
          const payload = modal;
          return <QuizModal payload={payload} />;
        }
        if(modal.type === "event"){
          return <EventModal scenarioId={modal.scenarioId} />;
        }
        if(modal.type === "shop"){
          return <ShopModal />;
        }
        if(modal.type === "end"){
          return <EndModal payload={modal} />;
        }
        return null;
      }

      // 進入第 8 週並按下結算時也可顯示 end
      useEffect(()=>{
        if(stats.week === stats.maxWeeks && screen === "home"){
          // 不自動彈，避免干擾；由使用者按「查看結算／結局」
        }
      }, [stats.week, screen]);

      // 手機白色內容區：確保 min-h-0 才不會捲動壞掉
      const screenClass = "screen " + (glitchOn ? "glitch" : "");

      return (
        <div className="w-full h-full flex items-center justify-center p-4">
          <div className="phone-shell">
            <div className="side-btn left1"></div>
            <div className="side-btn left2"></div>
            <div className="side-btn right1"></div>

            <div className="phone-glass">
              <div className="notch"></div>

              <div className={screenClass}>
                <div className="screen-inner flex flex-col min-h-0">
                  <div className="scanlines"></div>

                  <StatBar stats={stats} livingCost={livingCost} />

                  <div className="screen-scroll flex-1 min-h-0">
                    {renderMain()}
                    <div className="h-10"></div>
                  </div>

                  <FloatingTextOverlay items={floatTexts} />
                  {renderModal()}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // 啟動
    try{
      const rootEl = document.getElementById('root');
      ReactDOM.createRoot(rootEl).render(<App />);
    }catch(e){
      const el = document.getElementById('error-message');
      if(el){
        el.style.display = 'block';
        el.textContent = "⚠️ 啟動失敗\n\n" + (e && e.stack ? e.stack : String(e));
      }
      throw e;
    }
  </script>
</body>
</html>
