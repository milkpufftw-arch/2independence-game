<!DOCTYPE html>

<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>自立大冒險 - 自立生活模擬器</title>

  <!-- Tailwind CSS -->

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 / ReactDOM 18 -->

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>

  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Fonts -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0b0b0b;
      --paper:#ffffff;
      --bg1:#071022;
      --bg2:#0a1a35;
      --neo:#000;
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --cyan:#06b6d4;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 50% 25%, rgba(45, 110, 230, 0.18), transparent 55%),
                  linear-gradient(180deg, var(--bg2), var(--bg1));
      font-family: "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }

    .font-pixel{ font-family: "VT323", monospace; letter-spacing: 0.3px; }

    /* phone shell */
    .phone-shell{
      width: 390px;
      max-width: 92vw;
      height: 760px;
      max-height: 86vh;
      border-radius: 36px;
      background: linear-gradient(180deg, #111827, #0b1220);
      border: 2px solid rgba(255,255,255,0.08);
      box-shadow: 0 30px 90px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.05);
      position: relative;
      padding: 18px;
    }
    .notch{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 170px;
      height: 32px;
      border-radius: 16px;
      background: rgba(0,0,0,0.65);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      z-index: 5;
    }
    .side-btn{
      position:absolute;
      left:-5px;
      width: 6px;
      border-radius: 4px;
      background: rgba(255,255,255,0.12);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35);
    }
    .side-btn.b1{ top:120px; height: 46px; }
    .side-btn.b2{ top:182px; height: 62px; }
    .side-btn.b3{ top:262px; height: 62px; }
    .side-btn.r1{
      left:auto; right:-5px; top:170px; height: 86px;
    }

    .screen{
      height: 100%;
      border-radius: 26px;
      background: #f8fafc;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,0.14);
    }

    /* scanlines */
    .scanlines::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,0.04),
        rgba(0,0,0,0.04) 1px,
        rgba(255,255,255,0.0) 3px,
        rgba(255,255,255,0.0) 6px
      );
      mix-blend-mode: multiply;
      opacity: 0.55;
      z-index: 3;
    }

    /* neo */
    .neo-shadow{
      box-shadow: 0 10px 0 rgba(0,0,0,0.12);
    }
    .neo-card{
      background: #fff;
      border: 3px solid #000;
      border-radius: 18px;
      box-shadow: 7px 7px 0 #000;
    }
    .neo-soft{
      background: #fff;
      border: 2px solid #000;
      border-radius: 14px;
      box-shadow: 5px 5px 0 #000;
    }
    .neo-btn{
      border: 3px solid #000;
      border-radius: 16px;
      box-shadow: 5px 5px 0 #000;
      transform: translate(0,0);
      transition: transform 0.06s ease, box-shadow 0.06s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .neo-btn:active{
      transform: translate(3px,3px);
      box-shadow: 2px 2px 0 #000;
    }
    .neo-btn[disabled]{
      opacity: 0.55;
      filter: grayscale(0.4);
      cursor: not-allowed;
    }

    /* glitch */
    @keyframes glitchFlash{
      0%{ filter: none; }
      10%{ filter: contrast(1.2) saturate(1.4) hue-rotate(5deg); transform: translate(0,0); }
      20%{ filter: contrast(1.05) saturate(1.2) hue-rotate(-5deg); transform: translate(1px,0); }
      30%{ filter: contrast(1.2) saturate(1.4); transform: translate(-1px,0); }
      40%{ filter: none; transform: translate(0,0); }
      100%{ filter: none; transform: translate(0,0); }
    }
    .glitch-effect{
      animation: glitchFlash 0.55s ease-in-out 1;
    }

    /* modal pop */
    @keyframes modalPop{
      0%{ transform: translateY(18px) scale(0.98); opacity:0; }
      100%{ transform: translateY(0) scale(1); opacity:1; }
    }
    .modal-pop{ animation: modalPop 0.18s ease-out both; }

    /* Portal Modal */
    .modal-viewport{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 12px;
    }
    @media (min-width: 640px){
      .modal-viewport{ align-items: center; }
    }
    .modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.55);
    }
    .modal-box{
      position: relative;
      width: min(360px, 96vw);
      max-height: 78vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }
    .modal-header{
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
      padding-bottom: 8px;
    }
    .modal-footer{
      position: sticky;
      bottom: 0;
      background: #fff;
      z-index: 2;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.12);
    }

    /* content scroll */
    .content-scroll{
      position: relative;
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }

    /* terminal logs */
    .terminal{
      background: #071b10;
      border: 3px solid #000;
      border-radius: 18px;
      box-shadow: 7px 7px 0 #000;
      color: #86efac;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* floating text */
    @keyframes floatUp{
      0%{ transform: translateY(0); opacity:0; }
      15%{ opacity:1; }
      100%{ transform: translateY(-42px); opacity:0; }
    }
    .float-text{
      position:absolute;
      z-index: 20;
      font-weight: 800;
      text-shadow: 0 2px 0 rgba(0,0,0,0.35);
      animation: floatUp 0.9s ease-out both;
      pointer-events:none;
      font-family: "VT323", monospace;
      font-size: 30px;
      letter-spacing: 0.2px;
    }

    /* wheel */
    .wheel-wrap{
      width: 260px;
      height: 260px;
      border-radius: 999px;
      border: 4px solid #000;
      box-shadow: 7px 7px 0 #000;
      background: conic-gradient(
        #fde68a 0 36deg,
        #bfdbfe 36deg 144deg,
        #bbf7d0 144deg 252deg,
        #e9d5ff 252deg 324deg,
        #fecaca 324deg 360deg
      );
      position: relative;
      overflow:hidden;
    }
    .wheel-center{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .wheel-dot{
      width: 64px;
      height: 64px;
      border-radius: 999px;
      background:#fff;
      border: 4px solid #000;
      box-shadow: 5px 5px 0 #000;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:"VT323", monospace;
      font-size: 28px;
    }
    .wheel-pointer{
      width: 0;
      height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-top: 22px solid #000;
      position:absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,0.25));
    }

    /* error message box */
    #error-message{
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 18px;
      z-index: 10000;
      background: #fff1f2;
      border: 2px solid #be123c;
      border-radius: 14px;
      padding: 12px 14px;
      color: #9f1239;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      max-height: 32vh;
      overflow:auto;
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .error-title{
      font-weight: 900;
      margin-bottom: 6px;
    }

    /* Scrollbar (WebKit) */
    .content-scroll::-webkit-scrollbar,
    .modal-box::-webkit-scrollbar{
      width: 10px;
    }
    .content-scroll::-webkit-scrollbar-thumb,
    .modal-box::-webkit-scrollbar-thumb{
      background: rgba(0,0,0,0.2);
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.6);
    }
  </style>

</head>
<body>
  <div id="root"></div>
  <div id="modal-root"></div>
  <div id="error-message"></div>

  <script>
    (function(){
      const box = document.getElementById('error-message');
      function showErr(title, detail){
        try{
          box.style.display = 'block';
          box.innerHTML = '';
          const t = document.createElement('div');
          t.className = 'error-title';
          t.textContent = '⚠ 捕捉到錯誤（window.onerror / unhandledrejection）';
          const p = document.createElement('div');
          p.textContent = (title || '未知錯誤') + '\n' + (detail || '');
          box.appendChild(t);
          box.appendChild(p);
        }catch(e){}
      }

      window.onerror = function(message, source, lineno, colno, error){
        const detail =
          '訊息：' + String(message || '') + '\n' +
          '來源：' + String(source || '') + '\n' +
          '行：' + String(lineno || 0) + ' 列：' + String(colno || 0) + '\n' +
          (error && error.stack ? ('堆疊：\n' + error.stack) : '');
        showErr('Script error.', detail);
        return false;
      };

      window.addEventListener('unhandledrejection', function(ev){
        const r = ev && ev.reason ? ev.reason : 'Promise rejection';
        const detail =
          (r && r.stack ? r.stack : String(r)) + '\n' +
          '（提示：若你部署在 Vercel，請確認 HTML 內 CDN 未被 CSP 擋住）';
        showErr('Uncaught (in promise).', detail);
      });
    })();
  </script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /***********************
     * Utils
     ***********************/
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }
    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function pickByProbability(items){
      // items: [{key, prob, ...}]
      const r = Math.random();
      let acc = 0;
      for(const it of items){
        acc += it.prob;
        if(r <= acc) return it;
      }
      return items[items.length-1];
    }
    function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

    /***********************
     * Data (必內建)
     ***********************/
    const INITIAL_STATS = {
      money: 0,
      health: 100,
      mood: 55,
      security: 55,
      week: 1,
      maxWeeks: 8,
      age: 16,
      ap: 3,
      maxAp: 3,
    };

    const CHARACTER_ORIGINS = [
      { key:"A", label:"A：極度匱乏", money:0,    prob:0.10, desc:"起點很硬，得更會用資源與規劃。" },
      { key:"B", label:"B：偏低",     money:2000, prob:0.30, desc:"有一點緩衝，但仍要小心。" },
      { key:"C", label:"C：一般",     money:4000, prob:0.30, desc:"一般起點，靠決策拉開差距。" },
      { key:"D", label:"D：略高",     money:6000, prob:0.20, desc:"稍有餘裕，但仍可能被意外拖垮。" },
      { key:"E", label:"E：相對穩定", money:8000, prob:0.10, desc:"起點較好，但自立仍需要支持系統。" },
    ];

    const GENERIC_JOB_QUESTIONS = [
      {
        id:"gj_1",
        q:"面試時，主管問你「為何想來」較適合的回答？",
        options:["因為離家近就好","我想累積工作經驗，願意學習","朋友叫我來","隨便找個地方"],
        a:1
      },
      {
        id:"gj_2",
        q:"打卡/排班遇到問題，第一步應該？",
        options:["直接不來","先和主管/同事確認規則並提前說明","發脾氣","上網抱怨"],
        a:1
      },
      {
        id:"gj_3",
        q:"遇到客人抱怨時較適當的做法？",
        options:["先反駁","先聽完、道歉並回報主管","把客人趕走","直接走掉"],
        a:1
      },
      {
        id:"gj_4",
        q:"通勤太遠影響出勤，你可以？",
        options:["繼續遲到","提前規劃路線或討論調班","不通知直接離職","每天碰運氣"],
        a:1
      },
    ];

    const JOBS = [
      {
        id:"job_flyer",
        title:"派報/傳單",
        wage:190,
        energy:10,
        mood:-2,
        minAge:15,
        strictAge:false,
        apCost:1,
        desc:"走路多、口頭溝通少，適合短期賺現金。",
        interviews:[
          { id:"j1q1", q:"遇到路人拒絕拿傳單，你怎麼做？", options:["硬塞","說聲謝謝、尊重對方","罵他","丟地上"], a:1 },
          { id:"j1q2", q:"派報最重要的是？", options:["速度","禮貌與守時","講八卦","跟人吵架"], a:1 },
        ],
      },
      {
        id:"job_store",
        title:"超商工讀",
        wage:185,
        energy:12,
        mood:-1,
        minAge:16,
        strictAge:false,
        apCost:1,
        desc:"結帳、補貨、服務應對，需要耐心。",
        interviews:[
          { id:"j2q1", q:"收銀找零最重要的是？", options:["靠感覺","按流程核對金額","隨便找","請客人自己算"], a:1 },
          { id:"j2q2", q:"遇到尖峰排隊，你應該？", options:["慢慢來","保持速度與正確、需要時求助","直接關機","跟客人吵"], a:1 },
        ],
      },
      {
        id:"job_food",
        title:"餐飲外場",
        wage:190,
        energy:14,
        mood:-2,
        minAge:16,
        strictAge:false,
        apCost:1,
        desc:"走動多、需要團隊合作與服務禮貌。",
        interviews:[
          { id:"j3q1", q:"客人催餐，你的處理方式？", options:["不理他","先致歉並回廚房確認","回嗆","裝沒聽到"], a:1 },
        ],
      },
      {
        id:"job_tutor",
        title:"補習班工讀",
        wage:200,
        energy:10,
        mood:+1,
        minAge:17,
        strictAge:false,
        apCost:1,
        desc:"點名、影印、帶班，需要細心。",
        interviews:[
          { id:"j4q1", q:"帶班時孩子吵鬧，你應該？", options:["放任","用規範與溫和提醒、必要時請老師協助","吼叫","直接走掉"], a:1 },
        ],
      },
      {
        id:"job_construction",
        title:"工地臨時工",
        wage:230,
        energy:18,
        mood:-3,
        minAge:18,
        strictAge:true,
        apCost:1,
        desc:"薪高但耗體力，安全規範很重要。",
        interviews:[
          { id:"j5q1", q:"工地安全第一步？", options:["不戴安全帽","遵守安全規範與穿戴護具","快點做完","看別人怎樣"], a:1 },
        ],
      },
      {
        id:"job_delivery",
        title:"外送（步行/自行車）",
        wage:195,
        energy:15,
        mood:-1,
        minAge:16,
        strictAge:false,
        apCost:1,
        desc:"看天氣、看體力，時間管理很重要。",
        interviews:[
          { id:"j6q1", q:"接單時最該注意？", options:["越多越好","路線與時間安排，避免超時","不看地址","隨緣"], a:1 },
        ],
      },
      {
        id:"job_tasting",
        title:"試吃/促銷",
        wage:200,
        energy:12,
        mood:-1,
        minAge:16,
        strictAge:false,
        apCost:1,
        desc:"需要主動招呼與簡單介紹商品。",
        interviews:[
          { id:"j7q1", q:"促銷介紹時適合？", options:["誇大保證","誠實說明、強調亮點","逼人買","說謊"], a:1 },
        ],
      },
      {
        id:"job_gas",
        title:"加油站工讀",
        wage:195,
        energy:13,
        mood:-1,
        minAge:17,
        strictAge:false,
        apCost:1,
        desc:"需注意安全、流程、禮貌。",
        interviews:[
          { id:"j8q1", q:"加油流程最怕？", options:["照流程就好","不確認油種與金額","多聊天","不回應"], a:1 },
        ],
      },
    ];

    const HOUSING = [
      {
        id:"house_ccsa",
        title:"CCSA 自立宿舍",
        type:"ccsa",
        rent:0,
        deposit:0,
        security:+10,
        desc:"有規範、有支持，穩定度高。",
        quizKey:"ccsa_interview",
        isCCSA:true
      },
      {
        id:"house_rooftop",
        title:"頂樓加蓋雅房",
        type:"rooftop",
        rent:4500,
        deposit:4500,
        security:-5,
        desc:"便宜但風險較高，合約與安全要注意。",
        quizKey:"contract_check",
        isCCSA:false
      },
      {
        id:"house_basement",
        title:"地下室分租套房",
        type:"basement",
        rent:5200,
        deposit:5200,
        security:-3,
        desc:"潮濕、逃生要留意。",
        quizKey:"house_check",
        isCCSA:false
      },
      {
        id:"house_shared",
        title:"合租公寓（室友）",
        type:"shared",
        rent:6000,
        deposit:6000,
        security:+1,
        desc:"生活費分攤，但需要溝通與規則。",
        quizKey:"rule_check",
        isCCSA:false
      },
      {
        id:"house_dorm",
        title:"青年旅館長住床位",
        type:"dorm",
        rent:3500,
        deposit:3500,
        security:-2,
        desc:"彈性但隱私與安全一般。",
        quizKey:"house_check",
        isCCSA:false
      },
      {
        id:"house_relative",
        title:"借住親戚（不收租）",
        type:"relative",
        rent:0,
        deposit:0,
        security:+2,
        desc:"成本低，但人際界線要清楚。",
        quizKey:"relative_check",
        isCCSA:false
      },
      {
        id:"house_coliving",
        title:"共居空間（含公設）",
        type:"coliving",
        rent:7500,
        deposit:7500,
        security:+2,
        desc:"舒適但費用較高，合約要看清楚。",
        quizKey:"contract_check",
        isCCSA:false
      },
      {
        id:"house_studio",
        title:"獨立套房（小套）",
        type:"studio",
        rent:9000,
        deposit:9000,
        security:+3,
        desc:"最有隱私但最吃錢，收支要算好。",
        quizKey:"contract_check",
        isCCSA:false
      },
    ];

    const SHOP_ITEMS = [
      { id:"item_bento", name:"便當", price:120, desc:"補充能量 +3 心情 +1", effect:{health:+3,mood:+1}, ageMin:15 },
      { id:"item_b_vitamins", name:"B 群", price:180, desc:"體力 +6", effect:{health:+6}, ageMin:15 },
      { id:"item_milktea", name:"手搖飲", price:70, desc:"心情 +4", effect:{mood:+4}, ageMin:15 },
      { id:"item_clothes", name:"新衣", price:800, desc:"心情 +10", effect:{mood:+10}, ageMin:15 },
      { id:"item_concert", name:"演唱會", price:1800, desc:"心情 +18（但要量力）", effect:{mood:+18}, ageMin:15 },
      { id:"item_phone", name:"iPhone（分期誘惑）", price:28000, desc:"心情 +6（但很傷荷包）", effect:{mood:+6}, ageMin:15, big:true },
      { id:"item_health_ins", name:"健保（道具）", price:500, desc:"獲得「健保」：生病事件較容易過關", itemGrant:"health_insurance", ageMin:15 },
      { id:"item_acc_ins", name:"意外險（道具）", price:650, desc:"獲得「意外險」：意外事件較容易過關", itemGrant:"accident_insurance", ageMin:15 },
      { id:"item_credit", name:"信用卡（道具）", price:0, desc:"18+ 可申請：開啟信用支付（但別濫用）", itemGrant:"credit_card", ageMin:18, special:"creditCard" },
      { id:"item_scam_stock", name:"飆股內線（投資詐騙）", price:5000, desc:"高報酬保證＝高風險！", scam:true, ageMin:15 },
    ];

    const QUIZ_DB = {
      password_setup: {
        title:"第一關：手機密碼",
        pickOne:true,
        questions:[
          {
            id:"pw1",
            q:"你要怎麼設定手機密碼？",
            options:["123456（超好記）","開啟 2FA + 強密碼（較安全）"],
            a:1
          }
        ]
      },

      // Job Test (資源地圖：就業服務站)
      job_test: {
        title:"就業服務站：快速職場測驗",
        pickOne:false,
        questions:[
          { id:"jt1", q:"履歷最重要的是？", options:["亂寫也沒差","誠實與清楚","越浮誇越好","不寫"], a:1 },
          { id:"jt2", q:"面試遲到，你應該？", options:["裝沒事","提前通知並道歉","怪路人","不去"], a:1 },
          { id:"jt3", q:"第一份工作最重要累積？", options:["八卦","基本職場習慣與信用","跟人吵架","逃避"], a:1 },
        ]
      },

      welfare_help: {
        title:"社會福利中心：生活支持",
        pickOne:false,
        questions:[
          { id:"wh1", q:"申請資源前，最重要先做？", options:["先買好吃的","先盤點必要支出、保留緊急預備金","全部請客","先衝動消費"], a:1 },
          { id:"wh2", q:"財務補助最重要原則？", options:["拿到就花","用在必要支出與穩定生活","全部買娛樂","先買名牌"], a:1 },
        ]
      },

      finance_help: {
        title:"社會福利中心：急難財務補助（餘額 < 2000 才可）",
        pickOne:false,
        questions:[
          { id:"fh1", q:"急難補助較適合用在？", options:["飆股內線","房租/必要生活費","演唱會","買新手機"], a:1 },
          { id:"fh2", q:"補助到手後，第一件事？", options:["先請客","先還/先付必要支出，保留緊急金","先買娛樂","先打遊戲"], a:1 },
        ]
      },

      ccsa_aid: {
        title:"CCSA：經濟支持（協助）",
        pickOne:false,
        questions:[
          { id:"ca1", q:"申請支持最重要態度？", options:["全部要求","清楚表達需求與計畫、願意配合","隨便講","不說原因"], a:1 },
          { id:"ca2", q:"拿到支持金，優先用途？", options:["全部請客","必要支出、保留緊急預備金","買內線股","買遊戲"], a:1 },
        ]
      },

      ccsa_counseling: {
        title:"CCSA：心理諮商（情緒支持）",
        pickOne:false,
        questions:[
          { id:"cc1", q:"你現在最需要的是？", options:["忍耐就好","有人陪你整理情緒與壓力","假裝沒事","把怒氣丟給別人"], a:1 },
          { id:"cc2", q:"諮商的目的更像？", options:["被評分","練習覺察、找出更安全的做法","被控制","被批評"], a:1 },
        ]
      },

      ccsa_training: {
        title:"CCSA：自立培訓（提升行動力）",
        pickOne:false,
        questions:[
          { id:"ct1", q:"自立不是只有賺錢，還包含？", options:["只有買東西","生活規劃與資源連結","只靠運氣","只靠朋友"], a:1 },
          { id:"ct2", q:"最穩的自立策略？", options:["衝動決策","固定作息 + 記帳 + 求助資源","只買飆股","不溝通"], a:1 },
        ]
      },

      ccsa_interview: {
        title:"CCSA 自立宿舍：入住面談",
        pickOne:false,
        questions:[
          { id:"ci1", q:"宿舍規範的意義？", options:["限制你","確保安全與穩定","無聊","懲罰"], a:1 },
          { id:"ci2", q:"你願意配合哪些？", options:["都不配合","作息、訪客規範、共同空間維護","只配合錢","只配合自己想要的"], a:1 },
          { id:"ci3", q:"遇到困難的做法？", options:["消失","主動告知社工/宿舍管理，討論解法","爆炸","怪別人"], a:1 },
        ]
      },

      house_check: {
        title:"看房檢查：安全與環境",
        pickOne:false,
        questions:[
          { id:"hc1", q:"看房時要確認？", options:["只有裝潢","逃生動線/窗戶通風/漏水","只有網速","只有家具"], a:1 },
          { id:"hc2", q:"若房東不讓看合約就要簽？", options:["立刻簽","暫停，請求完整合約再決定","跪求簽","隨便"], a:1 },
        ]
      },

      contract_check: {
        title:"簽約檢查：合約與押金",
        pickOne:false,
        questions:[
          { id:"cck1", q:"合約最重要先確認？", options:["房東心情","租期/租金/押金/解約條件","隔壁八卦","電視大小"], a:1 },
          { id:"cck2", q:"押金收據？", options:["不用","一定要有，並寫清金額與日期","看心情","口頭就好"], a:1 },
          { id:"cck3", q:"若條款不清楚？", options:["直接簽","請對方補充或拍照留存、必要時詢問專業","罵人","不管"], a:1 },
        ]
      },

      rule_check: {
        title:"合租規則：室友協議",
        pickOne:false,
        questions:[
          { id:"rc1", q:"合租最容易衝突？", options:["天氣","清潔/費用/作息","鞋子顏色","外送口味"], a:1 },
          { id:"rc2", q:"避免衝突較好的做法？", options:["不講","先約定規則並寫下來","天天吵","靠運氣"], a:1 },
        ]
      },

      relative_check: {
        title:"借住親戚：界線與尊重",
        pickOne:false,
        questions:[
          { id:"rel1", q:"借住最重要是？", options:["佔用空間","尊重對方生活、先談界線","愛怎樣就怎樣","不打招呼"], a:1 },
          { id:"rel2", q:"若被要求分擔家務？", options:["拒絕","合理分擔，維持關係與互惠","消失","罵人"], a:1 },
        ]
      },
    };

    const SCENARIOS = {
      friend_loan:{
        id:"friend_loan",
        title:"朋友來借錢",
        body:"朋友說臨時周轉，想借你一筆。你要怎麼做？",
        options:[
          { label:"先評估自己生活費，只能借少量並訂還款日期", key:"safe" },
          { label:"全部借他（義氣最重要）", key:"risky" },
          { label:"直接拒絕，並建議他找正式管道", key:"refuse" },
        ]
      },
      scam_romance:{
        id:"scam_romance",
        title:"感情詐騙：甜蜜陷阱",
        body:"網路上有人對你很好，開始說要你幫忙代收款或先轉一筆。你怎麼辦？",
        options:[
          { label:"先查證、拒絕金流往來", key:"safe" },
          { label:"相信對方，先轉一筆", key:"risky" },
          { label:"提供個資給對方更方便", key:"very_risky" },
        ]
      },
      scam_job:{
        id:"scam_job",
        title:"求職詐騙：保證高薪",
        body:"有人說「保證高薪、先繳保證金/買點數」。你怎麼辦？",
        options:[
          { label:"拒絕先付費，改找正規求職管道", key:"safe" },
          { label:"先繳 3000 看看", key:"risky" },
          { label:"把網銀帳密交出去更快", key:"very_risky" },
        ]
      },
      accident:{
        id:"accident",
        title:"意外事件：擦撞受傷",
        body:"通勤途中發生意外，你需要處理醫療與休息。",
        options:[
          { label:"按流程處理、先休息（若有意外險較能扛）", key:"handle" },
          { label:"硬撐不管", key:"ignore" },
        ]
      },
      sickness:{
        id:"sickness",
        title:"生病了：感冒發燒",
        body:"你身體不舒服，需要休息或就醫。",
        options:[
          { label:"就醫休息（若有健保更穩）", key:"rest" },
          { label:"不管，繼續硬撐", key:"ignore" },
        ]
      },
      police:{
        id:"police",
        title:"臨檢：警察盤查",
        body:"夜間路上遇到臨檢，需要配合說明身分。",
        options:[
          { label:"冷靜配合、清楚說明", key:"cooperate" },
          { label:"情緒爆炸、拒絕配合", key:"panic" },
        ]
      },
    };

    /***********************
     * Icons (內建 SVG React Components)
     ***********************/
    function IconWrapper({ children }){
      return (
        <svg viewBox="0 0 24 24" className="w-7 h-7" fill="none" stroke="currentColor" strokeWidth="2.3" strokeLinecap="round" strokeLinejoin="round">
          {children}
        </svg>
      );
    }
    function IconHome(){ return <IconWrapper><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v10h14V10"/></IconWrapper>; }
    function IconHouse(){ return <IconWrapper><path d="M4 11 12 4l8 7"/><path d="M6 10v10h12V10"/><path d="M10 20v-6h4v6"/></IconWrapper>; }
    function IconBriefcase(){ return <IconWrapper><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M3 13h18"/></IconWrapper>; }
    function IconMap(){ return <IconWrapper><path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"/><path d="M9 3v15"/><path d="M15 6v15"/></IconWrapper>; }
    function IconWallet(){ return <IconWrapper><path d="M20 8V6a2 2 0 0 0-2-2H6a3 3 0 0 0 0 6h12a2 2 0 0 1 2 2v2"/><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M16 14h2"/></IconWrapper>; }
    function IconSpinner(){ return <IconWrapper><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></IconWrapper>; }
    function IconBack(){ return <IconWrapper><path d="M15 18l-6-6 6-6"/><path d="M9 12h12"/></IconWrapper>; }

    /***********************
     * UI Components
     ***********************/
    function StatPill({ label, value, colorClass }){
      return (
        <div className={"neo-soft px-3 py-2 flex-1 min-w-[92px]"}>
          <div className="flex items-end justify-between gap-2">
            <div className="font-pixel text-[22px] leading-none text-slate-900">{label}</div>
            <div className="font-pixel text-[26px] leading-none text-slate-900">{value}</div>
          </div>
          <div className="mt-2 h-3 w-full bg-slate-200 rounded-full overflow-hidden border border-slate-400">
            <div className={"h-full " + colorClass} style={{width: clamp(value,0,100) + "%"}}></div>
          </div>
        </div>
      );
    }

    function StatBar({ state, livingCost }){
      const apBoxes = [];
      for(let i=0;i<state.maxAp;i++){
        apBoxes.push(
          <div key={i} className={"w-4 h-4 border-2 border-black rounded-sm " + (i<state.ap ? "bg-amber-200" : "bg-white")}></div>
        );
      }
      return (
        <div className="p-3">
          <div className="neo-card p-3">
            <div className="flex items-center justify-between gap-3">
              <div className="min-w-0">
                <div className="font-pixel text-[26px] leading-none break-words">
                  第 {state.week}/{state.maxWeeks} 週
                  <span className="ml-2 font-sans text-xs text-slate-600">（本週基本支出：{livingCost}）</span>
                </div>
              </div>
              <div className="flex items-center gap-2 shrink-0">
                <div className="font-pixel text-[20px]">AP</div>
                <div className="flex gap-1">{apBoxes}</div>
              </div>
            </div>

            <div className="mt-3 flex gap-2">
              <StatPill label="體力" value={state.health} colorClass="bg-emerald-400" />
              <StatPill label="心情" value={state.mood} colorClass="bg-yellow-400" />
              <StatPill label="資安" value={state.security} colorClass="bg-sky-400" />
            </div>
          </div>
        </div>
      );
    }

    function AppIcon({ label, onClick, color, Icon }){
      return (
        <button onClick={onClick} className={"neo-btn w-full px-4 py-4 flex items-center justify-between gap-3 " + color}>
          <div className="flex items-center gap-3 min-w-0">
            <div className="neo-soft w-12 h-12 flex items-center justify-center bg-white shrink-0">
              <Icon />
            </div>
            <div className="min-w-0">
              <div className="font-pixel text-[28px] leading-none break-words">{label}</div>
              <div className="text-xs text-slate-700 mt-1 break-words">點我進入</div>
            </div>
          </div>
          <div className="font-pixel text-[26px]">→</div>
        </button>
      );
    }

    function FloatingTextOverlay({ floats }){
      return (
        <div className="absolute inset-0 pointer-events-none z-20">
          {floats.map(f => (
            <div
              key={f.id}
              className={"float-text " + (f.kind==="ok" ? "text-emerald-300" : f.kind==="warn" ? "text-amber-300" : "text-rose-300")}
              style={{ left: f.x + "px", top: f.y + "px" }}
            >
              {f.text}
            </div>
          ))}
        </div>
      );
    }

    function ModalWrapper({ title, children, onClose, footer }){
      const modalRoot = document.getElementById('modal-root') || document.body;

      React.useEffect(() => {
        const prev = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
        return () => { document.body.style.overflow = prev; };
      }, []);

      const node = (
        <div className="modal-viewport">
          <div className="modal-backdrop" onClick={onClose}></div>

          <div
            className="neo-card modal-box p-3 modal-pop"
            onClick={(e)=>e.stopPropagation()}
            onWheel={(e)=>e.stopPropagation()}
            onTouchMove={(e)=>e.stopPropagation()}
          >
            <div className="modal-header flex items-start justify-between gap-2">
              <div className="min-w-0">
                <div className="font-pixel text-[28px] leading-tight text-slate-900 break-words">
                  {title}
                </div>
              </div>
              <button className="neo-btn px-3 py-1 bg-white font-pixel text-2xl shrink-0" onClick={onClose}>
                關閉
              </button>
            </div>

            <div className="mt-2 text-sm text-slate-800 break-words whitespace-pre-wrap leading-relaxed">
              {children}
              <div className="h-16"></div>
            </div>

            {footer ? (
              <div className="modal-footer mt-2">
                {footer}
              </div>
            ) : null}
          </div>
        </div>
      );

      return ReactDOM.createPortal(node, modalRoot);
    }

    function QuizModal({ quizTitle, questions, onClose, onSubmit }){
      // questions: [{id,q,options,a}]
      const [answers, setAnswers] = useState(() => ({}));
      const [submitted, setSubmitted] = useState(false);
      const [result, setResult] = useState(null);

      const allAnswered = questions.every(q => typeof answers[q.id] === "number");

      function pick(qid, idx){
        setAnswers(prev => ({...prev, [qid]: idx}));
      }

      function submit(){
        if(!allAnswered) return;
        const correct = questions.every(q => answers[q.id] === q.a);
        setSubmitted(true);
        setResult(correct);
      }

      const footer = (
        <div className="flex gap-2">
          <button className="neo-btn flex-1 px-4 py-3 bg-white font-pixel text-[28px]" onClick={onClose}>取消</button>
          {!submitted ? (
            <button
              className={"neo-btn flex-1 px-4 py-3 font-pixel text-[28px] " + (allAnswered ? "bg-emerald-200" : "bg-slate-200")}
              onClick={submit}
              disabled={!allAnswered}
            >
              送出
            </button>
          ) : (
            <button
              className={"neo-btn flex-1 px-4 py-3 font-pixel text-[28px] " + (result ? "bg-emerald-200" : "bg-rose-200")}
              onClick={() => onSubmit(result)}
            >
              確認
            </button>
          )}
        </div>
      );

      return (
        <ModalWrapper
          title={quizTitle}
          onClose={onClose}
          footer={footer}
        >
          <div className="text-xs text-slate-600 mb-2">題目需全部答完才可送出。全對才算通過。</div>

          {questions.map((q, idx) => (
            <div key={q.id} className="neo-soft p-3 mb-3 bg-slate-50">
              <div className="font-pixel text-[26px] leading-tight break-words text-slate-900">
                {idx+1}. {q.q}
              </div>
              <div className="mt-2 flex flex-col gap-2">
                {q.options.map((opt, i) => {
                  const selected = answers[q.id] === i;
                  return (
                    <button
                      key={i}
                      className={"neo-btn px-3 py-3 text-left break-words " + (selected ? "bg-indigo-200" : "bg-white")}
                      onClick={() => pick(q.id, i)}
                      disabled={submitted}
                    >
                      <div className="font-sans text-sm">{opt}</div>
                    </button>
                  );
                })}
              </div>
            </div>
          ))}

          {submitted ? (
            <div className={"neo-soft p-3 " + (result ? "bg-emerald-50" : "bg-rose-50")}>
              <div className="font-pixel text-[28px]">{result ? "✅ 通過！" : "❌ 未通過"}</div>
              <div className="text-sm text-slate-700 mt-1">
                {result ? "做得好！你有抓到關鍵習慣。" : "別灰心：回到題目想想「安全、規劃、求助」三個核心。"}
              </div>
            </div>
          ) : null}
        </ModalWrapper>
      );
    }

    /***********************
     * Game Logic helpers
     ***********************/
    function calcLivingCost(state, house){
      let livingCost = 1500;
      if(state.hasHouse && house && !house.isCCSA) livingCost += 500;
      return livingCost;
    }

    function applyDelta(base, delta){
      // base: state-like
      const next = {...base};
      if(delta.money) next.money += delta.money;
      if(delta.health) next.health = clamp(next.health + delta.health, 0, 100);
      if(delta.mood) next.mood = clamp(next.mood + delta.mood, 0, 100);
      if(delta.security) next.security = clamp(next.security + delta.security, 0, 100);
      if(delta.ap) next.ap = clamp(next.ap + delta.ap, 0, next.maxAp);
      if(delta.maxAp) next.maxAp = clamp(next.maxAp + delta.maxAp, 1, 9);
      return next;
    }

    /***********************
     * Main App
     ***********************/
    function App(){
      const screenRef = useRef(null);

      const [state, setState] = useState(() => ({
        ...INITIAL_STATS,
        hasOnboarded:false,
        origin:null,
        hasHouse:false,
        houseId:"",
        houseName:"",
        bills: [],
        logs: [],
        inventory: {
          accompaniment_card:false,
          good_citizen_card:false,
          health_insurance:false,
          accident_insurance:false,
          credit_card:false,
        },
        ledger: [],
        missions: {
          stableHousing:false,
          stableWork:false,
          usedResources:false,
        },
        achievements: {}, // tag -> true
        jobSuccessCount: 0,
        resourceSuccessCount: 0,
      }));

      const [route, setRoute] = useState("start"); // start, home, app_house, app_job, app_resource, app_finance
      const [modal, setModal] = useState(null); // {type, ...}
      const [floats, setFloats] = useState([]);
      const [glitchTick, setGlitchTick] = useState(0);

      const currentHouse = useMemo(() => HOUSING.find(h => h.id === state.houseId) || null, [state.houseId]);

      const livingCost = useMemo(() => calcLivingCost(state, currentHouse), [state, currentHouse]);

      function pushLog(text){
        setState(s => {
          const logs = [{ id: uid("log"), text: `[W${s.week}] ${text}` }, ...s.logs].slice(0, 60);
          return { ...s, logs };
        });
      }

      function addFloat(kind, text){
        const rect = screenRef.current ? screenRef.current.getBoundingClientRect() : {left:0, top:0, width:320, height:640};
        const x = Math.floor((rect.width*0.18) + Math.random()*(rect.width*0.64));
        const y = Math.floor((rect.height*0.25) + Math.random()*(rect.height*0.35));
        const id = uid("flt");
        setFloats(prev => [...prev, { id, kind, text, x, y }]);
        setTimeout(() => {
          setFloats(prev => prev.filter(f => f.id !== id));
        }, 900);
      }

      function maybeGlitch(nextState){
        if(nextState.mood < 30 || nextState.security < 30){
          setGlitchTick(t => t+1);
        }
      }

      function changeState(patcher, floatHint=null){
        setState(prev => {
          const next = (typeof patcher === "function") ? patcher(prev) : patcher;
          if(floatHint){
            const { kind, text } = floatHint;
            addFloat(kind, text);
          }
          maybeGlitch(next);
          return next;
        });
      }

      function spendAP(cost=1){
        if(state.ap < cost) return false;
        changeState(s => ({...s, ap: s.ap - cost}));
        return true;
      }

      function grantAchievement(tag){
        setState(s => {
          if(s.achievements[tag]) return s;
          return { ...s, achievements: { ...s.achievements, [tag]: true } };
        });
      }

      function grantMission(key){
        setState(s => {
          if(s.missions[key]) return s;
          return { ...s, missions: { ...s.missions, [key]: true } };
        });
      }

      function resetGame(){
        setModal(null);
        setRoute("start");
        setFloats([]);
        setGlitchTick(0);
        setState({
          ...INITIAL_STATS,
          hasOnboarded:false,
          origin:null,
          hasHouse:false,
          houseId:"",
          houseName:"",
          bills: [],
          logs: [],
          inventory: {
            accompaniment_card:false,
            good_citizen_card:false,
            health_insurance:false,
            accident_insurance:false,
            credit_card:false,
          },
          ledger: [],
          missions: {
            stableHousing:false,
            stableWork:false,
            usedResources:false,
          },
          achievements: {},
          jobSuccessCount: 0,
          resourceSuccessCount: 0,
        });
      }

      /***********************
       * Onboarding Wheel
       ***********************/
      const [spinning, setSpinning] = useState(false);
      const [wheelDeg, setWheelDeg] = useState(0);

      function spinWheel(){
        if(spinning) return;
        setSpinning(true);
        const extra = 720 + Math.floor(Math.random()*720);
        setWheelDeg(d => d + extra);

        setTimeout(() => {
          const picked = pickByProbability(CHARACTER_ORIGINS);
          const age = 15 + Math.floor(Math.random()*5); // 15~19
          changeState(s => ({
            ...s,
            hasOnboarded:true,
            origin: picked,
            money: picked.money,
            age,
          }));
          pushLog(`命運轉盤結果：等級 ${picked.key}（${picked.label}），初始金額 ${picked.money} 元，年齡 ${age}。`);
          setSpinning(false);

          // show identity + password choices
          setModal({
            type:"identity",
            origin:picked,
            age,
          });
        }, 2000);
      }

      function choosePassword(option){
        // option: "weak" or "2fa"
        if(option === "weak"){
          changeState(s => ({
            ...s,
            security: clamp(s.security - 20, 0, 100),
          }), {kind:"bad", text:"資安 -20"});
          pushLog("你選擇了 123456：資安下降。");
        }else{
          changeState(s => ({
            ...s,
            security: clamp(s.security + 10, 0, 100),
          }), {kind:"ok", text:"資安 +10"});
          pushLog("你開啟了 2FA：資安提升。");
        }
        setModal(null);
        setRoute("home");
      }

      /***********************
       * Random Events
       ***********************/
      function triggerRandomEvent(){
        const roll = Math.random();
        if(roll > 0.60){
          // no event
          pushLog("本週無特殊事件。");
          return;
        }

        // weighted pick
        const basePool = [
          { key:"friend_loan", w: 2 },
          { key:"scam_romance", w: 2 },
          { key:"scam_job", w: 2 },
          { key:"accident", w: 1 },
          { key:"sickness", w: 1 },
        ];
        if(!state.hasHouse) basePool.push({ key:"police", w: 2 });
        if(state.health < 50) basePool.push({ key:"sickness", w: 2 });

        const totalW = sum(basePool.map(x=>x.w));
        let r = Math.random() * totalW;
        let chosen = basePool[0].key;
        for(const it of basePool){
          r -= it.w;
          if(r <= 0){ chosen = it.key; break; }
        }

        setModal({ type:"event", eventKey: chosen });
      }

      function resolveEvent(eventKey, choiceKey){
        const ev = SCENARIOS[eventKey];
        if(!ev) { setModal(null); return; }

        if(eventKey === "friend_loan"){
          if(choiceKey === "safe"){
            const loss = Math.min(500, Math.max(0, Math.floor(state.money*0.12)));
            changeState(s => ({...s, money: s.money - loss, mood: clamp(s.mood - 1,0,100)}), {kind:"warn", text:`金錢 -${loss}`});
            pushLog(`你借出少量並約定還款：金錢 -${loss}。`);
            grantAchievement("善用界線");
          }else if(choiceKey === "risky"){
            const loss = Math.min(2000, Math.max(800, Math.floor(state.money*0.35)));
            changeState(s => ({...s, money: s.money - loss, mood: clamp(s.mood - 8,0,100)}), {kind:"bad", text:`金錢 -${loss}`});
            pushLog(`你把大筆錢借出：金錢 -${loss}，心情下降。`);
          }else{
            changeState(s => ({...s, mood: clamp(s.mood + 1,0,100)}), {kind:"ok", text:"+1 心情"});
            pushLog("你婉拒借款並建議正式管道：心情微升。");
            grantAchievement("拒絕高手");
          }
        }

        if(eventKey === "scam_romance"){
          const threshold = 55; // security gate
          const passed = state.security >= threshold;
          if(choiceKey === "safe"){
            changeState(s => ({...s, security: clamp(s.security + 3,0,100), mood: clamp(s.mood + 1,0,100)}), {kind:"ok", text:"資安 +3"});
            pushLog("你先查證並拒絕金流：資安小幅提升。");
            grantAchievement("資安守門員");
          }else if(choiceKey === "risky"){
            if(passed){
              changeState(s => ({...s, security: clamp(s.security + 1,0,100), mood: clamp(s.mood - 2,0,100)}), {kind:"warn", text:"差點被騙"});
              pushLog("你差點轉帳，但最後覺得不對勁停下來。");
            }else{
              const loss = 2500;
              changeState(s => ({...s, money: s.money - loss, mood: clamp(s.mood - 12,0,100), security: clamp(s.security - 8,0,100)}), {kind:"bad", text:`金錢 -${loss}`});
              pushLog(`你被感情詐騙：金錢 -${loss}，資安下降。`);
            }
          }else{
            if(passed){
              changeState(s => ({...s, security: clamp(s.security - 3,0,100)}), {kind:"warn", text:"資安 -3"});
              pushLog("你差點交出個資，幸好即時停手：資安小降。");
            }else{
              const loss = 4500;
              changeState(s => ({...s, money: s.money - loss, mood: clamp(s.mood - 18,0,100), security: clamp(s.security - 15,0,100)}), {kind:"bad", text:`金錢 -${loss}`});
              pushLog(`你交出個資被盜用：金錢 -${loss}，資安大降。`);
            }
          }
        }

        if(eventKey === "scam_job"){
          const threshold = 55;
          const passed = state.security >= threshold;
          if(choiceKey === "safe"){
            changeState(s => ({...s, security: clamp(s.security + 3,0,100)}), {kind:"ok", text:"資安 +3"});
            pushLog("你拒絕先付費，改走正規求職：資安提升。");
            grantAchievement("防詐雷達");
          }else if(choiceKey === "risky"){
            if(passed){
              changeState(s => ({...s, mood: clamp(s.mood - 3,0,100)}), {kind:"warn", text:"小心詐騙"});
              pushLog("你差點付費，後來覺得怪怪的停下來。");
            }else{
              const loss = 3000;
              changeState(s => ({...s, money: s.money - loss, mood: clamp(s.mood - 10,0,100), security: clamp(s.security - 10,0,100)}), {kind:"bad", text:`金錢 -${loss}`});
              pushLog(`你付了保證金被騙：金錢 -${loss}。`);
            }
          }else{
            if(passed){
              changeState(s => ({...s, security: clamp(s.security - 8,0,100), mood: clamp(s.mood - 6,0,100)}), {kind:"warn", text:"資安 -8"});
              pushLog("你差點交出帳密，幸好被提醒停下來。");
            }else{
              const loss = 6000;
              changeState(s => ({...s, money: s.money - loss, mood: clamp(s.mood - 16,0,100), security: clamp(s.security - 18,0,100)}), {kind:"bad", text:`金錢 -${loss}`});
              pushLog(`你交出帳密被盜刷：金錢 -${loss}，資安重挫。`);
            }
          }
        }

        if(eventKey === "accident"){
          const hasIns = !!state.inventory.accident_insurance;
          if(choiceKey === "handle"){
            if(hasIns){
              changeState(s => ({...s, health: clamp(s.health - 6,0,100), mood: clamp(s.mood - 2,0,100)}), {kind:"warn", text:"意外險護航"});
              pushLog("意外險發揮作用：體力小降、心情小降。");
              grantAchievement("有保險更穩");
            }else{
              changeState(s => ({...s, health: clamp(s.health - 18,0,100), mood: clamp(s.mood - 6,0,100), money: s.money - 1200}), {kind:"bad", text:"意外花費"});
              pushLog("你需要支出醫療與休息成本：金錢 -1200，體力下降。");
            }
          }else{
            changeState(s => ({...s, health: clamp(s.health - 14,0,100), mood: clamp(s.mood - 8,0,100)}), {kind:"bad", text:"硬撐很傷"});
            pushLog("你選擇硬撐，狀態更差：體力與心情下降。");
          }
        }

        if(eventKey === "sickness"){
          const hasIns = !!state.inventory.health_insurance;
          if(choiceKey === "rest"){
            if(hasIns){
              changeState(s => ({...s, health: clamp(s.health + 8,0,100), mood: clamp(s.mood + 2,0,100), money: s.money - 200}), {kind:"ok", text:"健保護航"});
              pushLog("你就醫休息（健保協助）：金錢 -200，體力回升。");
              grantAchievement("照顧自己");
            }else{
              changeState(s => ({...s, health: clamp(s.health + 4,0,100), money: s.money - 800, mood: clamp(s.mood - 1,0,100)}), {kind:"warn", text:"就醫花費"});
              pushLog("你就醫休息：金錢 -800，體力小升。");
            }
          }else{
            changeState(s => ({...s, health: clamp(s.health - 10,0,100), mood: clamp(s.mood - 6,0,100)}), {kind:"bad", text:"硬撐更糟"});
            pushLog("你不處理，病情加重：體力下降、心情下降。");
          }
        }

        if(eventKey === "police"){
          // 依 age>=18、是否有 good_citizen_card 決定 ap/mood 變動（照原邏輯精神）
          const adult = state.age >= 18;
          const hasCard = !!state.inventory.good_citizen_card;
          if(choiceKey === "cooperate"){
            if(adult && hasCard){
              changeState(s => ({...s, ap: clamp(s.ap - 0,0,s.maxAp), mood: clamp(s.mood + 3,0,100)}), {kind:"ok", text:"心情 +3"});
              pushLog("你出示良民證並冷靜配合：心情提升。");
              grantAchievement("守法安心");
            }else if(adult && !hasCard){
              changeState(s => ({...s, ap: clamp(s.ap - 1,0,s.maxAp), mood: clamp(s.mood - 1,0,100)}), {kind:"warn", text:"AP -1"});
              pushLog("你冷靜配合但程序花時間：AP -1。");
            }else{
              // 未成年
              changeState(s => ({...s, ap: clamp(s.ap - 1,0,s.maxAp), mood: clamp(s.mood - 2,0,100)}), {kind:"warn", text:"AP -1"});
              pushLog("未成年臨檢較緊張：AP -1、心情小降。");
            }
          }else{
            if(adult){
              changeState(s => ({...s, ap: clamp(s.ap - 2,0,s.maxAp), mood: clamp(s.mood - 8,0,100), security: clamp(s.security - 4,0,100)}), {kind:"bad", text:"衝突成本"});
              pushLog("你拒絕配合造成衝突：AP -2、心情大降。");
            }else{
              changeState(s => ({...s, ap: clamp(s.ap - 2,0,s.maxAp), mood: clamp(s.mood - 10,0,100), security: clamp(s.security - 6,0,100)}), {kind:"bad", text:"更麻煩了"});
              pushLog("你情緒爆炸更麻煩：AP -2、心情下降。");
            }
          }
        }

        setModal(null);
      }

      /***********************
       * Week Advance
       ***********************/
      function advanceWeek(){
        // 週數達上限時不再前進，直接結算
        if(state.week > state.maxWeeks){
          setModal({ type:"ending" });
          return;
        }

        // 扣基本支出、房屋額外支出
        let next = {...state};

        // 每週扣款 bills：每週扣款，remainingWeeks 遞減，扣完移除
        const newBills = [];
        for(const b of next.bills){
          // 每週扣一次
          next.money -= b.amount;
          const remain = b.remainingWeeks - 1;
          if(remain > 0){
            newBills.push({ ...b, remainingWeeks: remain });
          }else{
            pushLog(`帳單已結清：${b.name}（本週扣 ${b.amount}）`);
          }
        }

        // living cost
        let lc = 1500;
        if(next.hasHouse && currentHouse && !currentHouse.isCCSA) lc += 500;
        next.money -= lc;
        next.bills = newBills;

        // week+1, ap reset, mood -5, security -2
        next.week = next.week + 1;
        next.ap = next.maxAp;
        next.mood = clamp(next.mood - 5, 0, 100);
        next.security = clamp(next.security - 2, 0, 100);

        pushLog(`週結算：基本支出 -${lc}；帳單扣款已處理。`);

        // 觸發驅逐：若扣完後 money <0 且租的是非 CCSA，自動 hasHouse=false...
        if(next.money < 0 && next.hasHouse && currentHouse && !currentHouse.isCCSA){
          next.hasHouse = false;
          next.houseId = "";
          next.houseName = "";
          next.mood = clamp(next.mood - 30, 0, 100);
          next.security = clamp(next.security - 10, 0, 100);
          pushLog("⚠ 你繳不出費用被迫退租（非 CCSA 住處）：失去住所、心情 -30、資安 -10。");
        }

        // 檢查任務（穩定租屋）
        if(next.hasHouse) grantMission("stableHousing");

        setState(next);
        maybeGlitch(next);

        // 到達第 9 週（超過 maxWeeks）=> 顯示結算
        if(next.week > next.maxWeeks){
          setTimeout(() => setModal({ type:"ending" }), 200);
          return;
        }

        // 結算後 1 秒觸發 triggerRandomEvent()
        setTimeout(() => triggerRandomEvent(), 1000);
      }

      /***********************
       * App: Job
       ***********************/
      function openJobQuiz(job){
        if(!spendAP(job.apCost || 1)){
          pushLog("AP 不足，無法應徵。");
          addFloat("bad","AP 不足");
          return;
        }

        // 年齡限制：不足但有 accompaniment_card 且非 strictAge 可應徵
        const ageOK = state.age >= job.minAge;
        const allowByAccompany = (!ageOK && state.inventory.accompaniment_card && !job.strictAge);
        if(!ageOK && !allowByAccompany){
          pushLog(`年齡不足，無法應徵：${job.title}（最低 ${job.minAge} 歲）。`);
          addFloat("bad","年齡不足");
          return;
        }

        // 題目池 = job.interviews + GENERIC_JOB_QUESTIONS，抽 3 題
        const pool = shuffleArray([...(job.interviews || []), ...GENERIC_JOB_QUESTIONS]);
        const picked = pool.slice(0,3);

        setModal({
          type:"quiz_job",
          job,
          questions:picked,
        });
      }

      function resolveJobQuiz(passed, job){
        setModal(null);
        if(passed){
          const income = job.wage * 8;
          const energyCost = job.energy;
          const moodDelta = job.mood;

          changeState(s => {
            const ns = {...s};
            ns.money += income;
            ns.health = clamp(ns.health - energyCost, 0, 100);
            ns.mood = clamp(ns.mood + moodDelta, 0, 100);
            ns.jobSuccessCount = (ns.jobSuccessCount || 0) + 1;
            return ns;
          }, {kind:"ok", text:`+${job.wage*8} 元`});

          pushLog(`應徵成功：${job.title}，本週收入 +${income}；體力 -${energyCost}；心情 ${moodDelta>=0?"+":""}${moodDelta}。`);

          // 任務：穩定工作（成功 1 次就算建立工作連結）
          grantMission("stableWork");
          grantAchievement("穩定打工人");
        }else{
          changeState(s => ({...s, mood: clamp(s.mood - 10, 0, 100)}), {kind:"bad", text:"心情 -10"});
          pushLog(`應徵失敗：${job.title}（面試未通過）。心情 -10。`);
        }
      }

      /***********************
       * App: Housing
       ***********************/
      function openHouseQuiz(house){
        if(state.hasHouse){
          pushLog(`你目前已入住：${state.houseName}。`);
          return;
        }

        if(!spendAP(1)){
          pushLog("AP 不足，無法預約看房。");
          addFloat("bad","AP 不足");
          return;
        }

        // 未滿 18 且無 accompaniment_card 時，除 ccsa 外不可簽約（提示）
        if(state.age < 18 && !state.inventory.accompaniment_card && !house.isCCSA){
          pushLog("未滿 18 歲且沒有社工陪同：無法簽一般租屋（可先申請陪同或選 CCSA 宿舍）。");
          addFloat("warn","需要陪同");
          return;
        }

        const quizKey = house.quizKey;
        const quiz = QUIZ_DB[quizKey];
        if(!quiz){
          pushLog("系統缺少看房測驗題庫（quizKey）。");
          addFloat("bad","題庫缺失");
          return;
        }

        setModal({
          type:"quiz_house",
          house,
          questions: quiz.questions,
          title: quiz.title,
        });
      }

      function resolveHouseQuiz(passed, house){
        setModal(null);
        if(!passed){
          pushLog(`看房/簽約未通過：${house.title}。`);
          changeState(s => ({...s, mood: clamp(s.mood - 6,0,100)}), {kind:"warn", text:"心情 -6"});
          return;
        }

        // 簽約成功：扣押金 deposit（rent=0 可免押金）
        const deposit = house.deposit || 0;

        changeState(s => {
          const ns = {...s};
          ns.money -= deposit;
          ns.security = clamp(ns.security + (house.security || 0), 0, 100);
          ns.hasHouse = true;
          ns.houseId = house.id;
          ns.houseName = house.title;
          return ns;
        }, deposit>0 ? {kind:"warn", text:`押金 -${deposit}`} : {kind:"ok", text:"入住成功"});

        pushLog(`簽約入住：${house.title}${deposit>0?`（押金 -${deposit}）`:"（免押金）"}；資安 ${house.security>=0?"+":""}${house.security}。`);
        grantMission("stableHousing");
        grantAchievement(house.isCCSA ? "住進支持系統" : "有殼蝸牛");
      }

      /***********************
       * App: Resource
       ***********************/
      function runResourceAction(actionKey){
        // Some actions consume AP, some not
        if(actionKey === "apply_accompany"){
          if(!spendAP(1)){
            pushLog("AP 不足，無法申請陪同。");
            addFloat("bad","AP 不足");
            return;
          }
          if(state.inventory.accompaniment_card){
            pushLog("你已經有「社工陪同卡」，不需重複申請。");
            addFloat("warn","已持有");
            return;
          }
          changeState(s => ({...s, inventory:{...s.inventory, accompaniment_card:true}}), {kind:"ok", text:"獲得陪同卡"});
          pushLog("你獲得：社工陪同卡（可協助未成年簽約/應徵限制）。");
          grantAchievement("懂得求助");
          grantMission("usedResources");
          return;
        }

        if(actionKey === "good_citizen"){
          if(state.age < 18){
            pushLog("未滿 18 歲需法定代理人/監護人協助辦理。");
            addFloat("warn","年齡限制");
            return;
          }
          if(state.inventory.good_citizen_card){
            pushLog("你已經有良民證，不需重複申請。");
            addFloat("warn","已持有");
            return;
          }
          changeState(s => ({...s, inventory:{...s.inventory, good_citizen_card:true}, mood: clamp(s.mood+2,0,100)}), {kind:"ok", text:"良民證"});
          pushLog("你取得良民證：未來臨檢事件更穩。");
          grantAchievement("守法安心");
          grantMission("usedResources");
          return;
        }

        // Actions with quiz
        const quiz = QUIZ_DB[actionKey];
        if(!quiz){
          pushLog("系統缺少資源題庫。");
          addFloat("bad","題庫缺失");
          return;
        }

        // finance_help: money<2000才可
        if(actionKey === "finance_help" && state.money >= 2000){
          pushLog("餘額未低於 2000，暫不符合急難財務補助條件。");
          addFloat("warn","不符合條件");
          return;
        }

        setModal({
          type:"quiz_resource",
          actionKey,
          title: quiz.title,
          questions: quiz.questions,
        });
      }

      function resolveResourceQuiz(passed, actionKey){
        setModal(null);
        if(!passed){
          changeState(s => ({...s, mood: clamp(s.mood-6,0,100)}), {kind:"warn", text:"心情 -6"});
          pushLog("資源申請未通過：請回想「必要支出、規劃、求助」。");
          return;
        }

        // apply effects
        if(actionKey === "job_test"){
          changeState(s => ({...s, money: s.money + 1000, mood: clamp(s.mood+2,0,100)}), {kind:"ok", text:"+1000 元"});
          pushLog("就業服務站測驗通過：補助 +1000。");
          grantAchievement("求職加速器");
          grantMission("usedResources");
        }
        if(actionKey === "welfare_help"){
          changeState(s => ({...s, health: clamp(s.health+20,0,100)}), {kind:"ok", text:"體力 +20"});
          pushLog("社會福利中心：生活支持成功，體力 +20。");
          grantAchievement("善用資源");
          grantMission("usedResources");
        }
        if(actionKey === "finance_help"){
          changeState(s => ({...s, money: s.money + 5000}), {kind:"ok", text:"+5000 元"});
          pushLog("社會福利中心：急難補助成功，金錢 +5000。");
          grantAchievement("度過難關");
          grantMission("usedResources");
        }
        if(actionKey === "ccsa_aid"){
          changeState(s => ({...s, money: s.money + 3000, mood: clamp(s.mood+2,0,100)}), {kind:"ok", text:"+3000 元"});
          pushLog("CCSA 經濟支持通過：金錢 +3000。");
          grantAchievement("得到幫助");
          grantMission("usedResources");
        }
        if(actionKey === "ccsa_counseling"){
          changeState(s => ({...s, mood: clamp(s.mood+30,0,100), health: clamp(s.health+10,0,100)}), {kind:"ok", text:"心情 +30"});
          pushLog("CCSA 諮商支持：心情 +30、體力 +10。");
          grantAchievement("情緒照顧");
          grantMission("usedResources");
        }
        if(actionKey === "ccsa_training"){
          changeState(s => ({...s, maxAp: clamp(s.maxAp+1,1,9), ap: clamp(s.ap+1,0, clamp(s.maxAp+1,1,9)), mood: clamp(s.mood+10,0,100)}), {kind:"ok", text:"AP 上限 +1"});
          pushLog("CCSA 自立培訓完成：AP 上限 +1、心情 +10。");
          grantAchievement("提升行動力");
          grantMission("usedResources");
        }
      }

      /***********************
       * Finance & Shop
       ***********************/
      function addBill(name, amount, remainingWeeks){
        setState(s => ({
          ...s,
          bills: [...s.bills, { id: uid("bill"), name, amount, remainingWeeks }]
        }));
      }

      function openShop(){
        setModal({ type:"shop" });
      }

      function purchase(item, method){
        // method: cash | credit | bnpl
        if(item.special === "creditCard"){
          if(state.age < 18){
            pushLog("信用卡：需年滿 18 歲才可申請。");
            addFloat("warn","18+ 才可");
            return;
          }
          if(state.inventory.credit_card){
            pushLog("你已經有信用卡，不需重複申請。");
            addFloat("warn","已持有");
            return;
          }
          changeState(s => ({...s, inventory:{...s.inventory, credit_card:true}, security: clamp(s.security+2,0,100)}), {kind:"ok", text:"信用卡"});
          pushLog("你申請了信用卡（工具）。提醒：信用支付要更慎重。");
          grantAchievement("信用啟動");
          setModal(null);
          return;
        }

        if(state.age < (item.ageMin || 15)){
          pushLog(`年齡不足，無法購買：${item.name}。`);
          addFloat("warn","年齡限制");
          return;
        }

        // scam item
        if(item.scam){
          // 立即扣款（不給道具）
          changeState(s => ({...s, money: s.money - item.price, mood: clamp(s.mood - 25,0,100), security: clamp(s.security - 8,0,100)}), {kind:"bad", text:`-${item.price} 元`});
          pushLog(`你購買了「${item.name}」結果是投資詐騙：金錢 -${item.price}、心情大降。`);
          grantAchievement("被騙一次就夠");
          setModal(null);
          return;
        }

        // Payment
        if(method === "cash"){
          changeState(s => ({...s, money: s.money - item.price}), {kind:"warn", text:`-${item.price} 元`});
          pushLog(`你用現金購買：${item.name}（-${item.price}）。`);
        }
        if(method === "credit"){
          if(!state.inventory.credit_card){
            pushLog("你尚未有信用卡，無法使用信用支付。");
            addFloat("warn","需要信用卡");
            return;
          }
          addBill(`信用卡：${item.name}`, item.price, 1);
          pushLog(`你用信用支付：${item.name}（下週扣 ${item.price}）。`);
          grantAchievement("學會分期但要節制");
        }
        if(method === "bnpl"){
          const total = Math.ceil(item.price * 1.2);
          const weekly = Math.ceil(total / 4);
          addBill(`BNPL：${item.name}`, weekly, 4);
          pushLog(`你用 BNPL：${item.name}（總價+20%=${total}，每週扣 ${weekly}，共 4 週）。`);
          grantAchievement("分期族");
        }

        // grant item/effects
        if(item.itemGrant){
          changeState(s => ({...s, inventory:{...s.inventory, [item.itemGrant]: true}}), {kind:"ok", text:"獲得道具"});
          pushLog(`你獲得道具：${item.name}。`);
          if(item.itemGrant === "health_insurance") grantAchievement("有健保心不慌");
          if(item.itemGrant === "accident_insurance") grantAchievement("有意外險更穩");
        }
        if(item.effect){
          changeState(s => applyDelta(s, item.effect), {kind:"ok", text:"狀態變動"});
          const parts = [];
          if(item.effect.health) parts.push(`體力 ${item.effect.health>=0?"+":""}${item.effect.health}`);
          if(item.effect.mood) parts.push(`心情 ${item.effect.mood>=0?"+":""}${item.effect.mood}`);
          if(item.effect.security) parts.push(`資安 ${item.effect.security>=0?"+":""}${item.effect.security}`);
          if(item.effect.money) parts.push(`金錢 ${item.effect.money>=0?"+":""}${item.effect.money}`);
          pushLog(`購買效果：${parts.join("、")}。`);
        }

        setModal(null);
      }

      function addLedgerEntry(name, amount){
        // amount positive => income, negative => expense
        if(!name || !String(name).trim()) return;
        const n = Number(amount);
        if(!Number.isFinite(n) || n === 0) return;

        changeState(s => {
          const ns = {...s};
          ns.money += n;
          ns.ledger = [{ id: uid("led"), name: String(name).trim(), amount: n, week: ns.week }, ...(ns.ledger||[])].slice(0, 50);
          return ns;
        }, {kind: n>0 ? "ok" : "warn", text: (n>0?"+":"") + n + " 元"});

        pushLog(`記帳：${name}（${n>0?"+":""}${n}）。`);
        if(n > 0) grantAchievement("懂得增加收入");
        if(n < 0) grantAchievement("記帳習慣");
      }

      /***********************
       * Ending Summary
       ***********************/
      function calcEnding(){
        const moneyOk = state.money > 0;
        const taskCount = Object.values(state.missions).filter(Boolean).length;
        const pass = (state.week > state.maxWeeks) && moneyOk && taskCount >= 2;

        // 稱號（依存款 + 是否有租屋）
        let title = "努力生存的新人";
        if(state.money < 0){
          title = "負債累累的倖存者";
        }else if(state.money >= 0 && state.money < 2000){
          title = state.hasHouse ? "撐住基本盤的蝸牛" : "邊走邊找的生存者";
        }else if(state.money >= 2000 && state.money < 8000){
          title = state.hasHouse ? "穩定前進的自立青年" : "存到錢但仍漂泊的旅人";
        }else{
          title = state.hasHouse ? "自立自強的模範生" : "有錢但缺少依靠的孤勇者";
        }

        // 成就標籤
        const tags = Object.keys(state.achievements).filter(k => state.achievements[k]);
        const prettyTagsMap = {
          "有殼蝸牛":"有殼蝸牛",
          "穩定打工人":"穩定打工人",
          "善用資源":"善用資源",
          "得到幫助":"得到幫助",
          "提升行動力":"提升行動力",
          "防詐雷達":"防詐雷達",
          "資安守門員":"資安守門員",
          "拒絕高手":"拒絕高手",
          "懂得求助":"懂得求助",
          "守法安心":"守法安心",
          "度過難關":"度過難關",
          "有保險更穩":"有保險更穩",
          "有健保心不慌":"有健保心不慌",
          "分期族":"分期族",
          "記帳習慣":"記帳習慣",
          "情緒照顧":"情緒照顧",
          "住進支持系統":"住進支持系統",
          "求職加速器":"求職加速器",
          "信用啟動":"信用啟動",
          "學會分期但要節制":"學會分期但要節制",
          "照顧自己":"照顧自己",
          "被騙一次就夠":"被騙一次就夠",
          "懂得增加收入":"懂得增加收入",
          "善用界線":"善用界線",
        };

        const tagChips = tags.map(t => prettyTagsMap[t] || t);

        // 溫暖評語 + 資源指引
        let comment = "";
        if(pass){
          comment =
            "你不只撐過 8 週，還做到至少兩個「穩定支點」（收入/住所/資源連結）。\n" +
            "這代表你開始建立支持系統，而不是只靠硬撐。\n" +
            "下一步建議：繼續記帳、把緊急預備金存到 1～2 個月生活費，遇到壓力時更敢求助。";
        }else{
          if(state.money < 0){
            comment =
              "你遇到「赤字/負債」的壓力，這在現實中很常見：意外、詐騙、衝動消費都可能造成崩盤。\n" +
              "鼓勵你：先把必要支出（房租/吃飯/交通）排第一，暫停非必要消費。\n" +
              "資源指引：社福中心的急難/租屋協助、就服站求職支持、CCSA 社工陪同與諮商，都能讓你少走弯路。";
          }else{
            comment =
              "你存款還可以，但「穩定支點」不足（住所/工作/資源連結太少），生活仍容易漂泊。\n" +
              "鼓勵你：把「穩定住處」與「固定收入」當成優先目標；同時主動連結社福/就服/社工資源。\n" +
              "當你願意求助，風險就會下降，路也會更清楚。";
          }
        }

        return { pass, taskCount, title, tagChips, comment };
      }

      /***********************
       * Renders
       ***********************/
      function renderStart(){
        const origin = state.origin;
        return (
          <div className="p-4">
            <div className="neo-card p-4">
              <div className="font-pixel text-[38px] leading-none break-words">自立大冒險</div>
              <div className="text-sm text-slate-700 mt-2 break-words">
                你將用 8 週時間練習：收入、住處、資源連結、以及風險（詐騙/意外）管理。
              </div>

              <div className="mt-4 flex flex-col items-center">
                <div className="wheel-pointer"></div>
                <div className="wheel-wrap" style={{ transform: `rotate(${wheelDeg}deg)`, transition: spinning ? "transform 2s cubic-bezier(.2,.9,.2,1)" : "none" }}>
                  <div className="wheel-center">
                    <div className="wheel-dot">{spinning ? "轉…" : "命運"}</div>
                  </div>
                </div>

                <button
                  className={"neo-btn mt-4 px-5 py-3 font-pixel text-[34px] flex items-center gap-2 " + (spinning ? "bg-slate-200" : "bg-amber-200")}
                  onClick={spinWheel}
                  disabled={spinning}
                >
                  <IconSpinner />
                  <span>{spinning ? "轉動中…" : "啟動命運轉盤"}</span>
                </button>

                {origin ? (
                  <div className="mt-4 neo-soft p-3 bg-slate-50 w-full">
                    <div className="font-pixel text-[28px] leading-tight break-words">你目前抽到：{origin.label}</div>
                    <div className="text-sm text-slate-700 mt-1 break-words">{origin.desc}</div>
                  </div>
                ) : null}
              </div>
            </div>

            <div className="mt-4 neo-soft p-4 bg-white">
              <div className="font-pixel text-[30px] leading-none">遊戲小提示</div>
              <ul className="mt-2 text-sm text-slate-700 list-disc pl-5 space-y-1">
                <li>AP 是你本週可用的行動點數：應徵、看房、申請陪同會消耗。</li>
                <li>心情/體力太低會影響決策，必要時去資源地圖找支持。</li>
                <li>資安低時更容易被詐騙事件打擊。</li>
              </ul>
            </div>
          </div>
        );
      }

      function renderHome(){
        return (
          <div className="p-4">
            <div className="neo-card p-4">
              <div className="flex items-start justify-between gap-3">
                <div className="min-w-0">
                  <div className="font-pixel text-[34px] leading-none break-words">主畫面</div>
                  <div className="text-sm text-slate-700 mt-1 break-words">
                    年齡：<b>{state.age}</b>｜餘額：<b>{state.money}</b> 元
                  </div>
                </div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-[26px] shrink-0" onClick={()=>setRoute("start")}>
                  重新開始
                </button>
              </div>

              {state.bills.length > 0 ? (
                <div className="mt-3 neo-soft p-3 bg-amber-50">
                  <div className="font-pixel text-[26px] leading-tight">⚠ 未繳帳單提醒</div>
                  <div className="text-sm text-slate-700 mt-1 break-words">
                    你目前有 <b>{state.bills.length}</b> 筆帳單會在週結算扣款。
                  </div>
                </div>
              ) : null}

              {state.mood < 30 ? (
                <div className="mt-3 neo-soft p-3 bg-rose-50">
                  <div className="font-pixel text-[26px] leading-tight">⚠ 心情偏低</div>
                  <div className="text-sm text-slate-700 mt-1 break-words">
                    建議：去「資源地圖」找諮商或支持，避免做出衝動決策。
                  </div>
                </div>
              ) : null}
            </div>

            <div className="mt-4 grid grid-cols-1 gap-3">
              <AppIcon label="租屋中心" color="bg-emerald-200" Icon={IconHouse} onClick={()=>setRoute("app_house")} />
              <AppIcon label="人力銀行" color="bg-sky-200" Icon={IconBriefcase} onClick={()=>setRoute("app_job")} />
              <AppIcon label="資源地圖" color="bg-violet-200" Icon={IconMap} onClick={()=>setRoute("app_resource")} />
              <AppIcon label="財務管家" color="bg-amber-200" Icon={IconWallet} onClick={()=>setRoute("app_finance")} />
            </div>

            <div className="mt-4 grid grid-cols-2 gap-3">
              <button className="neo-btn bg-emerald-200 px-4 py-4 font-pixel text-[30px] leading-none break-words" onClick={advanceWeek}>
                結束本週
                <div className="text-xs font-sans text-slate-700 mt-1">進入下一週</div>
              </button>
              <button className="neo-btn bg-white px-4 py-4 font-pixel text-[30px] leading-none break-words" onClick={advanceWeek}>
                休息
                <div className="text-xs font-sans text-slate-700 mt-1">也會進下一週</div>
              </button>
            </div>

            <div className="mt-4 terminal p-4">
              <div className="flex items-center justify-between gap-2">
                <div className="font-pixel text-[28px] text-emerald-200">系統紀錄</div>
                <div className="text-xs text-emerald-200/80">最近 5 筆</div>
              </div>
              <div className="mt-2 text-xs leading-relaxed">
                {(state.logs.slice(0,5).length ? state.logs.slice(0,5) : [{id:"none", text:"尚無紀錄。先轉動命運轉盤開始！"}]).map(l => (
                  <div key={l.id} className="break-words">• {l.text}</div>
                ))}
              </div>
            </div>

            <div className="h-4"></div>
          </div>
        );
      }

      function renderJobApp(){
        return (
          <div className="p-4">
            <div className="neo-card p-4">
              <div className="flex items-center justify-between gap-2">
                <div className="font-pixel text-[34px] leading-none break-words">人力銀行</div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-[26px] flex items-center gap-2" onClick={()=>setRoute("home")}>
                  <IconHome />
                  回主畫面
                </button>
              </div>
              <div className="text-sm text-slate-700 mt-2 break-words">
                應徵會消耗 1 AP，並進行 3 題面試測驗（全對才通過）。
              </div>
            </div>

            <div className="mt-4 grid grid-cols-1 gap-3">
              {JOBS.map(job => {
                const ageOK = state.age >= job.minAge;
                const allowByAccompany = (!ageOK && state.inventory.accompaniment_card && !job.strictAge);
                return (
                  <div key={job.id} className="neo-card p-4">
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0">
                        <div className="font-pixel text-[34px] leading-none break-words">{job.title}</div>
                        <div className="text-xs text-slate-700 mt-2 break-words">{job.desc}</div>
                      </div>
                      <div className="flex flex-col items-end gap-2 shrink-0">
                        <span className={"neo-soft px-2 py-1 text-xs " + (ageOK || allowByAccompany ? "bg-emerald-100" : "bg-rose-100")}>
                          {ageOK ? "年齡OK" : allowByAccompany ? "陪同可" : `需 ${job.minAge}+`}
                        </span>
                        <span className={"neo-soft px-2 py-1 text-xs " + (job.strictAge ? "bg-amber-100" : "bg-slate-100")}>
                          {job.strictAge ? "嚴格年齡" : "一般"}
                        </span>
                      </div>
                    </div>

                    <div className="mt-3 grid grid-cols-4 gap-2">
                      <div className="neo-soft p-2 text-center bg-white">
                        <div className="text-xs text-slate-600">時薪</div>
                        <div className="font-pixel text-[28px]">{job.wage}</div>
                      </div>
                      <div className="neo-soft p-2 text-center bg-white">
                        <div className="text-xs text-slate-600">體力</div>
                        <div className="font-pixel text-[28px]">-{job.energy}</div>
                      </div>
                      <div className="neo-soft p-2 text-center bg-white">
                        <div className="text-xs text-slate-600">心情</div>
                        <div className="font-pixel text-[28px]">{job.mood>=0?"+":""}{job.mood}</div>
                      </div>
                      <div className="neo-soft p-2 text-center bg-white">
                        <div className="text-xs text-slate-600">AP</div>
                        <div className="font-pixel text-[28px]">-{job.apCost}</div>
                      </div>
                    </div>

                    <button className="neo-btn mt-3 w-full bg-emerald-200 px-4 py-3 font-pixel text-[30px]" onClick={()=>openJobQuiz(job)}>
                      應徵（測驗）
                    </button>
                  </div>
                );
              })}
            </div>

            <div className="h-6"></div>
          </div>
        );
      }

      function renderHouseApp(){
        return (
          <div className="p-4">
            <div className="neo-card p-4">
              <div className="flex items-center justify-between gap-2">
                <div className="font-pixel text-[34px] leading-none break-words">租屋中心</div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-[26px] flex items-center gap-2" onClick={()=>setRoute("home")}>
                  <IconHome />
                  回主畫面
                </button>
              </div>
              <div className="text-sm text-slate-700 mt-2 break-words">
                預約看房消耗 1 AP，需通過對應測驗才可簽約入住。
              </div>

              {state.hasHouse ? (
                <div className="mt-3 neo-soft p-3 bg-emerald-50">
                  <div className="font-pixel text-[28px] break-words">已入住：{state.houseName}</div>
                  <div className="text-sm text-slate-700 mt-1 break-words">
                    建議：保持收支平衡，避免被迫退租。
                  </div>
                </div>
              ) : null}

              {(state.age < 18 && !state.inventory.accompaniment_card) ? (
                <div className="mt-3 neo-soft p-3 bg-amber-50">
                  <div className="font-pixel text-[26px] break-words">提示：未滿 18 且無陪同</div>
                  <div className="text-sm text-slate-700 mt-1 break-words">
                    除了 CCSA 宿舍以外，一般租屋需要先申請「社工陪同卡」。
                  </div>
                </div>
              ) : null}
            </div>

            <div className="mt-4 grid grid-cols-1 gap-3">
              {HOUSING.map(h => (
                <div key={h.id} className="neo-card p-4">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="font-pixel text-[34px] leading-none break-words">{h.title}</div>
                      <div className="text-xs text-slate-700 mt-2 break-words">{h.desc}</div>
                    </div>
                    <div className={"neo-soft px-2 py-1 text-xs shrink-0 " + (h.isCCSA ? "bg-emerald-100" : "bg-slate-100")}>
                      {h.isCCSA ? "支持系統" : "一般租屋"}
                    </div>
                  </div>

                  <div className="mt-3 grid grid-cols-3 gap-2">
                    <div className="neo-soft p-2 text-center bg-white">
                      <div className="text-xs text-slate-600">租金</div>
                      <div className="font-pixel text-[28px]">{h.rent}</div>
                    </div>
                    <div className="neo-soft p-2 text-center bg-white">
                      <div className="text-xs text-slate-600">押金</div>
                      <div className="font-pixel text-[28px]">{h.deposit}</div>
                    </div>
                    <div className="neo-soft p-2 text-center bg-white">
                      <div className="text-xs text-slate-600">資安</div>
                      <div className="font-pixel text-[28px]">{h.security>=0?"+":""}{h.security}</div>
                    </div>
                  </div>

                  <button
                    className={"neo-btn mt-3 w-full px-4 py-3 font-pixel text-[30px] " + (state.hasHouse ? "bg-slate-200" : "bg-emerald-200")}
                    onClick={()=>openHouseQuiz(h)}
                    disabled={state.hasHouse}
                  >
                    {state.hasHouse ? "已入住（不可再租）" : "預約看房（測驗）"}
                  </button>
                </div>
              ))}
            </div>

            <div className="h-6"></div>
          </div>
        );
      }

      function renderResourceApp(){
        return (
          <div className="p-4">
            <div className="neo-card p-4">
              <div className="flex items-center justify-between gap-2">
                <div className="font-pixel text-[34px] leading-none break-words">資源地圖</div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-[26px] flex items-center gap-2" onClick={()=>setRoute("home")}>
                  <IconHome />
                  回主畫面
                </button>
              </div>
              <div className="text-sm text-slate-700 mt-2 break-words">
                自立不只是賺錢：善用資源、建立支持系統，才走得久。
              </div>
            </div>

            <div className="mt-4 grid grid-cols-1 gap-3">
              <div className="neo-card p-4">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-[32px] break-words">就業服務站</div>
                  <span className="neo-soft px-2 py-1 text-xs bg-sky-100">測驗</span>
                </div>
                <div className="text-xs text-slate-700 mt-2 break-words">通過職場測驗可獎勵金錢 +1000。</div>
                <button className="neo-btn mt-3 w-full bg-sky-200 px-4 py-3 font-pixel text-[30px]" onClick={()=>runResourceAction("job_test")}>
                  進行職場測驗
                </button>
              </div>

              <div className="neo-card p-4">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-[32px] break-words">社會福利中心</div>
                  <span className="neo-soft px-2 py-1 text-xs bg-amber-100">協助</span>
                </div>
                <div className="text-xs text-slate-700 mt-2 break-words">
                  生活支持：體力 +20。<br/>
                  急難補助：餘額 &lt; 2000 才可申請，通過金錢 +5000。
                </div>
                <div className="mt-3 grid grid-cols-2 gap-2">
                  <button className="neo-btn bg-amber-200 px-3 py-3 font-pixel text-[28px]" onClick={()=>runResourceAction("welfare_help")}>
                    生活支持
                  </button>
                  <button className="neo-btn bg-indigo-200 px-3 py-3 font-pixel text-[28px]" onClick={()=>runResourceAction("finance_help")}>
                    急難補助
                  </button>
                </div>
              </div>

              <div className="neo-card p-4">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-[32px] break-words">CCSA 自立服務</div>
                  <span className="neo-soft px-2 py-1 text-xs bg-emerald-100">支持</span>
                </div>
                <div className="text-xs text-slate-700 mt-2 break-words">
                  經濟支持、陪同、諮商與培訓（提升 maxAP）。
                </div>

                <div className="mt-3 grid grid-cols-2 gap-2">
                  <button className="neo-btn bg-emerald-200 px-3 py-3 font-pixel text-[28px]" onClick={()=>runResourceAction("ccsa_aid")}>
                    經濟支持
                  </button>
                  <button className={"neo-btn px-3 py-3 font-pixel text-[28px] " + (state.inventory.accompaniment_card ? "bg-slate-200" : "bg-white")} onClick={()=>runResourceAction("apply_accompany")}>
                    {state.inventory.accompaniment_card ? "已領陪同卡" : "申請陪同"}
                  </button>
                  <button className="neo-btn bg-amber-200 px-3 py-3 font-pixel text-[28px]" onClick={()=>runResourceAction("ccsa_counseling")}>
                    諮商
                  </button>
                  <button className="neo-btn bg-violet-200 px-3 py-3 font-pixel text-[28px]" onClick={()=>runResourceAction("ccsa_training")}>
                    培訓
                  </button>
                </div>
              </div>

              <div className="neo-card p-4">
                <div className="flex items-center justify-between gap-2">
                  <div className="font-pixel text-[32px] break-words">警察局</div>
                  <span className="neo-soft px-2 py-1 text-xs bg-slate-100">證明</span>
                </div>
                <div className="text-xs text-slate-700 mt-2 break-words">
                  年滿 18 歲可申請良民證（臨檢更穩）。未滿 18 需監護人協助。
                </div>
                <button className={"neo-btn mt-3 w-full px-4 py-3 font-pixel text-[30px] " + (state.inventory.good_citizen_card ? "bg-slate-200" : "bg-white")} onClick={()=>runResourceAction("good_citizen")}>
                  {state.inventory.good_citizen_card ? "已取得良民證" : "申請良民證"}
                </button>
              </div>

            </div>

            <div className="h-6"></div>
          </div>
        );
      }

      function renderFinanceApp(){
        const [name, setName] = useState("");
        const [amount, setAmount] = useState("");

        const bills = state.bills || [];
        const lastLedgers = (state.ledger || []).slice(0,6);

        return (
          <div className="p-4">
            <div className="neo-card p-4">
              <div className="flex items-center justify-between gap-2">
                <div className="font-pixel text-[34px] leading-none break-words">財務管家</div>
                <button className="neo-btn px-3 py-2 bg-white font-pixel text-[26px] flex items-center gap-2" onClick={()=>setRoute("home")}>
                  <IconHome />
                  回主畫面
                </button>
              </div>

              <div className="mt-3 grid grid-cols-2 gap-2">
                <div className="neo-soft p-3 bg-amber-50">
                  <div className="text-xs text-slate-600">現金餘額</div>
                  <div className="font-pixel text-[34px] break-words">{state.money} 元</div>
                </div>
                <div className="neo-soft p-3 bg-slate-50">
                  <div className="text-xs text-slate-600">本週固定支出</div>
                  <div className="font-pixel text-[34px] break-words">{livingCost} 元</div>
                </div>
              </div>

              <div className="mt-3 flex flex-wrap gap-2">
                <span className={"neo-soft px-3 py-2 text-xs " + (state.inventory.credit_card ? "bg-emerald-50" : "bg-slate-50")}>
                  信用卡：{state.inventory.credit_card ? "已開通" : "未開通（商店可申請，18+）"}
                </span>
                <span className={"neo-soft px-3 py-2 text-xs " + (state.inventory.health_insurance ? "bg-emerald-50" : "bg-slate-50")}>
                  健保：{state.inventory.health_insurance ? "已持有" : "未持有"}
                </span>
                <span className={"neo-soft px-3 py-2 text-xs " + (state.inventory.accident_insurance ? "bg-emerald-50" : "bg-slate-50")}>
                  意外險：{state.inventory.accident_insurance ? "已持有" : "未持有"}
                </span>
              </div>
            </div>

            <div className="mt-4 neo-card p-4">
              <div className="flex items-center justify-between gap-2">
                <div className="font-pixel text-[32px] break-words">未繳帳單</div>
                <button className="neo-btn px-3 py-2 bg-amber-200 font-pixel text-[26px]" onClick={openShop}>
                  打開商店
                </button>
              </div>

              {bills.length ? (
                <div className="mt-3 grid grid-cols-1 gap-2">
                  {bills.map(b => (
                    <div key={b.id} className="neo-soft p-3 bg-white">
                      <div className="flex items-start justify-between gap-2">
                        <div className="min-w-0">
                          <div className="font-pixel text-[26px] leading-tight break-words">{b.name}</div>
                          <div className="text-xs text-slate-600 mt-1 break-words">每週扣款：{b.amount}｜剩餘 {b.remainingWeeks} 週</div>
                        </div>
                        <div className="neo-soft px-2 py-1 text-xs bg-rose-50 shrink-0">扣款中</div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="mt-3 neo-soft p-3 bg-emerald-50">
                  <div className="text-sm text-slate-700 break-words">目前沒有帳單，做得好！</div>
                </div>
              )}
            </div>

            <div className="mt-4 neo-card p-4">
              <div className="font-pixel text-[32px] break-words">記帳小工具</div>
              <div className="text-xs text-slate-600 mt-1 break-words">輸入名稱與金額：收入用正數，支出用負數。</div>

              <div className="mt-3 grid grid-cols-1 gap-2">
                <input className="neo-soft px-3 py-3 w-full outline-none" value={name} onChange={e=>setName(e.target.value)} placeholder="例如：打工收入 / 房租 / 餐費" />
                <input className="neo-soft px-3 py-3 w-full outline-none" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="例如：+1500 或 -300" inputMode="numeric" />
                <button
                  className="neo-btn bg-emerald-200 px-4 py-3 font-pixel text-[30px]"
                  onClick={() => {
                    addLedgerEntry(name, amount);
                    setName("");
                    setAmount("");
                  }}
                >
                  新增記帳
                </button>
              </div>

              <div className="mt-4">
                <div className="text-xs text-slate-600">最近記帳（最多 6 筆）</div>
                <div className="mt-2 grid grid-cols-1 gap-2">
                  {lastLedgers.length ? lastLedgers.map(l => (
                    <div key={l.id} className="neo-soft p-3 bg-white">
                      <div className="flex items-start justify-between gap-2">
                        <div className="min-w-0">
                          <div className="font-pixel text-[24px] break-words">{l.name}</div>
                          <div className="text-xs text-slate-600">第 {l.week} 週</div>
                        </div>
                        <div className={"font-pixel text-[26px] shrink-0 " + (l.amount>=0 ? "text-emerald-700" : "text-rose-700")}>
                          {l.amount>=0?"+":""}{l.amount}
                        </div>
                      </div>
                    </div>
                  )) : (
                    <div className="neo-soft p-3 bg-slate-50 text-sm text-slate-700 break-words">還沒有記帳紀錄。</div>
                  )}
                </div>
              </div>
            </div>

            <div className="h-6"></div>
          </div>
        );
      }

      /***********************
       * Main screen frame
       ***********************/
      const glitchClass = (state.mood < 30 || state.security < 30) ? ("glitch-effect glitch_" + glitchTick) : "";

      let main = null;
      if(route === "start") main = renderStart();
      if(route === "home") main = renderHome();
      if(route === "app_job") main = renderJobApp();
      if(route === "app_house") main = renderHouseApp();
      if(route === "app_resource") main = renderResourceApp();
      if(route === "app_finance") main = renderFinanceApp();

      /***********************
       * Modals
       ***********************/
      const modalNode = (() => {
        if(!modal) return null;

        if(modal.type === "identity"){
          const origin = modal.origin;
          return (
            <ModalWrapper
              title="身分確認卡"
              onClose={() => setModal(null)}
              footer={(
                <div className="flex gap-2">
                  <button className="neo-btn flex-1 px-4 py-3 bg-white font-pixel text-[28px]" onClick={()=>choosePassword("weak")}>
                    123456（快）
                  </button>
                  <button className="neo-btn flex-1 px-4 py-3 bg-emerald-200 font-pixel text-[28px]" onClick={()=>choosePassword("2fa")}>
                    開啟 2FA（穩）
                  </button>
                </div>
              )}
            >
              <div className="neo-soft p-3 bg-slate-50">
                <div className="font-pixel text-[30px] break-words">起始條件</div>
                <div className="text-sm text-slate-700 mt-1 break-words">
                  等級：<b>{origin.key}</b>（{origin.label}）<br/>
                  初始金額：<b>{origin.money}</b> 元<br/>
                  年齡：<b>{modal.age}</b>
                </div>
              </div>
              <div className="mt-3 neo-soft p-3 bg-amber-50">
                <div className="font-pixel text-[28px] break-words">第一關：手機密碼</div>
                <div className="text-sm text-slate-700 mt-1 break-words">
                  你要用「方便」還是「安全」？不同選擇會影響你的資安值。
                </div>
              </div>
            </ModalWrapper>
          );
        }

        if(modal.type === "quiz_job"){
          const job = modal.job;
          return (
            <QuizModal
              quizTitle={`面試測驗：${job.title}`}
              questions={modal.questions}
              onClose={() => setModal(null)}
              onSubmit={(passed) => resolveJobQuiz(passed, job)}
            />
          );
        }

        if(modal.type === "quiz_house"){
          const house = modal.house;
          return (
            <QuizModal
              quizTitle={modal.title || `看房測驗：${house.title}`}
              questions={modal.questions}
              onClose={() => setModal(null)}
              onSubmit={(passed) => resolveHouseQuiz(passed, house)}
            />
          );
        }

        if(modal.type === "quiz_resource"){
          return (
            <QuizModal
              quizTitle={modal.title}
              questions={modal.questions}
              onClose={() => setModal(null)}
              onSubmit={(passed) => resolveResourceQuiz(passed, modal.actionKey)}
            />
          );
        }

        if(modal.type === "event"){
          const ev = SCENARIOS[modal.eventKey];
          if(!ev) return null;
          return (
            <ModalWrapper
              title={ev.title}
              onClose={() => setModal(null)}
              footer={(
                <div className="flex flex-col gap-2">
                  {ev.options.map((op, idx) => (
                    <button
                      key={idx}
                      className={"neo-btn px-4 py-3 font-pixel text-[28px] " + (idx===0 ? "bg-emerald-200" : idx===1 ? "bg-amber-200" : "bg-white")}
                      onClick={() => resolveEvent(modal.eventKey, op.key)}
                    >
                      {op.label}
                    </button>
                  ))}
                </div>
              )}
            >
              <div className="text-sm text-slate-700 break-words">{ev.body}</div>
              <div className="mt-3 neo-soft p-3 bg-slate-50 text-xs text-slate-700 break-words">
                小提醒：資安越高，越能躲過詐騙；保險道具可降低意外/生病衝擊。
              </div>
            </ModalWrapper>
          );
        }

        if(modal.type === "shop"){
          return (
            <ModalWrapper
              title="商店"
              onClose={() => setModal(null)}
              footer={(
                <div className="text-xs text-slate-600 break-words">
                  付款方式：現金（立即扣款）／信用（下週扣，需信用卡）／BNPL（總價+20% 分 4 週扣）。
                </div>
              )}
            >
              <div className="neo-soft p-3 bg-slate-50">
                <div className="font-pixel text-[28px] break-words">你的餘額：{state.money} 元</div>
                <div className="text-xs text-slate-700 mt-1 break-words">
                  信用卡：{state.inventory.credit_card ? "已開通" : "未開通（18+ 可申請）"}
                </div>
              </div>

              <div className="mt-3 grid grid-cols-1 gap-3">
                {SHOP_ITEMS.map(item => (
                  <div key={item.id} className={"neo-soft p-3 " + (item.scam ? "bg-rose-50" : "bg-white")}>
                    <div className="flex items-start justify-between gap-2">
                      <div className="min-w-0">
                        <div className="font-pixel text-[28px] break-words">{item.name}</div>
                        <div className="text-xs text-slate-700 mt-1 break-words">{item.desc}</div>
                        {item.ageMin ? (
                          <div className="text-[11px] text-slate-600 mt-1">年齡限制：{item.ageMin}+</div>
                        ) : null}
                      </div>
                      <div className={"neo-soft px-2 py-1 text-xs shrink-0 " + (item.scam ? "bg-rose-100" : "bg-amber-50")}>
                        {item.price ? `${item.price} 元` : "—"}
                      </div>
                    </div>

                    <div className="mt-3 grid grid-cols-3 gap-2">
                      <button className="neo-btn bg-white px-2 py-3 font-pixel text-[26px]" onClick={()=>purchase(item,"cash")}>
                        現金
                      </button>
                      <button className="neo-btn bg-indigo-200 px-2 py-3 font-pixel text-[26px]" onClick={()=>purchase(item,"credit")}>
                        信用
                      </button>
                      <button className="neo-btn bg-amber-200 px-2 py-3 font-pixel text-[26px]" onClick={()=>purchase(item,"bnpl")}>
                        BNPL
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </ModalWrapper>
          );
        }

        if(modal.type === "ending"){
          const end = calcEnding();
          const missionCount = end.taskCount;

          const missionBadges = [
            { key:"stableHousing", label:"穩定租屋" },
            { key:"stableWork", label:"穩定工作" },
            { key:"usedResources", label:"成功連結資源" },
          ];

          return (
            <ModalWrapper
              title={`第 8 週結算：你的結局`}
              onClose={() => setModal(null)}
              footer={(
                <div className="flex gap-2">
                  <button className="neo-btn flex-1 px-4 py-3 bg-amber-200 font-pixel text-[30px]" onClick={resetGame}>
                    再玩一次
                  </button>
                  <button className="neo-btn flex-1 px-4 py-3 bg-white font-pixel text-[30px]" onClick={() => setModal(null)}>
                    關閉
                  </button>
                </div>
              )}
            >
              <div className={"neo-soft p-3 " + (end.pass ? "bg-emerald-50" : "bg-rose-50")}>
                <div className="font-pixel text-[34px] break-words">
                  {end.pass ? "🎉 通關（Happy Ending）" : "⚠ 未通關（Bad Ending）"}
                </div>
                <div className="text-sm text-slate-700 mt-1 break-words">
                  存款：<b>{state.money}</b>｜任務完成數：<b>{missionCount}</b>/3
                </div>
              </div>

              <div className="mt-3 neo-soft p-3 bg-white">
                <div className="font-pixel text-[30px] break-words">結局稱號</div>
                <div className="mt-1 font-pixel text-[34px] break-words">{end.title}</div>
                <div className="text-xs text-slate-600 mt-1 break-words">
                  判定依據：最終存款 + 是否有穩定住所。
                </div>
              </div>

              <div className="mt-3 neo-soft p-3 bg-slate-50">
                <div className="font-pixel text-[30px] break-words">任務完成狀態</div>
                <div className="mt-2 flex flex-wrap gap-2">
                  {missionBadges.map(m => {
                    const ok = !!state.missions[m.key];
                    return (
                      <span key={m.key} className={"neo-soft px-3 py-2 text-xs " + (ok ? "bg-emerald-100" : "bg-slate-100")}>
                        {m.label}：{ok ? "完成" : "未完成"}
                      </span>
                    );
                  })}
                </div>
              </div>

              <div className="mt-3 neo-soft p-3 bg-white">
                <div className="font-pixel text-[30px] break-words">成就標籤</div>
                <div className="mt-2 flex flex-wrap gap-2">
                  {end.tagChips.length ? end.tagChips.slice(0,12).map((t, i) => (
                    <span key={i} className="neo-soft px-3 py-2 text-xs bg-indigo-100 break-words">{t}</span>
                  )) : (
                    <div className="text-sm text-slate-700 break-words">這次尚未解鎖標籤，下次多試試「資源連結」或「記帳」！</div>
                  )}
                </div>
              </div>

              <div className="mt-3 neo-soft p-3 bg-amber-50">
                <div className="font-pixel text-[30px] break-words">溫暖評語與建議</div>
                <div className="text-sm text-slate-700 mt-2 break-words whitespace-pre-wrap leading-relaxed">
                  {end.comment}
                </div>
              </div>
            </ModalWrapper>
          );
        }

        return null;
      })();

      // Auto route to home after onboarding
      useEffect(() => {
        if(state.hasOnboarded && route === "start" && !modal){
          setRoute("home");
        }
      }, [state.hasOnboarded]);

      // If game reaches beyond maxWeeks and no ending modal, prompt
      useEffect(() => {
        if(state.week > state.maxWeeks && !modal){
          setModal({ type:"ending" });
        }
      }, [state.week]);

      return (
        <div className="w-full h-full flex items-center justify-center p-6">
          <div className="phone-shell">
            <div className="notch"></div>
            <div className="side-btn b1"></div>
            <div className="side-btn b2"></div>
            <div className="side-btn b3"></div>
            <div className="side-btn r1"></div>

            <div ref={screenRef} className={"screen scanlines " + glitchClass}>
              <FloatingTextOverlay floats={floats} />

              <div className="absolute inset-0 flex flex-col">
                <StatBar state={state} livingCost={livingCost} />
                <div className="flex-1 content-scroll">
                  {main}
                </div>
              </div>

              {modalNode}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

</body>
</html>
